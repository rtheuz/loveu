<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>üíñ B & M üíñ ‚Äî Realtime Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Surpresa rom√¢ntica com multiplayer prot√≥tipo" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b0710;color:#fff;padding:18px}
    .panel{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-weight:700}
    input, button, select{padding:8px;border-radius:8px;border:0}
    #participants{display:flex;gap:8px;flex-wrap:wrap}
    .member{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px}
    #messages{height:120px;overflow:auto;background:rgba(0,0,0,0.12);padding:8px;border-radius:8px}
    #sharedControls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .small{font-size:.9rem;color:#ffeef6}
  </style>
</head>
<body>
  <h1>üíñ B & M üíñ ‚Äî Realtime Prototype</h1>

  <div class="panel" id="roomPanel">
    <label>Entrar / Criar sala</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="roomInput" placeholder="C√≥digo da sala (ex: sala1)" />
      <input id="nameInput" placeholder="Seu nome" />
      <button id="joinBtn">Entrar</button>
      <button id="leaveBtn" disabled> Sair </button>
    </div>
    <div style="margin-top:8px">
      <strong>Sala atual:</strong> <span id="activeRoom">nenhuma</span>
    </div>
    <div style="margin-top:8px">
      <strong>Participantes:</strong>
      <div id="participants"></div>
    </div>
  </div>

  <div class="panel" id="sharedPlayerPanel">
    <label>Shared Player (MP4 ou YouTube)</label>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="mediaUrl" placeholder="Cole URL MP4 ou YouTube (https://...)" style="flex:1"/>
      <select id="playerType">
        <option value="auto">Detectar</option>
        <option value="html5">HTML5 (MP4)</option>
        <option value="youtube">YouTube</option>
      </select>
      <button id="loadMedia">Carregar</button>
    </div>

    <div id="playerArea" style="margin-top:10px">
      <!-- HTML5 video -->
      <video id="sharedVideo" width="640" height="360" controls style="max-width:100%;display:none;background:#000"></video>
      <!-- YouTube placeholder -->
      <div id="ytPlayer" style="width:640px;height:360px;max-width:100%;display:none"></div>

      <div id="sharedControls" style="margin-top:6px">
        <button id="btnPlay">‚ñ∂Ô∏è Play</button>
        <button id="btnPause">‚è∏ Pause</button>
        <button id="btnSeek">‚§ì Seek 10s</button>
        <span class="small">Host corrige drifts automaticamente</span>
      </div>
    </div>
  </div>

  <div class="panel" id="chatPanel">
    <label>Chat da sala</label>
    <div id="messages"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="chatInput" placeholder="Mensagem..." style="flex:1" />
      <button id="sendChat">Enviar</button>
    </div>
  </div>

  <div class="panel" id="gamePanel">
    <label>Game (exemplo: enviar movimento simples)</label>
    <div style="display:flex;gap:8px">
      <button id="moveA">Move A</button>
      <button id="moveB">Move B</button>
    </div>
    <div style="margin-top:8px" id="gameLog"></div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // === Configs ===
    const SERVER_URL = 'http://localhost:3000'; // Ajuste se necess√°rio
    let socket = null;
    let currentRoom = null;
    let myName = null;
    let isHost = false;
    let isRemoteAction = false; // evita loop de retransmiss√µes
    let heartbeatInterval = null;
    let ytPlayer = null;
    let usingYouTube = false;

    // DOM
    const roomInput = document.getElementById('roomInput'), nameInput = document.getElementById('nameInput');
    const joinBtn = document.getElementById('joinBtn'), leaveBtn = document.getElementById('leaveBtn');
    const participantsEl = document.getElementById('participants'), activeRoomEl = document.getElementById('activeRoom');
    const mediaUrlInput = document.getElementById('mediaUrl'), playerTypeSelect = document.getElementById('playerType'), loadMediaBtn = document.getElementById('loadMedia');
    const sharedVideo = document.getElementById('sharedVideo'), ytContainer = document.getElementById('ytPlayer');
    const btnPlay = document.getElementById('btnPlay'), btnPause = document.getElementById('btnPause'), btnSeek = document.getElementById('btnSeek');
    const messagesEl = document.getElementById('messages'), chatInput = document.getElementById('chatInput'), sendChat = document.getElementById('sendChat');
    const moveA = document.getElementById('moveA'), moveB = document.getElementById('moveB'), gameLog = document.getElementById('gameLog');

    // connect on-demand when user joins
    function ensureSocket() {
      if (socket) return;
      socket = io(SERVER_URL, { transports: ['websocket', 'polling'] });
      socket.on('connect', () => {
        console.log('socket connected', socket.id);
      });

      socket.on('presence', ({ members, hostId }) => {
        // render participants
        participantsEl.innerHTML = '';
        members.forEach(m => {
          const div = document.createElement('div');
          div.className = 'member';
          div.textContent = (m.id === hostId ? 'üëë ' : '') + (m.name || 'Anon');
          participantsEl.appendChild(div);
        });
        // am I host?
        isHost = socket.id === hostId;
        console.log('presence', members, 'hostId=', hostId, 'isHost=', isHost);
        // start/stop heartbeat if host
        if (isHost) startHeartbeat();
        else stopHeartbeat();
      });

      socket.on('chat-message', ({ from, name, text, ts }) => {
        appendMessage(`[${new Date(ts).toLocaleTimeString()}] ${name}: ${text}`);
      });

      socket.on('video-control', ({ from, action, time, meta }) => {
        // remote action - apply locally but do not re-emit
        isRemoteAction = true;
        appendMessage(`(sync) video ${action} @ ${time ? time.toFixed(2) : ''}`);
        if (usingYouTube) {
          if (ytPlayer && typeof ytPlayer.getPlayerState === 'function') {
            if (typeof time === 'number') { ytPlayer.seekTo(time, true); }
            if (action === 'play') ytPlayer.playVideo();
            if (action === 'pause') ytPlayer.pauseVideo();
          }
        } else {
          if (typeof time === 'number') {
            try { sharedVideo.currentTime = time; } catch(e){}
          }
          if (action === 'play') sharedVideo.play().catch(()=>{});
          if (action === 'pause') sharedVideo.pause();
        }
        setTimeout(()=> isRemoteAction = false, 300);
      });

      socket.on('heartbeat', ({ from, time, type, now }) => {
        // host heartbeat forwarded to clients; clients should correct drift if too large
        if (socket.id === from) return; // ignore self
        if (type === 'video' && !isHost) {
          const localTime = usingYouTube ? (ytPlayer && ytPlayer.getCurrentTime ? ytPlayer.getCurrentTime() : 0) : sharedVideo.currentTime;
          const diff = Math.abs((localTime || 0) - (time || 0));
          if (diff > 0.6) {
            console.log('drift detected', diff, 'seeking to', time);
            if (usingYouTube) {
              ytPlayer && ytPlayer.seekTo && ytPlayer.seekTo(time, true);
            } else {
              try { sharedVideo.currentTime = time; } catch(e){}
            }
          }
        }
      });

      socket.on('game-move', ({ from, move }) => {
        appendGameLog(`move from ${from}: ${JSON.stringify(move)}`);
      });

      socket.on('peer-left', ({ id }) => {
        appendMessage(`peer left: ${id}`);
      });
    }

    function joinRoom() {
      const room = (roomInput.value || '').trim();
      const name = (nameInput.value || '').trim() || 'Anon';
      if (!room) { alert('Digite c√≥digo da sala'); return; }
      ensureSocket();
      currentRoom = room;
      myName = name;
      socket.emit('join', { room, name });
      activeRoomEl.textContent = room;
      joinBtn.disabled = true;
      leaveBtn.disabled = false;
    }

    function leaveRoom() {
      if (!socket || !currentRoom) return;
      socket.emit('leave', { room: currentRoom });
      activeRoomEl.textContent = 'nenhuma';
      participantsEl.innerHTML = '';
      currentRoom = null;
      joinBtn.disabled = false;
      leaveBtn.disabled = true;
      stopHeartbeat();
    }

    joinBtn.addEventListener('click', joinRoom);
    leaveBtn.addEventListener('click', leaveRoom);

    // === Shared media loading & control ===
    loadMediaBtn.addEventListener('click', () => {
      const url = (mediaUrlInput.value || '').trim();
      if (!url) { alert('Cole uma URL'); return; }
      const forced = playerTypeSelect.value;
      if (forced === 'youtube' || (forced === 'auto' && /youtube|youtu\.be/.test(url))) {
        loadYouTube(url);
      } else {
        loadHtml5(url);
      }
    });

    function loadHtml5(url) {
      usingYouTube = false;
      ytContainer.style.display = 'none';
      if (ytPlayer && window.YT) {
        try { ytPlayer.destroy && ytPlayer.destroy(); } catch(e) {}
      }
      sharedVideo.style.display = 'block';
      sharedVideo.src = url;
      sharedVideo.load();
      attachVideoEvents(sharedVideo);
    }

    // loads youtube iframe player via IFrame API
    function loadYouTube(url) {
      usingYouTube = true;
      sharedVideo.style.display = 'none';
      ytContainer.style.display = 'block';
      // parse video id (simple)
      const match = url.match(/(?:v=|\/embed\/|youtu\.be\/|\/shorts\/)([A-Za-z0-9_-]{6,})/);
      const id = match ? match[1] : null;
      if (!id) { alert('N√£o foi poss√≠vel parsear o v√≠deo YouTube'); return; }
      // load API if necessary
      if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
        const s = document.createElement('script');
        s.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(s);
        window.onYouTubeIframeAPIReady = () => createYTPlayer(id);
      } else {
        createYTPlayer(id);
      }
    }

    function createYTPlayer(id) {
      ytContainer.innerHTML = '';
      ytPlayer = new YT.Player('ytPlayer', {
        videoId: id,
        playerVars: { autoplay: 0, controls: 1, rel: 0, modestbranding: 1 },
        events: {
          onReady: (e) => {
            attachYouTubeEvents(e.target);
          },
          onStateChange: (e) => {
            // handled in attachYouTubeEvents wrapper
          }
        }
      });
    }

    // attach events for HTML5 video
    function attachVideoEvents(v) {
      v.onplay = () => {
        if (isRemoteAction) return;
        emitVideoControl('play', v.currentTime);
      };
      v.onpause = () => {
        if (isRemoteAction) return;
        emitVideoControl('pause', v.currentTime);
      };
      v.onseeked = () => {
        if (isRemoteAction) return;
        emitVideoControl('seek', v.currentTime);
      };
    }

    // attach listeners for YouTube player object
    function attachYouTubeEvents(player) {
      // wrap events to avoid emitting loop from remote-applied actions
      let lastState = -1;
      setInterval(() => {
        // poll for time changes sometimes useful (optional)
      }, 1000);

      player.addEventListener('onStateChange', (ev) => {
        // YT API provides numeric states
      });

      // we poll start/pause/seek; simple approach for prototype
      let lastPos = player.getCurrentTime();
      setInterval(() => {
        if (!player || !player.getPlayerState) return;
        const state = player.getPlayerState();
        const pos = player.getCurrentTime();
        // detect play
        if (!isRemoteAction && state === 1 && lastState !== 1) {
          emitVideoControl('play', pos);
        }
        // detect pause
        if (!isRemoteAction && state === 2 && lastState !== 2) {
          emitVideoControl('pause', pos);
        }
        // detect seek (significant jump)
        if (!isRemoteAction && Math.abs(pos - lastPos) > 0.8) {
          emitVideoControl('seek', pos);
        }
        lastState = state;
        lastPos = pos;
      }, 600);
    }

    // emit video control to room
    function emitVideoControl(action, time) {
      if (!socket || !currentRoom) return;
      socket.emit('video-control', { room: currentRoom, action, time });
    }

    // shared controls (local)
    btnPlay.addEventListener('click', () => {
      if (usingYouTube) { ytPlayer && ytPlayer.playVideo && ytPlayer.playVideo(); }
      else sharedVideo.play().catch(()=>{});
    });
    btnPause.addEventListener('click', () => {
      if (usingYouTube) { ytPlayer && ytPlayer.pauseVideo && ytPlayer.pauseVideo(); }
      else sharedVideo.pause();
    });
    btnSeek.addEventListener('click', () => {
      const add = 10;
      if (usingYouTube) {
        const t = (ytPlayer && ytPlayer.getCurrentTime && ytPlayer.getCurrentTime()) || 0;
        const nt = t + add;
        ytPlayer && ytPlayer.seekTo && ytPlayer.seekTo(nt, true);
        emitVideoControl('seek', nt);
      } else {
        const nt = (sharedVideo.currentTime || 0) + add;
        sharedVideo.currentTime = nt;
        emitVideoControl('seek', nt);
      }
    });

    // heartbeat (host)
    function startHeartbeat() {
      stopHeartbeat();
      heartbeatInterval = setInterval(() => {
        if (!currentRoom || !socket) return;
        const time = usingYouTube ? (ytPlayer && ytPlayer.getCurrentTime && ytPlayer.getCurrentTime()) || 0 : (sharedVideo.currentTime || 0);
        socket.emit('heartbeat', { room: currentRoom, time, type: 'video' });
      }, 5000);
    }
    function stopHeartbeat() {
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      heartbeatInterval = null;
    }

    // chat
    sendChat.addEventListener('click', () => {
      const txt = (chatInput.value || '').trim();
      if (!txt || !socket || !currentRoom) return;
      socket.emit('chat-message', { room: currentRoom, text: txt, name: myName });
      chatInput.value = '';
    });

    function appendMessage(txt) {
      const div = document.createElement('div'); div.textContent = txt;
      messagesEl.appendChild(div); messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // game moves
    moveA.addEventListener('click', () => {
      if (!socket || !currentRoom) return;
      socket.emit('game-move', { room: currentRoom, move: { type: 'A', by: myName }});
    });
    moveB.addEventListener('click', () => {
      if (!socket || !currentRoom) return;
      socket.emit('game-move', { room: currentRoom, move: { type: 'B', by: myName }});
    });

    socket && socket.on && socket.on('game-move', ({ from, move }) => {
      appendGameLog(`game move: ${JSON.stringify(move)}`);
    });

    function appendGameLog(txt) {
      const d = document.createElement('div'); d.textContent = txt;
      gameLog.appendChild(d); gameLog.scrollTop = gameLog.scrollHeight;
    }

    // cleanup before unload
    window.addEventListener('beforeunload', () => {
      if (socket && currentRoom) socket.emit('leave', { room: currentRoom });
      stopHeartbeat();
    });

    // Basic guidance message:
    appendMessage('Abra esta p√°gina em duas janelas, entre na mesma sala, carregue um MP4 ou YouTube e teste Play/Pause/Seek.');
  </script>
</body>
</html>