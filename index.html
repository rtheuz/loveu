<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>üíñ B & M üíñ</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="Uma surpresa rom√¢ntica com m√∫sicas, lembran√ßas e mensagens." />
<meta name="theme-color" content="#ff80ab" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@400;600&display=swap');
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:'Montserrat',sans-serif;
    color:#fff;
    background:#000 center/cover no-repeat fixed;
    transition:background 0.8s ease,color 0.6s ease;
    overflow:auto;
    min-height:100vh;
  }

  /* v√≠deo / youtube background ‚Äî agora em "cover" full-bleed */
  #bgMediaWrap{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    z-index:-4;
    overflow:hidden;
    pointer-events:none;
  }
  /* mp4 video element: full cover */
  #bgVideo{
    position:absolute;
    left:50%;
    top:50%;
    width:auto;
    height:100%;
    min-width:100%;
    min-height:100%;
    transform:translate(-50%,-50%);
    object-fit:cover;
    z-index:-4;
    opacity:0;
    transition:opacity .7s;
    pointer-events:none;
  }
  /* YouTube iframe: make it act like a background cover */
  #bgYouTube{
    position:absolute;
    left:50%;
    top:50%;
    width:177.77vh; /* ensures 16:9 covers vertically on narrow screens */
    height:100vh;
    transform:translate(-50%,-50%);
    border:0;
    z-index:-4;
    opacity:0;
    transition:opacity .7s, transform .7s;
    pointer-events:none;
  }
  /* additional subtle scale for very wide screens */
  @media(min-aspect-ratio:16/9){
    #bgYouTube{ width:100vw; height:56.25vw; } /* 16:9 based on width */
  }
  /* overlay above multimedia */
  #bgOverlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.18),rgba(0,0,0,.45));z-index:-3;pointer-events:none;transition:background .5s}

  body.loaded h1,body.loaded .container{opacity:1;transform:none}
  h1{font-family:'Pacifico',cursive;font-size:clamp(2rem,6vw,3rem);color:#ffb6c1;text-shadow:0 0 12px rgba(255,105,180,.9);
      margin:28px 0 12px;opacity:0;transform:scale(.9);transition:all .8s cubic-bezier(.2,.9,.3,1);text-align:center}

  .wrap{display:flex;align-items:flex-start;justify-content:center;padding:20px;gap:20px}
  .container{background:rgba(255,255,255,.10);backdrop-filter:blur(6px);padding:22px;border-radius:18px;
      box-shadow:0 6px 30px rgba(0,0,0,.45);max-width:960px;width:100%;opacity:0;transform:scale(.98);transition:all .6s}
  .top{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap}
  .photo{width:240px;min-width:160px;border-radius:12px;overflow:hidden;border:3px solid rgba(233,30,99,.9);flex-shrink:0}
  .photo img{display:block;width:100%;height:auto}
  .maincol{flex:1;min-width:260px}
  .message{font-weight:600;font-size:1.05rem;margin-bottom:10px;white-space:pre-wrap;text-shadow:0 0 8px rgba(0,0,0,.7)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .btn{padding:10px 18px;border-radius:24px;border:none;background:linear-gradient(135deg,#ff80ab,#ff4f8b);
      color:#fff;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:.2s}
  .btn:hover{transform:translateY(-3px);box-shadow:0 10px 24px rgba(255,80,130,.12)}
  .btn:active{transform:translateY(-1px) scale(.995)}
  .btn:focus{outline:3px solid rgba(255,200,220,.6);outline-offset:3px}

  .spotify-box{margin-top:12px;border-radius:12px;overflow:hidden;box-shadow:0 0 18px rgba(0,0,0,.35);background:rgba(0,0,0,.15)}
  iframe.spotify-frame{width:100%;height:152px;border:none;border-radius:12px}

  /* improved gallery layout for "Ver Mais" */
  #extraContent{margin-top:18px;display:block;height:0;overflow:hidden;transition:height .45s,opacity .35s;opacity:0}
  #extraContent.open{height:auto;opacity:1;padding-top:12px}
  .extra-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap:12px;
    align-items:start;
  }
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));
    border-radius:12px;overflow:hidden;border:2px solid rgba(255,128,171,.12);cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,.25);transition:transform .18s,box-shadow .18s;
  }
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 34px rgba(0,0,0,.35)}
  .card img{width:100%;height:140px;object-fit:cover;display:block}
  .card .meta{padding:8px 10px;font-size:.95rem;color:#ffeef6}

  /* modal lightbox for gallery */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:1100;padding:20px}
  .modal.open{display:flex}
  .modal .inner{max-width:92vw;max-height:90vh;border-radius:12px;overflow:hidden}
  .modal img{display:block;max-width:100%;max-height:90vh}

  /* mini-game drawer */
  #gamePanel{
    margin-top:16px;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));
    box-shadow:0 8px 20px rgba(0,0,0,.18);
  }
  .game-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
  .game-board{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-width:520px;margin:0 auto}
  .tile{background:linear-gradient(180deg,#ffeef7,#ffd6e8);height:84px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;cursor:pointer;user-select:none}
  .tile.flipped{background:linear-gradient(180deg,#fff,#ffe6f0);transform:rotateY(0)}
  .tile.matched{background:linear-gradient(180deg,#ffecf4,#ffdbe8);cursor:default;box-shadow:0 6px 18px rgba(0,0,0,.12)}
  .small{font-size:.9rem;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.12);color:#fff}

  /* cursor and hearts */
  .heart{position:fixed;bottom:-20px;width:var(--size);height:var(--size);background:var(--color);transform:rotate(-45deg);opacity:0;animation:floatHeart var(--duration) linear var(--delay) forwards;z[...]
  .heart::before,.heart::after{content:"";position:absolute;width:var(--size);height:var(--size);background:var(--color);border-radius:50%}
  .heart::before{top:calc(var(--size)*-0.5);left:0}.heart::after{left:calc(var(--size)*0.5);top:0}
  @keyframes floatHeart{0%{opacity:0}10%{opacity:var(--opacity)}100%{transform:translate(var(--windX),-110vh) rotate(-45deg);opacity:0}}

  .cursor{position:fixed;left:50%;top:50%;width:28px;height:28px;border-radius:50%;pointer-events:none;transform:translate(-50%,-50%);z-index:9999;mix-blend-mode:screen;transition:width .12s ease,heig[...]
  .cursor.big{width:52px;height:52px}
  .cursor .c-heart{width:12px;height:12px;transform:rotate(-45deg);background:#fff;border-radius:2px;position:relative}
  .cursor .c-heart::before,.cursor .c-heart::after{content:"";position:absolute;width:12px;height:12px;background:#fff;border-radius:50%}
  .cursor .c-heart::before{top:-6px;left:0}.cursor .c-heart::after{left:6px;top:0}

  body.dark{color:#ffd3e4}
  body.dark h1{color:#ffc1d6}
  body.dark .btn{background:linear-gradient(135deg,#aa3b6a,#ff6f9b)}
  body.dark .container{background:rgba(20,20,20,.65)}
  @media(max-width:900px){.top{flex-direction:column;align-items:center}.photo{width:200px}.container{padding:16px}}
  @media(max-width:560px){.game-board{grid-template-columns:repeat(2,1fr)} .tile{height:72px}}
  @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
</style>
</head>
<body>
  <!-- multimedia background wrapper -->
  <div id="bgMediaWrap" aria-hidden="true">
    <video id="bgVideo" playsinline muted loop></video>
    <iframe id="bgYouTube" allow="autoplay; fullscreen" sandbox="allow-same-origin allow-scripts allow-presentation"></iframe>
  </div>
  <div id="bgOverlay"></div>

  <div id="controlPanel" aria-label="Painel de controle" style="position:fixed;top:10px;left:10px;background:rgba(0,0,0,.42);backdrop-filter:blur(6px);padding:10px 14px;border-radius:10px;font-size:.8[...]
    <label style="font-weight:700;margin-bottom:6px;display:block">üåû Fundo Diurno (imagem, mp4 ou YouTube)</label>
    <input id="dayBgInput" placeholder="URL da imagem, .mp4 ou link YouTube (watch/shorts/youtu.be/playlist)" style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <label style="font-weight:700;margin-bottom:6px;display:block">üåô Fundo Noturno (imagem, mp4 ou YouTube)</label>
    <input id="nightBgInput" placeholder="URL da imagem, .mp4 ou link YouTube (watch/shorts/youtu.be/playlist)" style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <label style="font-weight:700;margin-bottom:6px;display:block">üéß Playlist Spotify</label>
    <input id="spotifyInput" placeholder="Cole o link da playlist (open.spotify.com/playlist/...)" style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <button id="loadPlaylistBtn" class="btn" style="width:100%;margin-bottom:6px">‚ñ∂Ô∏è Carregar Playlist</button>
    <small style="display:block;opacity:.85;color:#ffd6ea;margin-bottom:8px">Use o bot√£o "Tocar Playlist" no card para liberar reprodu√ß√£o em alguns navegadores.</small>
    <label style="font-weight:700;margin-bottom:6px;display:block">‚ú® Enfeites</label>
    <select id="decorationSelect" style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px">
      <option value="hearts">Cora√ß√µes</option>
      <option value="confetti">Confetti</option>
      <option value="none">Nenhum</option>
    </select>
    <button id="resetBtn" class="btn" style="background:linear-gradient(135deg,#ff7676,#ffb199);width:100%">Resetar</button>
  </div>

  <h1>üíñ TE AMOOO üíñ</h1>

  <div class="wrap">
    <div class="container" role="main">
      <div class="top">
        <figure class="photo"><img loading="lazy" src="https://i.imgur.com/oK3x5BH.jpeg" alt="Nossa foto juntos" /></figure>
        <div class="maincol">
          <div class="message" id="message" aria-live="polite"></div>
          <div class="controls">
            <button type="button" class="btn" id="playBtn">‚ñ∂Ô∏è Tocar Playlist</button>
            <button type="button" class="btn" id="moreBtn" aria-expanded="false">üíå Ver Mais</button>
            <button type="button" class="btn" id="darkModeBtn">üåô Modo Noturno</button>
            <button type="button" class="btn" id="openGameBtn">üéØ Jogar (Mini-Game)</button>
          </div>

          <div class="spotify-box" id="spotifyBox" style="margin-top:12px">
            <div id="spotifyPlaceholder" style="padding:18px;text-align:center;color:#ffeeff">Playlist n√£o carregada</div>
          </div>

          <!-- Mini-game area (collapsible) -->
          <div id="gamePanel" aria-hidden="true" style="display:none">
            <div class="game-header">
              <div style="font-weight:700">Cupid's Match ‚Äî Jogo da Mem√≥ria</div>
              <div class="small" id="gameInfo">Acertos: 0 | Tentativas: 0</div>
            </div>
            <div class="game-board" id="gameBoard" aria-live="polite"></div>
            <div style="text-align:center;margin-top:10px">
              <button id="restartGame" class="btn">üîÅ Reiniciar</button>
            </div>
          </div>

        </div>
      </div>

      <div id="extraContent" aria-hidden="true">
        <div class="extra-grid" id="extraGrid">
          <!-- cards inserted by JS for nicer layout -->
        </div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true"><div class="inner"><img id="modalImg" src="" alt="Imagem ampliada"></div></div>
  <div id="cursor" class="cursor" aria-hidden="true"><div class="c-heart"></div></div>

<script>
/* Sounds */
const clickSound = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_4b08a875f3.mp3?filename=click-124467.mp3");
const openSound  = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_643244bab6.mp3?filename=magic-124470.mp3");
const heartSound = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_97ab3022ac.mp3?filename=sparkle-124472.mp3");
clickSound.volume=openSound.volume=heartSound.volume=0.28;

/* Typing message */
const messageEl=document.getElementById('message');
const text="AMOOR DA MINHA VIDA, MINHA GATINHAA üí´";
let i=0;
function type(){ if(i<text.length){ messageEl.textContent+=text.charAt(i++); setTimeout(type,70) } }

/* Defaults */
const DEFAULT_SPOTIFY_URL = 'https://open.spotify.com/playlist/3AlzaL3fuUAtulQFklJy8v?si=_5BzUq0CQ_WDlL31eLaUcg';

/* YouTube helpers */
function parseYouTubeUrl(url){
  if(!url) return null;
  try{
    const u = new URL(url, location.href);
    const hostname = u.hostname.replace('www.','');
    if(hostname === 'youtu.be'){
      const vid = u.pathname.slice(1).split('/')[0];
      if(vid) return {type:'video', id:vid};
    }
    if(hostname.includes('youtube.com') || hostname.includes('youtube-nocookie.com')){
      if(u.pathname.startsWith('/playlist') && u.searchParams.get('list')) return {type:'playlist', id: u.searchParams.get('list')};
      if(u.searchParams.get('v')){
        const vid = u.searchParams.get('v'); const list = u.searchParams.get('list');
        if(list) return {type:'playlist', id: list};
        return {type:'video', id: vid};
      }
      const parts = u.pathname.split('/');
      const shortsIdx = parts.indexOf('shorts');
      if(shortsIdx >= 0 && parts[shortsIdx+1]) return {type:'video', id: parts[shortsIdx+1]};
      if(u.pathname.startsWith('/embed/')) return {type:'video', id: u.pathname.split('/embed/')[1].split('/')[0]};
    }
    if(u.searchParams.get('list')) return {type:'playlist', id: u.searchParams.get('list')};
  }catch(e){}
  return null;
}
function isVideoUrl(url){ return url && url.split('?')[0].toLowerCase().endsWith('.mp4'); }

/* Init on load */
window.addEventListener('load',()=>{
  setTimeout(()=>document.body.classList.add('loaded'),180);
  type();
  const savedDM = localStorage.getItem('darkMode');
  if(savedDM === '1'){ document.body.classList.add('dark'); document.getElementById('darkModeBtn').textContent='‚òÄÔ∏è Modo Claro' }
  const savedDec = localStorage.getItem('decoration') || 'hearts';
  document.getElementById('decorationSelect').value = savedDec;
  applyDecoration(savedDec);

  const day = localStorage.getItem('DAY_BG'); const night = localStorage.getItem('NIGHT_BG');
  if(day) document.getElementById('dayBgInput').value = day;
  if(night) document.getElementById('nightBgInput').value = night;

  const sp = localStorage.getItem('SPOTIFY_URL');
  if(sp){ document.getElementById('spotifyInput').value = sp; injectSpotifyIframe(sp, false); }
  else { document.getElementById('spotifyInput').value = DEFAULT_SPOTIFY_URL; localStorage.setItem('SPOTIFY_URL', DEFAULT_SPOTIFY_URL); injectSpotifyIframe(DEFAULT_SPOTIFY_URL, false); }

  const savedDay = localStorage.getItem('DAY_BG'); const savedNight = localStorage.getItem('NIGHT_BG');
  if(savedDay) DAY_BG = savedDay; if(savedNight) NIGHT_BG = savedNight;
  applyCurrentBg();

  // populate improved gallery
  populateGallery();

  // ensure youtube iframe sizing recalculates on resize
  window.addEventListener('resize', adjustYouTubeSizing);

  // Attach the "Ver Mais" button handler so it expands/collapses the gallery
  const moreBtn = document.getElementById('moreBtn');
  const extraContent = document.getElementById('extraContent');
  moreBtn.addEventListener('click', () => {
    const isOpen = extraContent.classList.contains('open');
    try{ clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }catch(e){}
    if(isOpen){
      // collapse: animate to height 0
      const startHeight = extraContent.scrollHeight;
      extraContent.style.height = startHeight + 'px';
      // force reflow to pick up starting height
      void extraContent.offsetHeight;
      extraContent.style.transition = 'height .36s, opacity .3s';
      extraContent.style.height = '0px';
      extraContent.classList.remove('open');
      extraContent.setAttribute('aria-hidden', 'true');
      moreBtn.setAttribute('aria-expanded', 'false');
      moreBtn.textContent = 'üíå Ver Mais';
      // after transition, remove inline height to allow future auto-sizing
      setTimeout(()=>{ extraContent.style.height=''; extraContent.style.transition=''; }, 360);
    } else {
      // expand: set height to scrollHeight so transition can animate
      extraContent.classList.add('open');
      extraContent.setAttribute('aria-hidden', 'false');
      moreBtn.setAttribute('aria-expanded', 'true');
      moreBtn.textContent = 'üîΩ Ver Menos';
      const targetHeight = extraContent.scrollHeight;
      extraContent.style.height = '0px';
      // force reflow
      void extraContent.offsetHeight;
      extraContent.style.transition = 'height .36s, opacity .3s';
      extraContent.style.height = targetHeight + 'px';
      // after transition, clear inline height so content can grow naturally
      setTimeout(()=>{ extraContent.style.height=''; extraContent.style.transition=''; }, 380);
    }
  });
});

/* Cursor smoothing */
const cursor=document.getElementById('cursor');
let targetX=innerWidth/2,targetY=innerHeight/2,currentX=targetX,currentY=targetY,ticking=false;
document.addEventListener('mousemove',e=>{ targetX=e.clientX; targetY=e.clientY; if(!ticking){ticking=true;requestAnimationFrame(updateCursor);} });
function updateCursor(){ const lerp=0.22; currentX+=(targetX-currentX)*lerp; currentY+=(targetY-currentY)*lerp; cursor.style.left=currentX+'px'; cursor.style.top=currentY+'px'; if(Math.abs(targetX-currentX)<0.5 && Math.abs(targetY-currentY)<0.5){ ticking=false; } else { requestAnimationFrame(updateCursor); } }
document.querySelectorAll('button,a,img').forEach(el=>{ el.addEventListener('mouseenter',()=>cursor.classList.add('big')); el.addEventListener('mouseleave',()=>cursor.classList.remove('big')); });

/* Hearts/Confetti */
const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
let heartsActive = 0, MAX_HEARTS = 20;
function createHeart(){ if(prefersReduced) return; if(heartsActive>=MAX_HEARTS) return; heartsActive++; const h=document.createElement('div'); h.className='heart'; const s=Math.random()*22+10,d=Math.random()*2+2; h.style.setProperty('--size', s+'px'); h.style.setProperty('--duration', d+'s'); h.style.setProperty('--delay', '0s'); h.style.setProperty('--opacity', (0.6+Math.random()*0.4).toString()); h.style.setProperty('--color', '#ff6fa3'); h.style.setProperty('--windX', (Math.random()*160-80)+'px'); document.body.appendChild(h); h.addEventListener('animationend', ()=>{ h.remove(); heartsActive--; }); }
function createConfettiBurst(){ if(prefersReduced) return; const burst = Math.floor(8 + Math.random()*14); for(let i=0;i<burst;i++){ const c=document.createElement('div'); c.className='confetti'; c.style.position='fixed'; c.style.width='8px'; c.style.height='12px'; c.style.left=(Math.random()*100)+'vw'; c.style.bottom='0px'; c.style.background=['#ff6f9b','#ffd166','#61dafb','#7afc9c'][Math.floor(Math.random()*4)]; c.style.transform='rotate('+ (Math.random()*360)+'deg)'; c.style.opacity='0.95'; const dur=2+Math.random()*2; c.style.transition='transform '+dur+'s linear, bottom '+dur+'s linear, opacity '+dur+'s linear'; document.body.appendChild(c); setTimeout(()=>{ c.style.bottom = (90+Math.random()*40)+'vh'; c.style.transform = 'rotate('+(Math.random()*720)+'deg) translateX('+(Math.random()*200-100)+'px)'; c.style.opacity='0'; },20); setTimeout(()=>c.remove(), (dur+0.3)*1000); }}

/* Decorations control */
let decInterval = null;
function applyDecoration(name){ clearInterval(decInterval); document.querySelectorAll('.heart,.confetti').forEach(n=>n.remove()); if(name==='hearts') decInterval=setInterval(()=>createHeart(),520); else if(name==='confetti') decInterval=setInterval(()=>createConfettiBurst(),1200); localStorage.setItem('decoration', name); }
document.getElementById('decorationSelect').addEventListener('change', e=>applyDecoration(e.target.value));

/* Modal for gallery */
const modal=document.getElementById('modal'), modalImg=document.getElementById('modalImg');
function openModal(src, alt){ modalImg.src=src; modalImg.alt=alt||'Imagem'; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; try{openSound.currentTime=0;openSound.play().catch(()=>{});}catch(e){} }
function closeModal(){ modal.classList.remove('open'); modalImg.src=''; modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); }); document.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeModal(); });

/* Gallery data and population */
const galleryItems = [
  {src:'https://i.imgur.com/kUJiuhm.jpeg', alt:'Passeio inesquec√≠vel'},
  {src:'https://i.imgur.com/PPq9KND.jpeg', alt:'Abra√ßo apertado'},
  {src:'https://i.imgur.com/3y3g1K1.jpeg', alt:'No p√¥r do sol'},
  {src:'https://i.imgur.com/2K8Y7qc.jpeg', alt:'Sorriso lindo'},
  {src:'https://i.imgur.com/Zb6Jf2d.jpeg', alt:'Noite estrelada'},
  {src:'https://i.imgur.com/7Qd6FhG.jpeg', alt:'M√£o na m√£o'}
];

function populateGallery(){
  const grid = document.getElementById('extraGrid');
  grid.innerHTML='';
  galleryItems.forEach((it, idx)=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<img src="${it.src}" alt="${it.alt}" loading="lazy"><div class="meta">${it.alt}</div>`;
    card.addEventListener('click', ()=> openModal(it.src,it.alt));
    grid.appendChild(card);
  });
}

/* Spotify */
const spotifyInput = document.getElementById('spotifyInput');
const loadPlaylistBtn = document.getElementById('loadPlaylistBtn');
const spotifyBox = document.getElementById('spotifyBox');

function normalizeSpotifyUrl(raw){
  if(!raw) return '';
  try{
    const u = new URL(raw.trim());
    if(u.hostname.includes('spotify.com')){
      const parts = u.pathname.split('/');
      const idx = parts.indexOf('playlist');
      if(idx>=0 && parts[idx+1]) return 'https://open.spotify.com/embed/playlist/' + parts[idx+1] + '?utm_source=generator';
      if(u.pathname.startsWith('/embed/playlist/')) return u.href;
    }
    if(/^[0-9A-Za-z]{20,}$/.test(raw.trim())) return 'https://open.spotify.com/embed/playlist/' + raw.trim() + '?utm_source=generator';
  }catch(e){}
  return '';
}
function injectSpotifyIframe(raw, focus=true){
  const url = normalizeSpotifyUrl(raw);
  spotifyBox.innerHTML='';
  if(!url){ spotifyBox.innerHTML = '<div id="spotifyPlaceholder" style="padding:18px;text-align:center;color:#ffeeff">URL inv√°lida. Cole um link de playlist do Spotify.</div>'; return; }
  const ifr = document.createElement('iframe'); ifr.className='spotify-frame'; ifr.title='Playlist do Spotify'; ifr.loading='lazy'; ifr.allow='autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture'; ifr.src = url;
  spotifyBox.appendChild(ifr);
  if(focus){ try{ ifr.focus && ifr.focus(); }catch(e){} }
  localStorage.setItem('SPOTIFY_URL', raw);
}
loadPlaylistBtn.addEventListener('click', ()=>{ const raw=spotifyInput.value.trim(); injectSpotifyIframe(raw,true); });

const playBtn=document.getElementById('playBtn');
playBtn.onclick=()=>{ try{clickSound.currentTime=0;clickSound.play().catch(()=>{});}catch(e){} const iframe = spotifyBox.querySelector('iframe'); if(iframe){ iframe.focus && iframe.focus(); playBtn.textContent='‚è∏Ô∏è Pausar (use o player)'; } else { injectSpotifyIframe(spotifyInput.value.trim(), true); } }

/* Dark mode & background handling */
const darkBtn=document.getElementById('darkModeBtn');
let dark=false;
let DAY_BG = localStorage.getItem('DAY_BG') || 'https://i.imgur.com/0JMLcYr.jpeg';
let NIGHT_BG = localStorage.getItem('NIGHT_BG') || 'https://i.imgur.com/rJePXtj.jpeg';
const dayInput=document.getElementById('dayBgInput'), nightInput=document.getElementById('nightBgInput');
if(localStorage.getItem('darkMode') === '1'){ dark=true; document.body.classList.add('dark'); darkBtn.textContent='‚òÄÔ∏è Modo Claro' }
dayInput.value = DAY_BG; nightInput.value = NIGHT_BG;
const bgVideo = document.getElementById('bgVideo'), bgYouTube = document.getElementById('bgYouTube');

function setBackground(url, opts={forceImage:false}){
  if(!url) return;
  const yt = parseYouTubeUrl(url);
  if(yt && !opts.forceImage){
    if(yt.type === 'video'){
      const vid = yt.id;
      // embed: autoplay muted, hidden controls, loop via playlist param
      const embed = `https://www.youtube.com/embed/${vid}?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&loop=1&playlist=${vid}&enablejsapi=1`;
      bgYouTube.src = embed; bgYouTube.style.opacity='1';
      // ensure cover sizing
      adjustYouTubeSizing();
      bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity='0';
      document.body.style.backgroundImage='';
      return;
    } else if(yt.type === 'playlist'){
      const listId = yt.id;
      const embed = `https://www.youtube.com/embed?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&loop=1&enablejsapi=1&listType=playlist&list=${listId}`;
      bgYouTube.src = embed; bgYouTube.style.opacity='1';
      adjustYouTubeSizing();
      bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity='0';
      document.body.style.backgroundImage='';
      return;
    }
  }
  if(isVideoUrl(url) && !opts.forceImage){
    bgYouTube.removeAttribute('src'); bgYouTube.style.opacity='0';
    bgVideo.src = url; bgVideo.load(); bgVideo.play().catch(()=>{}); bgVideo.style.opacity='1';
    document.body.style.backgroundImage=''; return;
  }
  bgYouTube.removeAttribute('src'); bgYouTube.style.opacity='0'; bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity='0';
  document.body.style.backgroundImage = `url('${url}')`; document.body.style.backgroundSize='cover'; document.body.style.backgroundPosition='center';
}

function applyCurrentBg(){ if(dark && NIGHT_BG) setBackground(NIGHT_BG); else if(!dark && DAY_BG) setBackground(DAY_BG); }
applyCurrentBg();
darkBtn.onclick=()=>{ dark=!dark; try{clickSound.currentTime=0;clickSound.play().catch(()=>{});}catch(e){} document.body.classList.toggle('dark',dark); darkBtn.textContent = dark ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Noturno'; localStorage.setItem('darkMode', dark ? '1' : '0'); applyCurrentBg(); }
function safeUrl(s){ try{ const u=new URL(s,location.href); return u.href; }catch(e){ return s.trim(); } }
dayInput.onchange = ()=>{ const v=safeUrl(dayInput.value); if(v){ DAY_BG=v; localStorage.setItem('DAY_BG', DAY_BG); if(!dark) setBackground(DAY_BG); } }
nightInput.onchange = ()=>{ const v=safeUrl(nightInput.value); if(v){ NIGHT_BG=v; localStorage.setItem('NIGHT_BG', NIGHT_BG); if(dark) setBackground(NIGHT_BG); } }

/* Adjust YouTube iframe sizing so it behaves like background: cover the viewport.
   Because iframes don't support object-fit, we size larger than viewport and center it.
*/
function adjustYouTubeSizing(){
  if(!bgYouTube) return;
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const aspect = 16/9;
  // Determine whether to base sizing on width or height to fully cover
  if (vw / vh < aspect) {
    // viewport is taller relative to width ‚Äî base on height
    bgYouTube.style.height = `${vh}px`;
    bgYouTube.style.width = `${vh * aspect}px`;
  } else {
    // base on width
    bgYouTube.style.width = `${vw}px`;
    bgYouTube.style.height = `${vw / aspect}px`;
  }
  // center transform
  bgYouTube.style.left = '50%';
  bgYouTube.style.top = '50%';
  bgYouTube.style.transform = 'translate(-50%,-50%)';
}

/* user interaction to start sounds/enchant */
let userInteracted=false;
function onFirstInteraction(){ userInteracted=true; try{openSound.currentTime=0;openSound.play().catch(()=>{});}catch(e){} document.removeEventListener('pointerdown',onFirstInteraction); }
document.addEventListener('pointerdown', onFirstInteraction, {once:true});

/* reset */
document.getElementById('resetBtn').addEventListener('click', ()=>{ localStorage.removeItem('DAY_BG'); localStorage.removeItem('NIGHT_BG'); localStorage.removeItem('SPOTIFY_URL'); localStorage.removeI[...]

/* accessibility helpers */
modal.setAttribute('tabindex','-1');
document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ if(bgVideo && !bgVideo.paused) bgVideo.pause(); } else { if(bgVideo && bgVideo.src && !bgVideo.paused && !userInteracted) bgVid[...]
window.addEventListener('resize', adjustYouTubeSizing);

/* -------------------------------
   Mini-game: Cupid's Match (memory)
   - 8 tiles (4 pairs). Simple game: flip tiles to find pairs.
   -------------------------------*/
const openGameBtn = document.getElementById('openGameBtn');
const gamePanel = document.getElementById('gamePanel');
const gameBoard = document.getElementById('gameBoard');
const restartGame = document.getElementById('restartGame');
const gameInfo = document.getElementById('gameInfo');

let tiles = [];
let firstPick = null, secondPick = null;
let lockBoard = false;
let matches = 0, attempts = 0;

const symbols = ['üíñ','üåπ','üåü','üç´']; // 4 symbols => 8 tiles

function shuffle(array){
  for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; }
  return array;
}

function initGame(){
  // reset
  tiles = [];
  firstPick = secondPick = null;
  lockBoard = false;
  matches = 0; attempts = 0;
  gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`;
  // create paired array and shuffle
  const paired = shuffle([...symbols, ...symbols]);
  gameBoard.innerHTML = '';
  paired.forEach((sym, idx)=>{
    const t = document.createElement('div');
    t.className = 'tile';
    t.dataset.symbol = sym;
    t.dataset.index = idx;
    t.textContent = ''; // face-down
    t.addEventListener('click', onTileClick);
    gameBoard.appendChild(t);
  });
}

function onTileClick(e){
  if(lockBoard) return;
  const t = e.currentTarget;
  if(t.classList.contains('flipped') || t.classList.contains('matched')) return;
  t.classList.add('flipped');
  t.textContent = t.dataset.symbol;
  if(!firstPick){ firstPick = t; return; }
  secondPick = t;
  lockBoard = true;
  attempts++;
  if(firstPick.dataset.symbol === secondPick.dataset.symbol){
    // match
    firstPick.classList.add('matched'); secondPick.classList.add('matched');
    matches++;
    resetPicks();
    lockBoard=false;
    gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`;
    if(matches === symbols.length){
      setTimeout(()=> alert(`Voc√™ ganhou! Acertos: ${matches} | Tentativas: ${attempts} ‚Äî Te amo ‚ù§`), 300);
    }
  } else {
    gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`;
    setTimeout(()=>{ firstPick.classList.remove('flipped'); secondPick.classList.remove('flipped'); firstPick.textContent=''; secondPick.textContent=''; resetPicks(); lockBoard=false; }, 700);
  }
}

function resetPicks(){ firstPick = null; secondPick = null; }

openGameBtn.addEventListener('click', ()=>{
  const visible = gamePanel.style.display !== 'none';
  gamePanel.style.display = visible ? 'none' : 'block';
  gamePanel.setAttribute('aria-hidden', visible ? 'true' : 'false');
  if(!visible) { initGame(); }
});

restartGame.addEventListener('click', ()=> initGame());

/* end mini-game */

</script>
</body>
</html>
