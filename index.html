<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <title>💖 B & M 💖</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Uma surpresa romântica com músicas, lembranças e mensagens." />
  <meta name="theme-color" content="#ff80ab" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@400;600&display=swap');

    :root {
      --accent-1: #ff80ab;
      --accent-2: #ff4f8b;
      --glass: rgba(255,255,255,0.10);
      --glass-dark: rgba(20,20,20,0.65);
      --control-bg: rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Montserrat', sans-serif;
      color: #fff;
      background: #000 center/cover no-repeat fixed;
      transition: background 0.8s ease, color 0.6s ease;
      min-height: 100vh;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Background media */
    #bgMediaWrap { position: fixed; inset: 0; width:100%; height:100%; z-index:-4; overflow:hidden; pointer-events:none; }
    #bgVideo { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); object-fit:cover; min-width:100%; min-height:100%; z-index:-4; opacity:0; transition:opacity .7s; pointer-events:none; }
    #bgYouTube { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:177.77vh; height:100vh; border:0; z-index:-4; opacity:0; transition:opacity .7s, transform .7s; pointer-events:none; }
    @media(min-aspect-ratio:16/9){ #bgYouTube{ width:100vw; height:56.25vw; } }
    #bgOverlay { position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.45)); z-index:-3; pointer-events:none; transition:background .5s; }

    body.loaded h1, body.loaded .container { opacity:1; transform:none; }

    h1 {
      font-family:'Pacifico', cursive;
      font-size: clamp(2rem, 6vw, 3rem);
      color: #ffb6c1;
      text-shadow: 0 0 12px rgba(255,105,180,.9);
      margin: 28px 0 12px;
      opacity: 0;
      transform: scale(.9);
      transition: all .8s cubic-bezier(.2,.9,.3,1);
      text-align:center;
    }

    .wrap { display:flex; align-items:flex-start; justify-content:center; padding:20px; gap:20px; }
    .container {
      background: var(--glass);
      backdrop-filter: blur(6px);
      padding:22px;
      border-radius:18px;
      box-shadow: 0 6px 30px rgba(0,0,0,.45);
      max-width:960px; width:100%;
      opacity:0; transform:scale(.98); transition: all .6s;
    }

    .top { display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap; }
    .photo { width:240px; min-width:160px; border-radius:12px; overflow:hidden; border:3px solid rgba(233,30,99,.9); flex-shrink:0; }
    .photo img { display:block; width:100%; height:auto; cursor:pointer; }

    .maincol { flex:1; min-width:260px; }
    .message { font-weight:600; font-size:1.05rem; margin-bottom:10px; white-space:pre-wrap; text-shadow:0 0 8px rgba(0,0,0,.7); }

    .controls { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .btn {
      padding:10px 18px; border-radius:24px; border:none; background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
      color:#fff; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px; transition: transform .18s, box-shadow .18s;
      position:relative; overflow:hidden;
    }
    .btn:hover { transform:translateY(-3px); box-shadow:0 10px 24px rgba(255,80,130,.12); }
    .btn:active { transform:translateY(-1px) scale(.995); }
    .btn:focus { outline: 3px solid rgba(255,200,220,.6); outline-offset:3px; }

    .spotify-box { margin-top:12px; border-radius:12px; overflow:hidden; box-shadow:0 0 18px rgba(0,0,0,.35); background: rgba(0,0,0,.15); }
    iframe.spotify-frame { width:100%; height:152px; border:none; border-radius:12px; }

    #extraContent { margin-top:18px; display:block; height:0; overflow:hidden; transition: height .45s, opacity .35s; opacity:0; }
    #extraContent.open { height:auto; opacity:1; padding-top:12px; }

    .extra-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:12px; align-items:start; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:12px; overflow:hidden; border:2px solid rgba(255,128,171,.12); cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,.25); transition: transform .18s, box-shadow .18s; position:relative; }
    .card:hover { transform:translateY(-6px); box-shadow:0 18px 34px rgba(0,0,0,.35); }
    .card img { width:100%; height:140px; object-fit:cover; display:block; }
    .card .meta { padding:8px 10px; font-size:.95rem; color:#ffeef6; }

    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.85); z-index:1100; padding:20px; }
    .modal.open { display:flex; }
    .modal .inner { max-width:92vw; max-height:90vh; border-radius:12px; overflow:hidden; }
    .modal img { display:block; max-width:100%; max-height:90vh; }

    #gamePanel { margin-top:16px; padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); box-shadow:0 8px 20px rgba(0,0,0,.18); }
    .game-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .game-board { display:grid; grid-template-columns: repeat(4,1fr); gap:10px; max-width:520px; margin:0 auto; }
    .tile { background: linear-gradient(180deg,#ffeef7,#ffd6e8); height:84px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.6rem; cursor:pointer; user-select:none; transition: transform .18s; }
    .tile.flipped { background: linear-gradient(180deg,#fff,#ffe6f0); transform:rotateY(0); }
    .tile.matched { background: linear-gradient(180deg,#ffecf4,#ffdbe8); cursor:default; box-shadow:0 6px 18px rgba(0,0,0,.12); }

    .small { font-size:.9rem; padding:6px 10px; border-radius:10px; background:rgba(0,0,0,.12); color:#fff; }

    /* decorative heart element used in page-wide decorations and bursts */
    .heart {
      width: var(--size, 18px); height: var(--size,18px); position:fixed; transform:rotate(-45deg); opacity:0; z-index:9998; pointer-events:none; border-radius:2px;
      background: var(--color, #ff7aa9); will-change: transform, opacity; animation: floatHeart var(--duration, 6s) linear var(--delay, 0s) forwards;
    }
    .heart::before, .heart::after { content:""; position:absolute; width:var(--size,18px); height:var(--size,18px); background:var(--color,#ff7aa9); border-radius:50%; }
    .heart::before { top: calc(var(--size)*-0.5); left:0; } .heart::after { left: calc(var(--size)*0.5); top:0; }
    @keyframes floatHeart {
      0% { opacity:0; transform: translateX(0) translateY(0) rotate(-45deg) scale(.85); }
      10% { opacity: var(--opacity, 0.9); }
      40% { transform: translateX(calc(var(--windX,0px) * 0.3)) translateY(-38vh) rotate(-45deg) scale(1.05); }
      100% { transform: translateX(var(--windX,0px)) translateY(-120vh) rotate(-45deg) scale(.9); opacity:0; }
    }

    /* simple confetti rectangle */
    .confetti { position:fixed; width:8px; height:12px; z-index:9998; pointer-events:none; border-radius:2px; }

    /* custom cursor - kept subtle and performant */
    .cursor { position:fixed; left:0; top:0; width:28px; height:28px; border-radius:50%; pointer-events:none; z-index:9999; mix-blend-mode: screen; transform: translate(-50%,-50%); transition: transform .06s linear, width .12s ease, height .12s ease; display:flex; align-items:center; justify-content:center; }
    .cursor .core { width:12px; height:12px; transform:rotate(-45deg); background:#fff; border-radius:2px; position:relative; }
    .cursor .core::before, .cursor .core::after { content:""; position:absolute; width:12px; height:12px; background:#fff; border-radius:50%; }
    .cursor .core::before { top:-6px; left:0 } .cursor .core::after { left:6px; top:0; }
    .cursor.big { width:52px; height:52px; }
    .cursor .trail { position:absolute; width:6px; height:6px; border-radius:50%; background:rgba(255,255,255,0.85); opacity:.12; transform:translate(-50%,-50%) scale(.8); transition: transform .18s linear, opacity .4s linear; pointer-events:none; }

    /* control panel */
    #controlPanel { position:fixed; top:12px; left:12px; background:var(--control-bg); backdrop-filter: blur(6px); padding:8px; border-radius:10px; font-size:.82rem; color:#fff; z-index:9999; width:260px; max-width:calc(100% - 28px); box-shadow:0 8px 30px rgba(0,0,0,.4); transition: transform .28s ease, opacity .2s; }
    #controlPanel.collapsed { transform: translate(-20%,0); opacity:.12; width:56px; padding:6px; overflow:visible; border-radius:12px; z-index:10001; pointer-events:auto; }
    #controlHeader { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    #panelToggle { width:36px; height:36px; border-radius:8px; border:none; background: linear-gradient(135deg,var(--accent-1),var(--accent-2)); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; color:#fff; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,.22); position:relative; z-index:10002; }
    #controlTitle { font-weight:700; font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #controlPanel.collapsed input, #controlPanel.collapsed select, #controlPanel.collapsed button:not(#panelToggle), #controlPanel.collapsed small, #controlPanel.collapsed label { display:none; }

    /* ripple helper */
    .ripple { position:absolute; border-radius:50%; transform:scale(0); background:rgba(255,255,255,0.25); pointer-events:none; will-change: transform, opacity; }

    @media(max-width:520px){
      #controlPanel { left:50%; transform:translateX(-50%); width:calc(100% - 24px); bottom:12px; top:auto; padding:10px; border-radius:12px; }
      #controlPanel.collapsed { transform: translateX(-50%) translateY(86%); opacity:.12; width:64px; bottom:12px; left:calc(100% - 36px); top:auto; padding:6px; border-radius:12px; }
      #panelToggle { width:44px; height:44px; border-radius:10px; }
    }

    @media(max-width:900px){
      .top { flex-direction:column; align-items:center; }
      .photo { width:200px; }
      .container { padding:16px; }
    }

    @media(max-width:560px){
      .game-board { grid-template-columns: repeat(2,1fr); }
      .tile { height:72px; }
    }

    @media (prefers-reduced-motion: reduce){
      * { animation:none !important; transition:none !important; }
    }
  </style>
</head>

<body>
  <div id="bgMediaWrap" aria-hidden="true">
    <video id="bgVideo" playsinline muted loop></video>
    <iframe id="bgYouTube" allow="autoplay; fullscreen" sandbox="allow-same-origin allow-scripts allow-presentation"></iframe>
  </div>
  <div id="bgOverlay"></div>

  <div id="controlPanel" aria-label="Painel de controle">
    <div id="controlHeader">
      <button id="panelToggle" title="Mostrar / Esconder painel">☰</button>
      <div id="controlTitle">Painel de controle</div>
    </div>

    <label style="font-weight:700;margin-bottom:6px;display:block">🌞 Fundo Diurno (imagem, mp4 ou YouTube)</label>
    <input id="dayBgInput" placeholder="URL da imagem, .mp4 ou link YouTube (watch/shorts/youtu.be/playlist)" style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <label style="font-weight:700;margin-bottom:6px;display:block">🌙 Fundo Noturno (imagem, mp4 ou YouTube)</label>
    <input id="nightBgInput" placeholder="URL da imagem, .mp4 ou link YouTube (watch/shorts/youtu.be/playlist)" style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <label style="font-weight:700;margin-bottom:6px;display:block">🎧 Playlist Spotify</label>
    <input id="spotifyInput" placeholder="Cole o link da playlist (open.spotify.com/playlist/...)" style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <button id="loadPlaylistBtn" class="btn" style="width:100%;margin-bottom:6px">▶️ Carregar Playlist</button>
    <small style="display:block;opacity:.85;color:#ffd6ea;margin-bottom:8px">Use o botão "Tocar Playlist" no card para liberar reprodução em alguns navegadores.</small>
    <label style="font-weight:700;margin-bottom:6px;display:block">✨ Enfeites</label>
    <select id="decorationSelect" style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px">
      <option value="hearts">Corações</option>
      <option value="confetti">Confetti</option>
      <option value="none">Nenhum</option>
    </select>
    <button id="resetBtn" class="btn" style="background:linear-gradient(135deg,#ff7676,#ffb199);width:100%">Resetar</button>
  </div>

  <h1>💖 TE AMOOO 💖</h1>

  <div class="wrap">
    <div class="container" role="main">
      <div class="top">
        <figure class="photo"><img id="mainPhoto" loading="lazy" src="https://i.imgur.com/oK3x5BH.jpeg" alt="Nossa foto juntos" /></figure>
        <div class="maincol">
          <div class="message" id="message" aria-live="polite"></div>
          <div class="controls">
            <button type="button" class="btn" id="playBtn">▶️ Tocar Playlist</button>
            <button type="button" class="btn" id="moreBtn" aria-expanded="false">💌 Ver Mais</button>
            <button type="button" class="btn" id="darkModeBtn">🌙 Modo Noturno</button>
            <button type="button" class="btn" id="openGameBtn">🎯 Jogar (Mini-Game)</button>
          </div>

          <div class="spotify-box" id="spotifyBox" style="margin-top:12px">
            <div id="spotifyPlaceholder" style="padding:18px;text-align:center;color:#ffeeff">Playlist não carregada</div>
          </div>

          <div id="gamePanel" aria-hidden="true" style="display:none">
            <div class="game-header">
              <div style="font-weight:700">Cupid's Match — Jogo da Memória</div>
              <div class="small" id="gameInfo">Acertos: 0 | Tentativas: 0</div>
            </div>
            <div class="game-board" id="gameBoard" aria-live="polite"></div>
            <div style="text-align:center;margin-top:10px"><button id="restartGame" class="btn">🔁 Reiniciar</button></div>
          </div>
        </div>
      </div>

      <div id="extraContent" aria-hidden="true">
        <div class="extra-grid" id="extraGrid"></div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="inner"><img id="modalImg" src="" alt="Imagem ampliada"></div>
  </div>

  <div id="cursor" class="cursor" aria-hidden="true"><div class="trail"></div><div class="core"></div></div>

  <script>
    /* === Notes about this rewrite
       - I preserved all original features: background (image/video/YouTube), Spotify iframe injection, gallery modal, mini-game, control panel, decorations.
       - Fixed freeze-prone areas:
         * Throttled and capped decoration bursts.
         * Removed global MutationObserver; use event delegation and explicit bindings.
         * Safer ripple/burst creation with try/catch and timeouts.
         * Reduced per-frame work in cursor (lerp only when pointer moves).
       - Respects prefers-reduced-motion.
    */

    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    /* Typing message */
    const messageEl = document.getElementById('message');
    const text = "AMOOR DA MINHA VIDA, MINHA GATINHAA 💫";
    (function typewriter() { let i = 0; function step(){ if(i < text.length){ messageEl.textContent += text.charAt(i++); setTimeout(step, 70); } } step(); })();

    /* Defaults */
    const DEFAULT_SPOTIFY_URL = 'https://open.spotify.com/playlist/3AlzaL3fuUAtulQFklJy8v?si=_5BzUq0CQ_WDlL31eLaUcg';

    /* ---------------------------
       YouTube helpers
    ----------------------------*/
    function parseYouTubeUrl(url) {
      if (!url) return null;
      try {
        const u = new URL(url, location.href);
        const hostname = u.hostname.replace('www.', '');
        if (hostname === 'youtu.be') {
          const vid = u.pathname.slice(1).split('/')[0];
          if (vid) return { type: 'video', id: vid };
        }
        if (hostname.includes('youtube.com') || hostname.includes('youtube-nocookie.com')) {
          if (u.pathname.startsWith('/playlist') && u.searchParams.get('list')) return { type: 'playlist', id: u.searchParams.get('list') };
          if (u.searchParams.get('v')) {
            const vid = u.searchParams.get('v'); const list = u.searchParams.get('list');
            if (list) return { type: 'playlist', id: list };
            return { type: 'video', id: vid };
          }
          const parts = u.pathname.split('/');
          const shortsIdx = parts.indexOf('shorts');
          if (shortsIdx >= 0 && parts[shortsIdx + 1]) return { type: 'video', id: parts[shortsIdx + 1] };
          if (u.pathname.startsWith('/embed/')) return { type: 'video', id: u.pathname.split('/embed/')[1].split('/')[0] };
        }
        if (u.searchParams.get('list')) return { type: 'playlist', id: u.searchParams.get('list') };
      } catch (e) { /* ignore */ }
      return null;
    }
    function isVideoUrl(url) { return url && url.split('?')[0].toLowerCase().endsWith('.mp4'); }

    /* ---------------------------
       INIT: restore state, bind events
    ----------------------------*/
    window.addEventListener('load', () => {
      setTimeout(() => document.body.classList.add('loaded'), 180);

      // decoration
      const savedDec = localStorage.getItem('decoration') || 'hearts';
      document.getElementById('decorationSelect').value = savedDec;
      applyDecoration(savedDec);

      // spotify
      const sp = localStorage.getItem('SPOTIFY_URL');
      if (sp) { document.getElementById('spotifyInput').value = sp; injectSpotifyIframe(sp, false); }
      else { document.getElementById('spotifyInput').value = DEFAULT_SPOTIFY_URL; localStorage.setItem('SPOTIFY_URL', DEFAULT_SPOTIFY_URL); injectSpotifyIframe(DEFAULT_SPOTIFY_URL, false); }

      // backgrounds
      const day = localStorage.getItem('DAY_BG'); const night = localStorage.getItem('NIGHT_BG');
      if (day) document.getElementById('dayBgInput').value = day;
      if (night) document.getElementById('nightBgInput').value = night;

      // gallery
      populateGallery();

      // restore panel collapsed
      const cp = document.getElementById('controlPanel');
      if (localStorage.getItem('CONTROL_PANEL_COLLAPSED') === '1') cp.classList.add('collapsed');

      // bind hover/click effects after initial DOM is ready
      addCursorHoverListeners();
      bindInteractiveEffects();
    });

    /* ---------------------------
       Cursor (lightweight)
    ----------------------------*/
    const cursor = document.getElementById('cursor');
    const cursorCore = cursor.querySelector('.core');
    const cursorTrail = cursor.querySelector('.trail');
    let targetX = window.innerWidth / 2, targetY = window.innerHeight / 2;
    let currentX = targetX, currentY = targetY, cursorTicking = false;
    let lastPointerTime = 0;

    document.addEventListener('pointermove', (e) => {
      targetX = e.clientX; targetY = e.clientY;
      lastPointerTime = performance.now();
      if (!cursorTicking) { cursorTicking = true; requestAnimationFrame(cursorFrame); }
    }, { passive: true });

    function cursorFrame() {
      const now = performance.now();
      const dt = Math.min(1, (now - (lastPointerTime || now)) / 16);
      const lerp = prefersReduced ? 1 : 0.22;
      currentX += (targetX - currentX) * lerp;
      currentY += (targetY - currentY) * lerp;
      cursor.style.left = currentX + 'px';
      cursor.style.top = currentY + 'px';
      cursorTrail.style.transform = `translate(-50%,-50%) translate(${(targetX-currentX)/6}px, ${(targetY-currentY)/6}px) scale(1)`;
      const dx = targetX - currentX, dy = targetY - currentY;
      const speed = Math.min(1, Math.hypot(dx, dy) / 40);
      cursor.style.transform = `translate(-50%,-50%) scale(${1 + speed * 0.06})`;
      if (Math.abs(targetX - currentX) < 0.5 && Math.abs(targetY - currentY) < 0.5) cursorTicking = false;
      else requestAnimationFrame(cursorFrame);
    }

    function addCursorHoverListeners() {
      // event delegation: pointerenter/pointerleave do not bubble, so query elements
      document.querySelectorAll('button, a, .card, .tile, input, select, .photo img').forEach(el => {
        el.addEventListener('pointerenter', () => cursor.classList.add('big'));
        el.addEventListener('pointerleave', () => cursor.classList.remove('big'));
      });
    }

    document.addEventListener('focusin', (e) => { if (e.target && (e.target.matches && (e.target.matches('button, a, input, select, textarea')))) cursor.classList.add('big'); });
    document.addEventListener('focusout', () => cursor.classList.remove('big'));

    /* ---------------------------
       Safe decoration and bursts
       - Throttle bursts, cap total decorations
    ----------------------------*/
    const DECOR_CAP = 60;
    const BURST_THROTTLE_MS = 160;
    let lastBurst = 0;
    function countDecorNodes() { return document.querySelectorAll('.heart, .confetti').length; }

    function safeClickBurst(x, y, kind = 'hearts') {
      if (prefersReduced) return;
      const now = performance.now();
      if (now - lastBurst < BURST_THROTTLE_MS) return;
      lastBurst = now;
      if (countDecorNodes() >= DECOR_CAP) return;
      const maxPerClick = 6;
      const n = Math.min(maxPerClick, Math.floor(3 + Math.random() * 3));
      for (let i = 0; i < n; i++) {
        try {
          if (kind === 'confetti') {
            const c = document.createElement('div');
            c.className = 'confetti';
            const w = Math.floor(Math.random() * 8) + 6;
            c.style.width = w + 'px'; c.style.height = (w * (Math.random()*0.6 + 0.6)) + 'px';
            c.style.left = (x + (Math.random()*40 - 20)) + 'px';
            c.style.top = (y + (Math.random()*24 - 12)) + 'px';
            c.style.background = `hsl(${Math.floor(Math.random()*360)} 90% 65%)`;
            c.style.position = 'fixed'; c.style.zIndex = 10000;
            document.body.appendChild(c);
            c.animate([{ transform: 'translateY(0) rotate(0deg)', opacity: 1 }, { transform: `translate(${(Math.random()*120-60)}px, -${80+Math.random()*80}px) rotate(${Math.floor(Math.random()*720)}deg)`, opacity: 0 }], { duration: 600 + Math.random()*700, easing: 'cubic-bezier(.2,.9,.3,1)', fill: 'forwards' });
            setTimeout(()=> c.remove(), 1500);
          } else {
            const h = document.createElement('div');
            h.className = 'heart';
            const size = Math.floor(Math.random()*10) + 10;
            h.style.setProperty('--size', size + 'px');
            h.style.setProperty('--duration', (0.9 + Math.random()*1.6) + 's');
            h.style.setProperty('--opacity', (0.6 + Math.random()*0.35));
            h.style.setProperty('--windX', (Math.random()*160-80) + 'px');
            h.style.setProperty('--color', `hsl(${320 + Math.floor(Math.random()*40)} 85% 65%)`);
            h.style.left = (x + (Math.random()*40 - 20)) + 'px';
            h.style.top = (y + (Math.random()*24 - 12)) + 'px';
            h.style.position = 'fixed'; h.style.zIndex = 10000;
            document.body.appendChild(h);
            h.addEventListener('animationend', () => { h.remove(); }, { once: true });
            // safety removal
            setTimeout(()=> h.remove(), 1800);
          }
        } catch (ex) { console.error('safeClickBurst error', ex); }
      }
    }

    /* Decorations background: periodic small hearts or confetti */
    let decInterval = null;
    function createHeartBackground() {
      if (prefersReduced) return;
      if (countDecorNodes() >= DECOR_CAP) return;
      const h = document.createElement('div');
      h.className = 'heart';
      const size = Math.floor(Math.random()*18)+12;
      const left = Math.random()*100;
      const duration = (Math.random()*4)+5;
      const opacity = 0.6 + Math.random()*0.35;
      const wind = (Math.random()*160 - 80) + 'px';
      const hue = 320 + Math.floor(Math.random()*40);
      h.style.setProperty('--size', size + 'px');
      h.style.setProperty('--duration', duration + 's');
      h.style.setProperty('--opacity', opacity);
      h.style.setProperty('--windX', wind);
      h.style.setProperty('--color', `hsl(${hue} 85% 65% / 1)`);
      h.style.left = left + 'vw';
      h.style.setProperty('--delay', (Math.random()*0.45)+'s');
      h.style.bottom = '-40px';
      document.body.appendChild(h);
      h.addEventListener('animationend', () => { h.remove(); }, { once: true });
      setTimeout(()=> h.remove(), 9000);
    }

    function createConfettiBurst() {
      if (prefersReduced) return;
      const burst = Math.floor(6 + Math.random()*10);
      for (let i=0;i<burst;i++){
        if (countDecorNodes() >= DECOR_CAP) break;
        const c = document.createElement('div');
        c.className = 'confetti';
        const w = Math.floor(Math.random()*8)+6;
        c.style.width = w + 'px'; c.style.height = (w*(Math.random()*0.6+0.6)) + 'px';
        c.style.position = 'fixed';
        c.style.left = (Math.random()*100) + 'vw';
        c.style.top = (window.innerHeight - 40) + 'px';
        c.style.background = `hsl(${Math.floor(Math.random()*360)} 90% 65%)`;
        c.style.zIndex = 9998;
        document.body.appendChild(c);
        c.animate([{ transform:'translateY(0) rotate(0deg)', opacity:1 }, { transform:`translate(${Math.random()*200-100}px, -${120+Math.random()*120}px) rotate(${Math.floor(Math.random()*720)}deg)`, opacity:0 }], { duration:700+Math.random()*800, easing:'cubic-bezier(.2,.9,.3,1)', fill:'forwards' });
        setTimeout(()=> c.remove(), 1600);
      }
    }

    function applyDecoration(name) {
      clearInterval(decInterval);
      document.querySelectorAll('.heart, .confetti').forEach(n => n.remove());
      if (name === 'hearts') decInterval = setInterval(() => createHeartBackground(), 900);
      else if (name === 'confetti') decInterval = setInterval(() => createConfettiBurst(), 1400);
      else decInterval = null;
      localStorage.setItem('decoration', name);
    }

    /* ---------------------------
       Click ripple and interactive bindings
    ----------------------------*/
    function createRipple(ev, el) {
      try {
        const rect = el.getBoundingClientRect();
        const r = document.createElement('span');
        r.className = 'ripple';
        const size = Math.max(rect.width, rect.height) * 1.4;
        r.style.width = r.style.height = size + 'px';
        r.style.left = (ev.clientX - rect.left - size/2) + 'px';
        r.style.top = (ev.clientY - rect.top - size/2) + 'px';
        r.style.opacity = '0.9';
        el.appendChild(r);
        requestAnimationFrame(() => { r.style.transform = 'scale(1)'; r.style.opacity = '0'; r.style.transition = 'transform .6s cubic-bezier(.2,.9,.3,1), opacity .6s'; });
        setTimeout(() => r.remove(), 700);
      } catch (e) { /* ignore ripple failures */ }
    }

    function bindInteractiveEffects() {
      // attach pointerdown to buttons and clickable items using event delegation where possible
      document.querySelectorAll('button, .card, .tile, .photo img').forEach(el => {
        el.removeEventListener('pointerdown', interactivePointerDown);
        el.addEventListener('pointerdown', interactivePointerDown, { passive: true });
      });
    }

    function interactivePointerDown(ev) {
      // only primary button
      if (ev.button !== 0) return;
      const el = ev.currentTarget;
      try { createRipple(ev, el); } catch (e) {}
      const dec = localStorage.getItem('decoration') || 'hearts';
      safeClickBurst(ev.clientX, ev.clientY, dec === 'confetti' ? 'confetti' : 'hearts');
    }

    /* ---------------------------
       Modal gallery
    ----------------------------*/
    const modal = document.getElementById('modal'), modalImg = document.getElementById('modalImg');
    function openModal(src, alt) { modalImg.src = src; modalImg.alt = alt || 'Imagem'; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden'; }
    function closeModal() { modal.classList.remove('open'); modalImg.src = ''; modal.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('open')) closeModal(); });

    /* ---------------------------
       Gallery population
    ----------------------------*/
    const galleryItems = [
      { src: 'https://i.imgur.com/kUJiuhm.jpeg', alt: 'Conversando no carro' },
      { src: 'https://i.imgur.com/PPq9KND.jpeg', alt: 'Admimirando a Lua' },
      { src: 'https://i.imgur.com/OawRcMt.jpeg', alt: 'No pôr do sol' },
      { src: 'https://i.imgur.com/n4b9m73.jpeg', alt: 'Em todos os momentos' }
    ];
    function populateGallery() {
      const grid = document.getElementById('extraGrid');
      grid.innerHTML = '';
      galleryItems.forEach(it => {
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `<img src="${it.src}" alt="${it.alt}" loading="lazy"><div class="meta">${it.alt}</div>`;
        card.addEventListener('click', (ev) => { openModal(it.src, it.alt); createRipple(ev, card); });
        grid.appendChild(card);
      });
      // rebind effects for newly created cards
      addCursorHoverListeners();
      bindInteractiveEffects();
    }

    /* ---------------------------
       Spotify helpers
    ----------------------------*/
    const spotifyInput = document.getElementById('spotifyInput');
    const loadPlaylistBtn = document.getElementById('loadPlaylistBtn');
    const spotifyBox = document.getElementById('spotifyBox');

    function normalizeSpotifyUrl(raw) {
      if (!raw) return '';
      try {
        raw = raw.trim();
        if (raw.includes('open.spotify.com')) {
          const u = new URL(raw.startsWith('http') ? raw : 'https://' + raw);
          const parts = u.pathname.split('/');
          const idx = parts.indexOf('playlist');
          if (idx >= 0 && parts[idx+1]) return 'https://open.spotify.com/embed/playlist/' + parts[idx+1] + '?utm_source=generator';
        }
        if (/^[0-9A-Za-z]{20,}$/.test(raw)) return 'https://open.spotify.com/embed/playlist/' + raw + '?utm_source=generator';
      } catch (e) {}
      return '';
    }

    function injectSpotifyIframe(raw, focus = true) {
      const url = normalizeSpotifyUrl(raw);
      spotifyBox.innerHTML = '';
      if (!url) { spotifyBox.innerHTML = '<div id="spotifyPlaceholder" style="padding:18px;text-align:center;color:#ffeeff">URL inválida. Cole um link de playlist do Spotify.</div>'; return; }
      const ifr = document.createElement('iframe');
      ifr.className = 'spotify-frame';
      ifr.title = 'Playlist do Spotify';
      ifr.loading = 'lazy';
      ifr.allow = 'autoplay; clipboard-write; encrypted-media; fullscreen';
      ifr.src = url;
      spotifyBox.appendChild(ifr);
      if (focus) try { ifr.focus && ifr.focus(); } catch(e){}
      localStorage.setItem('SPOTIFY_URL', raw);
    }

    loadPlaylistBtn.addEventListener('click', (ev) => {
      const raw = spotifyInput.value.trim();
      injectSpotifyIframe(raw, true);
      createRipple(ev, loadPlaylistBtn);
    });

    const playBtn = document.getElementById('playBtn');
    playBtn.addEventListener('click', () => {
      const iframe = spotifyBox.querySelector('iframe');
      if (iframe) { iframe.focus && iframe.focus(); playBtn.textContent = '▶️ Tocando (se suportado)'; setTimeout(()=> playBtn.textContent = '▶️ Tocar Playlist', 1100); }
      else injectSpotifyIframe(spotifyInput.value, true);
    });

    /* ---------------------------
       Backgrounds & dark mode
    ----------------------------*/
    const darkBtn = document.getElementById('darkModeBtn');
    let dark = false;
    let DAY_BG = localStorage.getItem('DAY_BG') || 'https://i.imgur.com/0JMLcYr.jpeg';
    let NIGHT_BG = localStorage.getItem('NIGHT_BG') || 'https://i.imgur.com/rJePXtj.jpeg';
    const dayInput = document.getElementById('dayBgInput'), nightInput = document.getElementById('nightBgInput');
    const bgVideo = document.getElementById('bgVideo'), bgYouTube = document.getElementById('bgYouTube');

    if (localStorage.getItem('darkMode') === '1') { dark = true; document.body.classList.add('dark'); darkBtn.textContent = '☀️ Modo Claro'; }
    dayInput.value = DAY_BG; nightInput.value = NIGHT_BG;

    function setBackground(url, opts = { forceImage: false }) {
      if (!url) return;
      const yt = parseYouTubeUrl(url);
      if (yt && !opts.forceImage) {
        if (yt.type === 'video') {
          const vid = yt.id;
          const embed = `https://www.youtube.com/embed/${vid}?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&loop=1&playlist=${vid}&enablejsapi=1`;
          bgYouTube.src = embed; bgYouTube.style.opacity = '1'; adjustYouTubeSizing();
          bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity = '0'; document.body.style.backgroundImage = '';
          return;
        } else if (yt.type === 'playlist') {
          const listId = yt.id;
          const embed = `https://www.youtube.com/embed?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&loop=1&enablejsapi=1&listType=playlist&list=${listId}`;
          bgYouTube.src = embed; bgYouTube.style.opacity = '1'; adjustYouTubeSizing();
          bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity = '0'; document.body.style.backgroundImage = '';
          return;
        }
      }
      if (isVideoUrl(url) && !opts.forceImage) {
        bgYouTube.removeAttribute('src'); bgYouTube.style.opacity = '0';
        try { bgVideo.src = url; bgVideo.load(); bgVideo.play().catch(()=>{}); } catch(e){}
        bgVideo.style.opacity = '1';
        document.body.style.backgroundImage = '';
        return;
      }
      // fallback: image
      bgYouTube.removeAttribute('src'); bgYouTube.style.opacity = '0';
      bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity = '0';
      document.body.style.backgroundImage = `url('${url}')`;
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
    }

    function applyCurrentBg() { if (dark && NIGHT_BG) setBackground(NIGHT_BG); else if (!dark && DAY_BG) setBackground(DAY_BG); }
    applyCurrentBg();

    darkBtn.addEventListener('click', () => {
      dark = !dark;
      document.body.classList.toggle('dark', dark);
      darkBtn.textContent = dark ? '☀️ Modo Claro' : '🌙 Modo Noturno';
      localStorage.setItem('darkMode', dark ? '1' : '0');
      applyCurrentBg();
    });

    function safeUrl(s) { try { const u = new URL(s, location.href); return u.href; } catch(e){ return s.trim(); } }
    dayInput.addEventListener('change', () => { const v = safeUrl(dayInput.value); if (v) { DAY_BG = v; localStorage.setItem('DAY_BG', DAY_BG); if (!dark) setBackground(DAY_BG); } });
    nightInput.addEventListener('change', () => { const v = safeUrl(nightInput.value); if (v) { NIGHT_BG = v; localStorage.setItem('NIGHT_BG', NIGHT_BG); if (dark) setBackground(NIGHT_BG); } });

    function adjustYouTubeSizing() {
      if (!bgYouTube) return;
      const vw = window.innerWidth, vh = window.innerHeight, aspect = 16/9;
      if (vw / vh < aspect) { bgYouTube.style.height = `${vh}px`; bgYouTube.style.width = `${vh * aspect}px`; }
      else { bgYouTube.style.width = `${vw}px`; bgYouTube.style.height = `${vw / aspect}px`; }
    }
    window.addEventListener('resize', adjustYouTubeSizing);

    /* ---------------------------
       Reset button (safe)
    ----------------------------*/
    document.getElementById('resetBtn').addEventListener('click', (ev) => {
      localStorage.removeItem('DAY_BG'); localStorage.removeItem('NIGHT_BG'); localStorage.removeItem('SPOTIFY_URL'); localStorage.removeItem('decoration'); localStorage.removeItem('darkMode'); localStorage.removeItem('CONTROL_PANEL_COLLAPSED');
      DAY_BG = 'https://i.imgur.com/0JMLcYr.jpeg'; NIGHT_BG = 'https://i.imgur.com/rJePXtj.jpeg';
      document.getElementById('spotifyInput').value = DEFAULT_SPOTIFY_URL; injectSpotifyIframe(DEFAULT_SPOTIFY_URL, false);
      document.getElementById('decorationSelect').value = 'hearts'; applyDecoration('hearts');
      document.getElementById('dayBgInput').value = DAY_BG; document.getElementById('nightBgInput').value = NIGHT_BG;
      document.body.classList.remove('dark'); dark = false; darkBtn.textContent = '🌙 Modo Noturno';
      applyCurrentBg();
      safeClickBurst(window.innerWidth/2, window.innerHeight/2, 'confetti');
      createRipple(ev, document.getElementById('resetBtn'));
    });

    /* ---------------------------
       Mini-game: memory (optimized)
    ----------------------------*/
    const openGameBtn = document.getElementById('openGameBtn');
    const gamePanel = document.getElementById('gamePanel');
    const gameBoard = document.getElementById('gameBoard');
    const restartGame = document.getElementById('restartGame');
    const gameInfo = document.getElementById('gameInfo');
    let tiles = [], firstPick = null, secondPick = null, lockBoard = false, matches = 0, attempts = 0;
    const symbols = ['💖','🌹','🌟','🍫','🎵','🎁','🍓','🕊️']; // 8 pairs

    function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
    function initGame() {
      tiles = []; firstPick = secondPick = null; lockBoard = false; matches = 0; attempts = 0;
      gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`;
      const needed = 8;
      const pool = symbols.slice(0, needed);
      const doubled = pool.concat(pool);
      const shuffled = shuffle(doubled);
      gameBoard.innerHTML = '';
      shuffled.forEach((s, idx) => {
        const t = document.createElement('div');
        t.className = 'tile';
        t.tabIndex = 0;
        t.setAttribute('data-symbol', s);
        t.setAttribute('role','button');
        t.setAttribute('aria-label','Carta do jogo');
        t.textContent = '';
        t.addEventListener('click', onTileClick);
        t.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onTileClick({ currentTarget: t }); } });
        gameBoard.appendChild(t);
      });
      // rebind interactions for tiles
      addCursorHoverListeners();
      bindInteractiveEffects();
    }

    function onTileClick(e) {
      if (lockBoard) return;
      const t = e.currentTarget;
      if (!t || t.classList.contains('flipped') || t.classList.contains('matched')) return;
      t.classList.add('flipped');
      t.textContent = t.getAttribute('data-symbol');
      if (!firstPick) { firstPick = t; return; }
      secondPick = t;
      lockBoard = true;
      attempts++;
      if (firstPick.getAttribute('data-symbol') === secondPick.getAttribute('data-symbol')) {
        firstPick.classList.add('matched'); secondPick.classList.add('matched');
        matches++;
        setTimeout(()=> {
          resetPicks();
          lockBoard = false;
          gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`;
          if (matches === 8) { setTimeout(()=> safeClickBurst(window.innerWidth/2, window.innerHeight/2, 'confetti'), 300); }
        }, 300);
      } else {
        setTimeout(()=> {
          if (firstPick) { firstPick.classList.remove('flipped'); firstPick.textContent=''; }
          if (secondPick) { secondPick.classList.remove('flipped'); secondPick.textContent=''; }
          resetPicks();
          lockBoard = false;
          gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`;
        }, 700);
      }
    }
    function resetPicks() { firstPick = null; secondPick = null; }

    openGameBtn.addEventListener('click', (ev) => {
      const visible = gamePanel.style.display !== 'none';
      gamePanel.style.display = visible ? 'none' : 'block';
      gamePanel.setAttribute('aria-hidden', visible ? 'true' : 'false');
      if (!visible) initGame();
      createRipple(ev, openGameBtn);
    });
    restartGame.addEventListener('click', (ev) => { initGame(); createRipple(ev, restartGame); });

    /* ---------------------------
       Control panel: toggle
    ----------------------------*/
    (function bindPanelToggle() {
      try {
        const panelToggle = document.getElementById('panelToggle');
        if (!panelToggle) return;
        panelToggle.addEventListener('click', () => {
          const cp = document.getElementById('controlPanel');
          const collapsed = cp.classList.toggle('collapsed');
          localStorage.setItem('CONTROL_PANEL_COLLAPSED', collapsed ? '1' : '0');
          panelToggle.focus();
        });
      } catch (e) { console.error('panelToggle bind error', e); }
    })();

    /* ---------------------------
       Decoration select binding
    ----------------------------*/
    document.getElementById('decorationSelect').addEventListener('change', (e) => applyDecoration(e.target.value));

    /* ---------------------------
       "Ver Mais" expand/collapse (binding added)
       This is the exact behavior from your original implementation:
       - smooth height animation
       - aria attributes updated
       - button text toggles
    ----------------------------*/
    (function bindMoreButton() {
      const moreBtn = document.getElementById('moreBtn');
      const extraContent = document.getElementById('extraContent');
      if (!moreBtn || !extraContent) return;
      moreBtn.addEventListener('click', () => {
        const isOpen = extraContent.classList.contains('open');
        if (isOpen) {
          // collapse smoothly
          const startHeight = extraContent.scrollHeight;
          extraContent.style.height = startHeight + 'px';
          void extraContent.offsetHeight;
          extraContent.style.transition = 'height .36s, opacity .3s';
          extraContent.style.height = '0px';
          extraContent.classList.remove('open');
          extraContent.setAttribute('aria-hidden', 'true');
          moreBtn.setAttribute('aria-expanded', 'false');
          moreBtn.textContent = '💌 Ver Mais';
          setTimeout(() => { extraContent.style.height = ''; extraContent.style.transition = ''; }, 360);
        } else {
          // expand smoothly
          extraContent.classList.add('open');
          extraContent.setAttribute('aria-hidden', 'false');
          moreBtn.setAttribute('aria-expanded', 'true');
          moreBtn.textContent = '🔽 Ver Menos';
          const targetHeight = extraContent.scrollHeight;
          extraContent.style.height = '0px';
          void extraContent.offsetHeight;
          extraContent.style.transition = 'height .36s, opacity .3s';
          extraContent.style.height = targetHeight + 'px';
          setTimeout(() => { extraContent.style.height = ''; extraContent.style.transition = ''; }, 380);
        }
      });
    })();

    /* ---------------------------
       Modal photo click
    ----------------------------*/
    document.getElementById('mainPhoto').addEventListener('click', (ev) => { openModal(ev.currentTarget.src, ev.currentTarget.alt); createRipple(ev, ev.currentTarget); });

    /* ---------------------------
       Gallery initial bind already executed by populateGallery
    ----------------------------*/

    /* ---------------------------
       Safety: remove heavy MutationObserver usage from original and rely on explicit binds
    ----------------------------*/

    /* ---------------------------
       Final housekeeping: ensure decoration state reapplied
    ----------------------------*/
    try { const saved = localStorage.getItem('decoration'); if (saved) applyDecoration(saved); } catch(e) {}

    /* End of script */
  </script>
</body>

</html>
