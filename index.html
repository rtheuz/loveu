<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <title>💖 B & M 💖</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Uma surpresa romântica com músicas, lembranças e mensagens." />
  <meta name="theme-color" content="#ff80ab" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@400;600&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html,
    body {
      height: 100%
    }

    body {
      font-family: 'Montserrat', sans-serif;
      color: #fff;
      background: #000 center/cover no-repeat fixed;
      transition: background 0.8s ease, color 0.6s ease;
      overflow: auto;
      min-height: 100vh;
    }

    /* background media */
    #bgMediaWrap {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: -4;
      overflow: hidden;
      pointer-events: none
    }

    #bgVideo {
      position: absolute;
      left: 50%;
      top: 50%;
      width: auto;
      height: 100%;
      min-width: 100%;
      min-height: 100%;
      transform: translate(-50%, -50%);
      object-fit: cover;
      z-index: -4;
      opacity: 0;
      transition: opacity .7s;
      pointer-events: none
    }

    #bgYouTube {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 177.77vh;
      height: 100vh;
      transform: translate(-50%, -50%);
      border: 0;
      z-index: -4;
      opacity: 0;
      transition: opacity .7s, transform .7s;
      pointer-events: none
    }

    @media(min-aspect-ratio:16/9) {
      #bgYouTube {
        width: 100vw;
        height: 56.25vw;
      }
    }

    #bgOverlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, .18), rgba(0, 0, 0, .45));
      z-index: -3;
      pointer-events: none;
      transition: background .5s
    }

    body.loaded h1,
    body.loaded .container {
      opacity: 1;
      transform: none
    }

    h1 {
      font-family: 'Pacifico', cursive;
      font-size: clamp(2rem, 6vw, 3rem);
      color: #ffb6c1;
      text-shadow: 0 0 12px rgba(255, 105, 180, .9);
      margin: 28px 0 12px;
      opacity: 0;
      transform: scale(.9);
      transition: all .8s cubic-bezier(.2, .9, .3, 1);
      text-align: center
    }

    .wrap {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
      gap: 20px
    }

    .container {
      background: rgba(255, 255, 255, .10);
      backdrop-filter: blur(6px);
      padding: 22px;
      border-radius: 18px;
      box-shadow: 0 6px 30px rgba(0, 0, 0, .45);
      max-width: 960px;
      width: 100%;
      opacity: 0;
      transform: scale(.98);
      transition: all .6s
    }

    .top {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap
    }

    .photo {
      width: 240px;
      min-width: 160px;
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid rgba(233, 30, 99, .9);
      flex-shrink: 0
    }

    .photo img {
      display: block;
      width: 100%;
      height: auto
    }

    .maincol {
      flex: 1;
      min-width: 260px
    }

    .message {
      font-weight: 600;
      font-size: 1.05rem;
      margin-bottom: 10px;
      white-space: pre-wrap;
      text-shadow: 0 0 8px rgba(0, 0, 0, .7)
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px
    }

    .btn {
      padding: 10px 18px;
      border-radius: 24px;
      border: none;
      background: linear-gradient(135deg, #ff80ab, #ff4f8b);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: .2s
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 24px rgba(255, 80, 130, .12)
    }

    .btn:active {
      transform: translateY(-1px) scale(.995)
    }

    .btn:focus {
      outline: 3px solid rgba(255, 200, 220, .6);
      outline-offset: 3px
    }

    .spotify-box {
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 18px rgba(0, 0, 0, .35);
      background: rgba(0, 0, 0, .15)
    }

    iframe.spotify-frame {
      width: 100%;
      height: 152px;
      border: none;
      border-radius: 12px
    }

    #extraContent {
      margin-top: 18px;
      display: block;
      height: 0;
      overflow: hidden;
      transition: height .45s, opacity .35s;
      opacity: 0
    }

    #extraContent.open {
      height: auto;
      opacity: 1;
      padding-top: 12px
    }

    .extra-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      align-items: start
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.02));
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(255, 128, 171, .12);
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .25);
      transition: transform .18s, box-shadow .18s
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 34px rgba(0, 0, 0, .35)
    }

    .card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      display: block
    }

    .card .meta {
      padding: 8px 10px;
      font-size: .95rem;
      color: #ffeef6
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .85);
      z-index: 1100;
      padding: 20px
    }

    .modal.open {
      display: flex
    }

    .modal .inner {
      max-width: 92vw;
      max-height: 90vh;
      border-radius: 12px;
      overflow: hidden
    }

    .modal img {
      display: block;
      max-width: 100%;
      max-height: 90vh
    }

    #gamePanel {
      margin-top: 16px;
      padding: 12px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .02));
      box-shadow: 0 8px 20px rgba(0, 0, 0, .18)
    }

    .game-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px
    }

    .game-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      max-width: 520px;
      margin: 0 auto
    }

    .tile {
      background: linear-gradient(180deg, #ffeef7, #ffd6e8);
      height: 84px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      cursor: pointer;
      user-select: none
    }

    .tile.flipped {
      background: linear-gradient(180deg, #fff, #ffe6f0);
      transform: rotateY(0)
    }

    .tile.matched {
      background: linear-gradient(180deg, #ffecf4, #ffdbe8);
      cursor: default;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .12)
    }

    .small {
      font-size: .9rem;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(0, 0, 0, .12);
      color: #fff
    }

    /* hearts */
    .heart {
      position: fixed;
      bottom: -40px;
      width: var(--size, 20px);
      height: var(--size, 20px);
      background: var(--color, #ff7aa9);
      transform: rotate(-45deg);
      opacity: 0;
      z-index: 9998;
      pointer-events: none;
      border-radius: 2px;
      animation: floatHeart var(--duration, 6s) linear var(--delay, 0s) forwards;
      will-change: transform, opacity
    }

    .heart::before,
    .heart::after {
      content: "";
      position: absolute;
      width: var(--size, 20px);
      height: var(--size, 20px);
      background: var(--color, #ff7aa9);
      border-radius: 50%
    }

    .heart::before {
      top: calc(var(--size) * -0.5);
      left: 0
    }

    .heart::after {
      left: calc(var(--size) * 0.5);
      top: 0
    }

    @keyframes floatHeart {
      0% {
        opacity: 0;
        transform: translateX(0) translateY(0) rotate(-45deg) scale(.85)
      }

      8% {
        opacity: var(--opacity, 0.9)
      }

      40% {
        transform: translateX(calc(var(--windX, 0px) * 0.3)) translateY(-38vh) rotate(-45deg) scale(1.05)
      }

      100% {
        transform: translateX(var(--windX, 0px)) translateY(-120vh) rotate(-45deg) scale(0.9);
        opacity: 0
      }
    }

    /* cursor */
    .cursor {
      position: fixed;
      left: 0;
      top: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      mix-blend-mode: screen;
      transition: width .12s ease, height .12s ease, transform .06s linear;
      transform: translate(-50%, -50%)
    }

    .cursor.big {
      width: 52px;
      height: 52px
    }

    .cursor .c-heart {
      width: 12px;
      height: 12px;
      transform: rotate(-45deg);
      background: #fff;
      border-radius: 2px;
      position: relative
    }

    .cursor .c-heart::before,
    .cursor .c-heart::after {
      content: "";
      position: absolute;
      width: 12px;
      height: 12px;
      background: #fff;
      border-radius: 50%
    }

    .cursor .c-heart::before {
      top: -6px;
      left: 0
    }

    .cursor .c-heart::after {
      left: 6px;
      top: 0
    }

    body.dark {
      color: #ffd3e4
    }

    body.dark h1 {
      color: #ffc1d6
    }

    body.dark .btn {
      background: linear-gradient(135deg, #aa3b6a, #ff6f9b)
    }

    body.dark .container {
      background: rgba(20, 20, 20, .65)
    }

    /* control panel */
    #controlPanel {
      position: fixed;
      top: 12px;
      left: 12px;
      background: rgba(0, 0, 0, .5);
      backdrop-filter: blur(6px);
      padding: 8px;
      border-radius: 10px;
      font-size: 0.82rem;
      color: #fff;
      z-index: 9999;
      width: 260px;
      max-width: calc(100% - 28px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, .4);
      transition: transform .28s ease, opacity .2s
    }

    #controlPanel.collapsed {
      transform: translate(-20%, 0);
      opacity: 0.12;
      width: 56px;
      padding: 6px;
      overflow: visible;
      border-radius: 12px;
      z-index: 10001;
      pointer-events: auto
    }

    #controlHeader {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px
    }

    #panelToggle {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #ff80ab, #ff4f8b);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #fff;
      font-weight: 700;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .22);
      position: relative;
      z-index: 10002
    }

    #controlTitle {
      font-weight: 700;
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    #controlPanel.collapsed input,
    #controlPanel.collapsed select,
    #controlPanel.collapsed button:not(#panelToggle),
    #controlPanel.collapsed small,
    #controlPanel.collapsed label {
      display: none
    }

    @media(max-width:520px) {
      #controlPanel {
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 24px);
        bottom: 12px;
        top: auto;
        padding: 10px;
        border-radius: 12px
      }

      #controlPanel.collapsed {
        transform: translateX(-50%) translateY(86%);
        opacity: 0.12;
        width: 64px;
        bottom: 12px;
        left: calc(100% - 36px);
        top: auto;
        padding: 6px;
        border-radius: 12px
      }

      #panelToggle {
        width: 44px;
        height: 44px;
        border-radius: 10px;
      }
    }

    @media(max-width:900px) {
      .top {
        flex-direction: column;
        align-items: center
      }

      .photo {
        width: 200px
      }

      .container {
        padding: 16px
      }
    }

    @media(max-width:560px) {
      .game-board {
        grid-template-columns: repeat(2, 1fr)
      }

      .tile {
        height: 72px
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important
      }
    }
  </style>
</head>

<body>
  <div id="bgMediaWrap" aria-hidden="true">
    <video id="bgVideo" playsinline muted loop></video>
    <iframe id="bgYouTube" allow="autoplay; fullscreen"
      sandbox="allow-same-origin allow-scripts allow-presentation"></iframe>
  </div>
  <div id="bgOverlay"></div>

  <div id="controlPanel" aria-label="Painel de controle">
    <div id="controlHeader">
      <button id="panelToggle" title="Mostrar / Esconder painel">☰</button>
      <div id="controlTitle">Painel de controle</div>
    </div>

    <label style="font-weight:700;margin-bottom:6px;display:block">🌞 Fundo Diurno (imagem, mp4 ou YouTube)</label>
    <input id="dayBgInput" placeholder="URL da imagem, .mp4 ou link YouTube (watch/shorts/youtu.be/playlist)"
      style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <label style="font-weight:700;margin-bottom:6px;display:block">🌙 Fundo Noturno (imagem, mp4 ou YouTube)</label>
    <input id="nightBgInput" placeholder="URL da imagem, .mp4 ou link YouTube (watch/shorts/youtu.be/playlist)"
      style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <label style="font-weight:700;margin-bottom:6px;display:block">🎧 Playlist Spotify</label>
    <input id="spotifyInput" placeholder="Cole o link da playlist (open.spotify.com/playlist/...)"
      style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <button id="loadPlaylistBtn" class="btn" style="width:100%;margin-bottom:6px">▶️ Carregar Playlist</button>
    <small style="display:block;opacity:.85;color:#ffd6ea;margin-bottom:8px">Use o botão "Tocar Playlist" no card para
      liberar reprodução em alguns navegadores.</small>
    <label style="font-weight:700;margin-bottom:6px;display:block">✨ Enfeites</label>
    <select id="decorationSelect" style="width:100%;padding:6px;border-radius:6px;border:none;margin-bottom:8px">
      <option value="hearts">Corações</option>
      <option value="confetti">Confetti</option>
      <option value="none">Nenhum</option>
    </select>
    <button id="resetBtn" class="btn"
      style="background:linear-gradient(135deg,#ff7676,#ffb199);width:100%">Resetar</button>
  </div>

  <h1>💖 TE AMOOO 💖</h1>

  <div class="wrap">
    <div class="container" role="main">
      <div class="top">
        <figure class="photo"><img loading="lazy" src="https://i.imgur.com/oK3x5BH.jpeg" alt="Nossa foto juntos" />
        </figure>
        <div class="maincol">
          <div class="message" id="message" aria-live="polite"></div>
          <div class="controls">
            <button type="button" class="btn" id="playBtn">▶️ Tocar Playlist</button>
            <button type="button" class="btn" id="moreBtn" aria-expanded="false">💌 Ver Mais</button>
            <button type="button" class="btn" id="darkModeBtn">🌙 Modo Noturno</button>
            <button type="button" class="btn" id="openGameBtn">🎯 Jogar (Mini-Game)</button>
          </div>

          <div class="spotify-box" id="spotifyBox" style="margin-top:12px">
            <div id="spotifyPlaceholder" style="padding:18px;text-align:center;color:#ffeeff">Playlist não carregada
            </div>
          </div>

          <div id="gamePanel" aria-hidden="true" style="display:none">
            <div class="game-header">
              <div style="font-weight:700">Cupid's Match — Jogo da Memória</div>
              <div class="small" id="gameInfo">Acertos: 0 | Tentativas: 0</div>
            </div>
            <div class="game-board" id="gameBoard" aria-live="polite"></div>
            <div style="text-align:center;margin-top:10px"><button id="restartGame" class="btn">🔁 Reiniciar</button>
            </div>
          </div>

        </div>
      </div>

      <div id="extraContent" aria-hidden="true">
        <div class="extra-grid" id="extraGrid"></div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="inner"><img id="modalImg" src="" alt="Imagem ampliada"></div>
  </div>
  <div id="cursor" class="cursor" aria-hidden="true">
    <div class="c-heart"></div>
  </div>

  <script>
    /* --- Removed external audio references to avoid 403 blocking; audio optional --- */

    /* Typing message */
    const messageEl = document.getElementById('message');
    const text = "AMOOR DA MINHA VIDA, MINHA GATINHAA 💫";
    let i = 0;
    function type() { if (i < text.length) { messageEl.textContent += text.charAt(i++); setTimeout(type, 70) } }

    /* Defaults */
    const DEFAULT_SPOTIFY_URL = 'https://open.spotify.com/playlist/3AlzaL3fuUAtulQFklJy8v?si=_5BzUq0CQ_WDlL31eLaUcg';

    /* YouTube helpers (unchanged logic) */
    function parseYouTubeUrl(url) {
      if (!url) return null;
      try {
        const u = new URL(url, location.href);
        const hostname = u.hostname.replace('www.', '');
        if (hostname === 'youtu.be') {
          const vid = u.pathname.slice(1).split('/')[0];
          if (vid) return { type: 'video', id: vid };
        }
        if (hostname.includes('youtube.com') || hostname.includes('youtube-nocookie.com')) {
          if (u.pathname.startsWith('/playlist') && u.searchParams.get('list')) return { type: 'playlist', id: u.searchParams.get('list') };
          if (u.searchParams.get('v')) {
            const vid = u.searchParams.get('v'); const list = u.searchParams.get('list');
            if (list) return { type: 'playlist', id: list };
            return { type: 'video', id: vid };
          }
          const parts = u.pathname.split('/');
          const shortsIdx = parts.indexOf('shorts');
          if (shortsIdx >= 0 && parts[shortsIdx + 1]) return { type: 'video', id: parts[shortsIdx + 1] };
          if (u.pathname.startsWith('/embed/')) return { type: 'video', id: u.pathname.split('/embed/')[1].split('/')[0] };
        }
        if (u.searchParams.get('list')) return { type: 'playlist', id: u.searchParams.get('list') };
      } catch (e) { }
      return null;
    }
    function isVideoUrl(url) { return url && url.split('?')[0].toLowerCase().endsWith('.mp4'); }

    /* INIT */
    window.addEventListener('load', () => {
      setTimeout(() => document.body.classList.add('loaded'), 180);
      type();

      // restore decoration and panel state
      const savedDec = localStorage.getItem('decoration') || 'hearts';
      document.getElementById('decorationSelect').value = savedDec;
      applyDecoration(savedDec);

      const sp = localStorage.getItem('SPOTIFY_URL');
      if (sp) { document.getElementById('spotifyInput').value = sp; injectSpotifyIframe(sp, false); }
      else { document.getElementById('spotifyInput').value = DEFAULT_SPOTIFY_URL; localStorage.setItem('SPOTIFY_URL', DEFAULT_SPOTIFY_URL); injectSpotifyIframe(DEFAULT_SPOTIFY_URL, false); }

      // restore bg inputs if saved
      const day = localStorage.getItem('DAY_BG'); const night = localStorage.getItem('NIGHT_BG');
      if (day) document.getElementById('dayBgInput').value = day;
      if (night) document.getElementById('nightBgInput').value = night;

      // gallery
      populateGallery();

      // YouTube sizing
      window.addEventListener('resize', adjustYouTubeSizing);

      // "Ver Mais" expand/collapse
      const moreBtn = document.getElementById('moreBtn');
      const extraContent = document.getElementById('extraContent');
      moreBtn.addEventListener('click', () => {
        const isOpen = extraContent.classList.contains('open');
        if (isOpen) {
          const startHeight = extraContent.scrollHeight;
          extraContent.style.height = startHeight + 'px';
          void extraContent.offsetHeight;
          extraContent.style.transition = 'height .36s, opacity .3s';
          extraContent.style.height = '0px';
          extraContent.classList.remove('open');
          extraContent.setAttribute('aria-hidden', 'true');
          moreBtn.setAttribute('aria-expanded', 'false');
          moreBtn.textContent = '💌 Ver Mais';
          setTimeout(() => { extraContent.style.height = ''; extraContent.style.transition = ''; }, 360);
        } else {
          extraContent.classList.add('open');
          extraContent.setAttribute('aria-hidden', 'false');
          moreBtn.setAttribute('aria-expanded', 'true');
          moreBtn.textContent = '🔽 Ver Menos';
          const targetHeight = extraContent.scrollHeight;
          extraContent.style.height = '0px';
          void extraContent.offsetHeight;
          extraContent.style.transition = 'height .36s, opacity .3s';
          extraContent.style.height = targetHeight + 'px';
          setTimeout(() => { extraContent.style.height = ''; extraContent.style.transition = ''; }, 380);
        }
      });

      // restore panel collapsed state
      const cp = document.getElementById('controlPanel');
      if (localStorage.getItem('CONTROL_PANEL_COLLAPSED') === '1') cp.classList.add('collapsed');
    });

    /* Cursor smoothing (robust) */
    const cursor = document.getElementById('cursor');
    let targetX = window.innerWidth / 2, targetY = window.innerHeight / 2;
    let currentX = targetX, currentY = targetY, ticking = false;
    document.addEventListener('mousemove', e => {
      targetX = e.clientX; targetY = e.clientY;
      if (!ticking) { ticking = true; requestAnimationFrame(updateCursor); }
    });
    function updateCursor() {
      const lerp = 0.22;
      currentX += (targetX - currentX) * lerp;
      currentY += (targetY - currentY) * lerp;
      cursor.style.left = currentX + 'px';
      cursor.style.top = currentY + 'px';
      const dx = targetX - currentX, dy = targetY - currentY;
      const speed = Math.min(1, Math.hypot(dx, dy) / 40);
      cursor.style.transform = `translate(-50%,-50%) scale(${1 + speed * 0.12})`;
      if (Math.abs(targetX - currentX) < 0.5 && Math.abs(targetY - currentY) < 0.5) ticking = false;
      else requestAnimationFrame(updateCursor);
    }
    document.querySelectorAll('button,a,img').forEach(el => { el.addEventListener('mouseenter', () => cursor.classList.add('big')); el.addEventListener('mouseleave', () => cursor.classList.remove('big')); });

    /* Decorations (hearts + confetti) */
    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let heartsActive = 0, MAX_HEARTS = 26;
    function createHeart() {
      if (prefersReduced) return;
      if (heartsActive >= MAX_HEARTS) return;
      heartsActive++;
      const h = document.createElement('div');
      h.className = 'heart';
      const size = Math.floor(Math.random() * 18) + 12;
      const left = Math.random() * 100;
      const duration = (Math.random() * 4) + 5;
      const opacity = 0.6 + Math.random() * 0.4;
      const wind = (Math.random() * 160 - 80) + 'px';
      const hue = 320 + Math.floor(Math.random() * 40);
      h.style.setProperty('--size', size + 'px');
      h.style.setProperty('--duration', duration + 's');
      h.style.setProperty('--opacity', opacity);
      h.style.setProperty('--windX', wind);
      h.style.setProperty('--color', `hsl(${hue} 85% 65% / 1)`);
      h.style.left = left + 'vw';
      h.style.setProperty('--delay', (Math.random() * 0.45) + 's');
      document.body.appendChild(h);
      h.addEventListener('animationend', () => { h.remove(); heartsActive = Math.max(0, heartsActive - 1); }, { once: true });
    }

    function createConfettiBurst(){ if(prefersReduced) return; const burst = Math.floor(8 + Math.random()*14); for(let i=0;i<burst;i++){ const c=document.createElement('div'); c.className='confetti'; c.style.position='fixed'; c.style.width='8px'; c.style.height='12px'; c.style.left=(Math.random()*100)+'vw'; c.style.bottom='0px'; c.style.background=['#ff6f9b','#ffd166','#61dafb','#7afc9c'][Math.floor(Math.random()*4)]; c.style.transform='rotate('+ (Math.random()*360)+'deg)'; c.style.opacity='0.95'; const dur=2+Math.random()*2; c.style.transition='transform '+dur+'s linear, bottom '+dur+'s linear, opacity '+dur+'s linear'; document.body.appendChild(c); setTimeout(()=>{ c.style.bottom = (90+Math.random()*40)+'vh'; c.style.transform = 'rotate('+(Math.random()*720)+'deg) translateX('+(Math.random()*200-100)+'px)'; c.style.opacity='0'; },20); setTimeout(()=>c.remove(), (dur+0.3)*1000); }}

    let decInterval = null;
    function applyDecoration(name) {
      try {
        clearInterval(decInterval);
        document.querySelectorAll('.heart,.confetti').forEach(n => n.remove());
        if (name === 'hearts') decInterval = setInterval(() => createHeart(), 360);
        else if (name === 'confetti') decInterval = setInterval(() => createConfettiBurst(), 1200);
        else decInterval = null;
        localStorage.setItem('decoration', name);
      } catch (e) { console.error('applyDecoration error', e); }
    }
    document.getElementById('decorationSelect').addEventListener('change', e => applyDecoration(e.target.value));

    /* Gallery modal */
    const modal = document.getElementById('modal'), modalImg = document.getElementById('modalImg');
    function openModal(src, alt) { modalImg.src = src; modalImg.alt = alt || 'Imagem'; modal.classList.add('open'); modal.setAttribute('aria-hidden', 'false'); document.body.style.overflow = 'hidden'; }
    function closeModal() { modal.classList.remove('open'); modalImg.src = ''; modal.setAttribute('aria-hidden', 'true'); document.body.style.overflow = ''; }
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && modal.classList.contains('open')) closeModal(); });

    /* Gallery */
    const galleryItems = [
      { src: 'https://i.imgur.com/kUJiuhm.jpeg', alt: 'Conversando no carro' },
      { src: 'https://i.imgur.com/PPq9KND.jpeg', alt: 'Admimirando a Lua' },
      { src: 'https://i.imgur.com/OawRcMt.jpeg', alt: 'No pôr do sol' },
      { src: 'https://i.imgur.com/n4b9m73.jpeg', alt: 'Em todos os momentos' }
    ];
    function populateGallery() {
      const grid = document.getElementById('extraGrid');
      grid.innerHTML = '';
      galleryItems.forEach(it => {
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `<img src="${it.src}" alt="${it.alt}" loading="lazy"><div class="meta">${it.alt}</div>`;
        card.addEventListener('click', () => openModal(it.src, it.alt));
        grid.appendChild(card);
      });
    }

    /* Spotify embed helpers */
    const spotifyInput = document.getElementById('spotifyInput');
    const loadPlaylistBtn = document.getElementById('loadPlaylistBtn');
    const spotifyBox = document.getElementById('spotifyBox');

    function normalizeSpotifyUrl(raw) {
      if (!raw) return '';
      try {
        raw = raw.trim();
        if (raw.includes('open.spotify.com')) {
          const u = new URL(raw.startsWith('http') ? raw : 'https://' + raw);
          const parts = u.pathname.split('/');
          const idx = parts.indexOf('playlist');
          if (idx >= 0 && parts[idx + 1]) return 'https://open.spotify.com/embed/playlist/' + parts[idx + 1] + '?utm_source=generator';
        }
        if (/^[0-9A-Za-z]{20,}$/.test(raw)) return 'https://open.spotify.com/embed/playlist/' + raw + '?utm_source=generator';
      } catch (e) { }
      return '';
    }
    function extractOpenSpotifyUrl(raw) {
      if (!raw) return '';
      try {
        raw = raw.trim();
        if (raw.includes('open.spotify.com')) {
          const u = new URL(raw.startsWith('http') ? raw : 'https://' + raw);
          return `https://${u.hostname}${u.pathname}${u.search}`;
        }
        if (/^[0-9A-Za-z]{20,}$/.test(raw)) return 'https://open.spotify.com/playlist/' + raw;
      } catch (e) { }
      return '';
    }
    function injectSpotifyIframe(raw, focus = true) {
      const url = normalizeSpotifyUrl(raw);
      spotifyBox.innerHTML = '';
      if (!url) { spotifyBox.innerHTML = '<div id="spotifyPlaceholder" style="padding:18px;text-align:center;color:#ffeeff">URL inválida. Cole um link de playlist do Spotify.</div>'; return; }
      const ifr = document.createElement('iframe'); ifr.className = 'spotify-frame'; ifr.title = 'Playlist do Spotify'; ifr.loading = 'lazy'; ifr.allow = 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture';
      ifr.src = url;
      spotifyBox.appendChild(ifr);
      if (focus) { try { ifr.focus && ifr.focus(); } catch (e) { } }
      localStorage.setItem('SPOTIFY_URL', raw);
    }
    loadPlaylistBtn.addEventListener('click', () => { const raw = spotifyInput.value.trim(); injectSpotifyIframe(raw, true); });

    const playBtn = document.getElementById('playBtn');
    playBtn.onclick = () => {
      const iframe = spotifyBox.querySelector('iframe');
      if (iframe) { iframe.focus && iframe.focus(); playBtn.textContent = '▶️ Tocando (se suportado)'; setTimeout(() => playBtn.textContent = '▶️ Tocar Playlist', 1200); }
      else injectSpotifyIframe(spotifyInput.value, true);
    };

    /* Dark mode + backgrounds (kept) */
    const darkBtn = document.getElementById('darkModeBtn');
    let dark = false;
    let DAY_BG = localStorage.getItem('DAY_BG') || 'https://i.imgur.com/0JMLcYr.jpeg';
    let NIGHT_BG = localStorage.getItem('NIGHT_BG') || 'https://i.imgur.com/rJePXtj.jpeg';
    const dayInput = document.getElementById('dayBgInput'), nightInput = document.getElementById('nightBgInput');
    if (localStorage.getItem('darkMode') === '1') { dark = true; document.body.classList.add('dark'); darkBtn.textContent = '☀️ Modo Claro' }
    dayInput.value = DAY_BG; nightInput.value = NIGHT_BG;
    const bgVideo = document.getElementById('bgVideo'), bgYouTube = document.getElementById('bgYouTube');

    function setBackground(url, opts = { forceImage: false }) {
      if (!url) return;
      const yt = parseYouTubeUrl(url);
      if (yt && !opts.forceImage) {
        if (yt.type === 'video') {
          const vid = yt.id;
          const embed = `https://www.youtube.com/embed/${vid}?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&loop=1&playlist=${vid}&enablejsapi=1`;
          bgYouTube.src = embed; bgYouTube.style.opacity = '1'; adjustYouTubeSizing(); bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity = '0'; document.body.style.backgroundImage = ''; return;
        } else if (yt.type === 'playlist') {
          const listId = yt.id;
          const embed = `https://www.youtube.com/embed?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&loop=1&enablejsapi=1&listType=playlist&list=${listId}`;
          bgYouTube.src = embed; bgYouTube.style.opacity = '1'; adjustYouTubeSizing(); bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity = '0'; document.body.style.backgroundImage = ''; return;
        }
      }
      if (isVideoUrl(url) && !opts.forceImage) {
        bgYouTube.removeAttribute('src'); bgYouTube.style.opacity = '0'; bgVideo.src = url; bgVideo.load(); bgVideo.play().catch(() => { }); bgVideo.style.opacity = '1'; document.body.style.backgroundImage = ''; return;
      }
      bgYouTube.removeAttribute('src'); bgYouTube.style.opacity = '0'; bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity = '0'; document.body.style.backgroundImage = `url('${url}')`; document.body.style.backgroundSize = 'cover'; document.body.style.backgroundPosition = 'center';
    }
    function applyCurrentBg() { if (dark && NIGHT_BG) setBackground(NIGHT_BG); else if (!dark && DAY_BG) setBackground(DAY_BG); }
    applyCurrentBg();
    darkBtn.onclick = () => { dark = !dark; document.body.classList.toggle('dark', dark); darkBtn.textContent = dark ? '☀️ Modo Claro' : '🌙 Modo Noturno'; localStorage.setItem('darkMode', dark ? '1' : '0'); applyCurrentBg(); }
    function safeUrl(s) { try { const u = new URL(s, location.href); return u.href; } catch (e) { return s.trim(); } }
    dayInput.onchange = () => { const v = safeUrl(dayInput.value); if (v) { DAY_BG = v; localStorage.setItem('DAY_BG', DAY_BG); if (!dark) setBackground(DAY_BG); } }
    nightInput.onchange = () => { const v = safeUrl(nightInput.value); if (v) { NIGHT_BG = v; localStorage.setItem('NIGHT_BG', NIGHT_BG); if (dark) setBackground(NIGHT_BG); } }
    function adjustYouTubeSizing() { if (!bgYouTube) return; const vw = window.innerWidth; const vh = window.innerHeight; const aspect = 16 / 9; if (vw / vh < aspect) { bgYouTube.style.height = `${vh}px`; bgYouTube.style.width = `${vh * aspect}px`; } else { bgYouTube.style.width = `${vw}px`; bgYouTube.style.height = `${vw / aspect}px`; } bgYouTube.style.left = '50%'; bgYouTube.style.top = '50%'; bgYouTube.style.transform = 'translate(-50%,-50%)'; }

    /* reset */
    document.getElementById('resetBtn').addEventListener('click', () => { localStorage.removeItem('DAY_BG'); localStorage.removeItem('NIGHT_BG'); localStorage.removeItem('SPOTIFY_URL'); localStorage.removeItem('decoration'); localStorage.removeItem('darkMode'); localStorage.removeItem('CONTROL_PANEL_COLLAPSED'); location.reload(); });

    /* mini-game */
    const openGameBtn = document.getElementById('openGameBtn');
    const gamePanel = document.getElementById('gamePanel');
    const gameBoard = document.getElementById('gameBoard');
    const restartGame = document.getElementById('restartGame');
    const gameInfo = document.getElementById('gameInfo');
    let tiles = [], firstPick = null, secondPick = null, lockBoard = false, matches = 0, attempts = 0;
    const symbols = ['💖', '🌹', '🌟', '🍫'];
    function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } return array; }
    function initGame() { tiles = []; firstPick = secondPick = null; lockBoard = false; matches = 0; attempts = 0; gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`; const paired = shuffle([...symbols, ...symbols]); gameBoard.innerHTML = ''; paired.forEach((sym, idx) => { const t = document.createElement('div'); t.className = 'tile'; t.dataset.symbol = sym; t.dataset.index = idx; t.textContent = ''; t.addEventListener('click', onTileClick); gameBoard.appendChild(t); }); }
    function onTileClick(e) { if (lockBoard) return; const t = e.currentTarget; if (t.classList.contains('flipped') || t.classList.contains('matched')) return; t.classList.add('flipped'); t.textContent = t.dataset.symbol; if (!firstPick) { firstPick = t; return; } secondPick = t; lockBoard = true; attempts++; if (firstPick.dataset.symbol === secondPick.dataset.symbol) { firstPick.classList.add('matched'); secondPick.classList.add('matched'); matches++; resetPicks(); lockBoard = false; gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`; if (matches === symbols.length) setTimeout(() => alert(`Você ganhou! Acertos: ${matches} | Tentativas: ${attempts} — Te amo ❤`), 300); } else { gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`; setTimeout(() => { firstPick.classList.remove('flipped'); secondPick.classList.remove('flipped'); firstPick.textContent = ''; secondPick.textContent = ''; resetPicks(); lockBoard = false; }, 700); } }
    function resetPicks() { firstPick = null; secondPick = null; }
    openGameBtn.addEventListener('click', () => { const visible = gamePanel.style.display !== 'none'; gamePanel.style.display = visible ? 'none' : 'block'; gamePanel.setAttribute('aria-hidden', visible ? 'true' : 'false'); if (!visible) initGame(); });
    restartGame.addEventListener('click', () => initGame());

    /* control panel toggle (safe bind) */
    (function bindPanelToggle() {
      try {
        const panelToggle = document.getElementById('panelToggle');
        if (!panelToggle) return;
        panelToggle.addEventListener('click', () => {
          const cp = document.getElementById('controlPanel');
          const collapsed = cp.classList.toggle('collapsed');
          localStorage.setItem('CONTROL_PANEL_COLLAPSED', collapsed ? '1' : '0');
          panelToggle.focus();
        });
      } catch (e) { console.error('panelToggle bind error', e); }
    })();

    /* ensure decorations start if saved */
    try { const saved = localStorage.getItem('decoration'); if (saved) applyDecoration(saved); } catch (e) { }

    /* End of script */
  </script>
</body>

</html>
