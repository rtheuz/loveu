<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <title>B & M FOREVER</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="description" content="Uma surpresa rom√¢ntica com m√∫sicas, lembran√ßas e mensagens." />
  <meta name="theme-color" content="#ff80ab" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="icon" type="image/png" href="https://i.imgur.com/DFVw1zK.png" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <!-- iOS/Safari PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="B&M" />
  <link rel="apple-touch-icon" href="https://i.imgur.com/XzL3LBy.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@400;600&display=swap');

    :root {
      --accent-1: #ff80ab;
      --accent-2: #ff4f8b;
      --glass: rgba(255, 255, 255, 0.10);
      --control-bg: rgba(0, 0, 0, 0.5);
      --bg-dark: #0b0710;
      --bg-light: #000;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html {
      height: 100%;
      /* Native app feel - hide scrollbar on standalone mode */
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      /* Garantir que o scroll comece no topo */
      scroll-behavior: auto;
    }
    
    html, body {
      scroll-padding-top: 0;
    }

    body {
      font-family: Montserrat, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: #fff;
      background: var(--bg-light) center/cover no-repeat fixed;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background .6s, color .4s;
      /* Prevent pull-to-refresh on mobile */
      overscroll-behavior-y: contain;
      /* Safe area support for notched devices - apenas bottom para n√£o empurrar conte√∫do */
      padding-top: 0;
      padding-bottom: env(safe-area-inset-bottom);
      /* Garantir que o conte√∫do comece no topo */
      margin: 0;
      padding-left: 0;
      padding-right: 0;
      overflow-x: hidden;
    }

    /* layout */
    .wrap {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
      padding-top: 20px;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      gap: 20px;
      position: relative;
      margin-top: 0;
      margin-bottom: 0;
      scroll-margin-top: 0;
      /* Remover min-height para evitar centraliza√ß√£o vertical */
      min-height: auto;
      /* Garantir que comece no topo */
      top: 0;
      transform: none;
    }
    
    #mainContainer {
      position: relative;
      margin-top: 0 !important;
      scroll-margin-top: 0;
      animation: fadeInUp 0.6s ease-out;
      top: 0;
    }
    
    /* Garantir que nenhum elemento empurre o wrap para baixo */
    body:not(.not-authenticated) .wrap {
      margin-top: 0 !important;
      padding-top: 20px !important;
      position: relative;
      top: 0 !important;
    }
    
    /* Garantir que o primeiro elemento vis√≠vel seja o wrap */
    body:not(.not-authenticated) > .wrap:first-of-type {
      margin-top: 0 !important;
    }
    
    /* Remover qualquer espa√ßo antes do wrap */
    body:not(.not-authenticated)::before {
      display: none !important;
    }
    
    /* Garantir que elementos fixos n√£o interfiram */
    #panelToggleHandle,
    #controlPanel,
    #bgMediaWrap,
    #bgOverlay {
      position: fixed !important;
      /* N√£o ocupam espa√ßo no fluxo do documento */
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .container {
      background: var(--glass);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      padding: 20px;
      border-radius: 14px;
      max-width: 1100px;
      width: 100%;
      box-shadow: 0 6px 30px rgba(0, 0, 0, .45);
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    h1 {
      font-family: Pacifico, cursive;
      font-size: clamp(1.9rem, 5vw, 2.6rem);
      text-align: center;
      color: #ffbfd0;
      margin: 18px 0;
      text-shadow: 0 0 12px rgba(255, 105, 180, .85)
    }

    .top {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap
    }

    .photo {
      width: 220px;
      min-width: 140px;
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid rgba(233, 30, 99, .9);
      flex-shrink: 0
    }

    .photo img {
      display: block;
      width: 100%;
      height: auto;
      cursor: pointer
    }

    .maincol {
      flex: 1;
      min-width: 260px
    }

    .message {
      font-weight: 600;
      font-size: 1.05rem;
      margin-bottom: 10px;
      white-space: pre-wrap;
      text-shadow: 0 0 8px rgba(0, 0, 0, .7)
    }

    /* controls */
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px
    }

    .btn {
      padding: 10px 14px;
      border-radius: 20px;
      border: none;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center
    }

    .btn {
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 10px 24px rgba(255, 80, 130, .3);
    }
    
    .btn:active {
      transform: translateY(-1px) scale(1.02);
    }

    .small {
      font-size: .9rem;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(0, 0, 0, .12)
    }

    /* spotify */
    .spotify-box {
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 18px rgba(0, 0, 0, .35);
      background: rgba(0, 0, 0, .15)
    }

    iframe.spotify-frame {
      width: 100%;
      height: 152px;
      border: none;
      border-radius: 12px
    }

    /* extra content area (collapsible) */
    #extraContent {
      margin-top: 18px;
      display: block;
      height: 0;
      overflow: hidden;
      transition: height .45s, opacity .35s;
      opacity: 0
    }

    #extraContent.open {
      height: auto;
      padding-top: 12px;
      opacity: 1
    }

    .extra-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.02));
      border-radius: 12px;
      border: 2px solid rgba(255, 128, 171, .12);
      cursor: pointer;
      overflow: hidden;
      transition: transform .22s, box-shadow .22s
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 34px rgba(0, 0, 0, .35)
    }

    .card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      display: block
    }

    .card .meta {
      padding: 8px 10px;
      font-size: .95rem;
      color: #ffeef6
    }

    /* modal - Enhanced lightbox */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .92);
      backdrop-filter: blur(8px);
      z-index: 1100;
      padding: 20px;
      opacity: 0;
      transition: opacity .3s ease;
    }

    .modal.open {
      display: flex;
      animation: modalFadeIn .3s ease forwards;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal .inner {
      position: relative;
      max-width: 95vw;
      max-height: 95vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal img {
      display: block;
      max-width: 90vw;
      max-height: 85vh;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
      transition: transform .3s ease;
      cursor: zoom-in;
    }

    .modal img.zoomed {
      cursor: zoom-out;
      max-width: none;
      max-height: none;
      width: auto;
      height: auto;
    }

    /* Modal controls */
    .modal-close,
    .modal-nav,
    .modal-download {
      position: fixed;
      background: rgba(255, 255, 255, .15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, .2);
      color: #fff;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .2s ease;
      font-size: 24px;
      z-index: 1101;
      user-select: none;
    }

    .modal-close:hover,
    .modal-nav:hover,
    .modal-download:hover {
      background: rgba(255, 255, 255, .25);
      transform: scale(1.1);
    }

    .modal-close {
      top: 20px;
      right: 20px;
    }

    .modal-nav {
      top: 50%;
      transform: translateY(-50%);
    }

    .modal-nav.prev {
      left: 20px;
    }

    .modal-nav.next {
      right: 20px;
    }

    .modal-download {
      bottom: 80px;
      right: 20px;
      border-radius: 12px;
      width: auto;
      padding: 0 16px;
      font-size: 16px;
    }

    /* Photo counter */
    .modal-counter {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(10px);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1101;
    }

    /* Loading indicator for modal */
    .modal-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 18px;
    }

    /* Form modals for messages and timeline */
    .form-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 20px;
    }

    .form-modal.open {
      display: flex;
      animation: modalFadeIn .3s ease forwards;
    }

    .form-modal-content {
      background: linear-gradient(135deg, rgba(255, 128, 171, 0.15), rgba(255, 79, 139, 0.1));
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 128, 171, 0.3);
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .form-modal-header {
      font-family: Pacifico, cursive;
      font-size: 1.8rem;
      color: #ffbfd0;
      text-align: center;
      margin-bottom: 24px;
      text-shadow: 0 0 12px rgba(255, 105, 180, .85);
    }

    .form-modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .form-modal-close:hover {
      background: rgba(255, 79, 139, 0.8);
      transform: rotate(90deg);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #ffbfd0;
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255, 128, 171, 0.3);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-1);
      box-shadow: 0 0 0 3px rgba(255, 128, 171, 0.2);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .form-modal-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .form-modal-actions .btn-submit {
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #fff;
    }

    .form-modal-actions .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 79, 139, 0.4);
    }

    .form-modal-actions .btn-cancel {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .form-modal-actions .btn-cancel:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* game */
    #gamePanel {
      margin-top: 16px;
      padding: 12px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .02));
      box-shadow: 0 8px 20px rgba(0, 0, 0, .18)
    }

    .game-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px
    }

    .game-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      max-width: 520px;
      margin: 0 auto
    }

    .tile {
      background: linear-gradient(180deg, #ffeef7, #ffd6e8);
      height: 84px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      cursor: pointer;
      user-select: none;
      transition: transform .18s
    }

    .tile.flipped {
      background: linear-gradient(180deg, #fff, #ffe6f0);
      transform: rotateY(0)
    }

    .tile.matched {
      background: linear-gradient(180deg, #ffecf4, #ffdbe8);
      cursor: default;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .12)
    }

    /* nav tabs - added visible contour/border & focus styles */
    .tabs {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      flex-wrap: wrap
    }

    .tab {
      background: rgba(255, 255, 255, 0.04);
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      border: 1px solid rgba(255, 128, 171, 0.12);
      transition: box-shadow .16s, transform .12s
    }

    .tab:hover {
      box-shadow: 0 6px 18px rgba(255, 128, 171, 0.06);
      transform: translateY(-2px)
    }

    .tab:focus {
      outline: 3px solid rgba(255, 128, 171, 0.22);
      outline-offset: 3px
    }

    .tab.active {
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      color: #fff
    }

    /* moodboard */
    #moodBoard {
      min-height: 220px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.06));
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
      position: relative;
      overflow: hidden
    }

    .sticker {
      width: 96px;
      height: 96px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      touch-action: none;
      cursor: grab;
      flex: 0 0 auto
    }

    .sticker img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    #boardCanvas {
      flex: 1;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(0, 0, 0, 0.05));
      min-height: 300px;
      position: relative;
      overflow: hidden
    }

    /* quiz */
    #quizPanel {
      padding: 12px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(0, 0, 0, 0.03))
    }

    .quiz-q {
      font-weight: 700;
      margin-bottom: 8px
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .option {
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.02)
    }

    /* badges & achievements */
    #achievements {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .badge {
      background: linear-gradient(90deg, #ffdce9, #ffe7f5);
      color: #6b0234;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      box-shadow: 0 6px 14px rgba(0, 0, 0, .1)
    }

    /* control panel collapsed state */
    #controlPanel {
      transition: transform .28s ease, opacity .28s ease;
      position: fixed;
      top: max(12px, env(safe-area-inset-top, 12px));
      left: max(12px, env(safe-area-inset-left, 12px));
      background: var(--control-bg);
      backdrop-filter: blur(6px);
      padding: 8px;
      border-radius: 10px;
      z-index: 10001;
      min-width: 280px;
      max-width: 85vw;
      box-shadow: 0 12px 30px rgba(0, 0, 0, .45);
    }

    #controlPanel.collapsed {
      transform: translateX(calc(-100% + 44px));
      opacity: 0.95
    }

    /* floating handle (always available) */
    #panelToggleHandle {
      position: fixed;
      top: max(12px, env(safe-area-inset-top, 12px));
      left: max(12px, env(safe-area-inset-left, 12px));
      z-index: 10002;
      padding: 8px 10px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #fff;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .35);
    }

    /* heart and confetti visual styles and animations */
    .heart {
      position: fixed;
      width: var(--size, 18px);
      height: var(--size, 18px);
      pointer-events: none;
      z-index: 10000;
      background: var(--color, #ff6aa6);
      transform: rotate(-45deg);
      opacity: var(--opacity, 1);
      animation: heart-rise var(--duration, 1.4s) cubic-bezier(.2, .9, .3, 1) forwards;
      display: block;
      left: 0;
      top: 0;
      border-radius: 4px;
    }

    .heart::before,
    .heart::after {
      content: "";
      position: absolute;
      width: 100%;
      height: 100%;
      background: inherit;
      border-radius: 50%;
    }

    .heart::before {
      top: -50%;
      left: 0;
    }

    .heart::after {
      left: 50%;
      top: 0;
    }

    @keyframes heart-rise {
      0% {
        transform: translateY(0) rotate(-45deg) scale(1);
        opacity: var(--opacity, 1);
      }

      30% {
        transform: translateY(-24px) rotate(-35deg) scale(1.05);
      }

      60% {
        transform: translateY(-70px) rotate(-25deg) scale(1.02);
        opacity: 0.9;
      }

      100% {
        transform: translateY(-140px) translateX(var(--windX, 0px)) rotate(-25deg) scale(0.98);
        opacity: 0;
      }
    }

    .confetti {
      position: fixed;
      width: 8px;
      height: 10px;
      pointer-events: none;
      z-index: 10000;
      background: currentColor;
      transform-origin: center;
      animation: confetti-fall 1.4s linear forwards;
      border-radius: 2px;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(0) rotate(0deg) scale(1);
        opacity: 1;
      }

      100% {
        transform: translateY(-160px) translateX(var(--cx, 0px)) rotate(360deg) scale(0.9);
        opacity: 0;
      }
    }

    /* simple cursor & effects (kept minimal) */
    .cursor {
      position: fixed;
      left: 0;
      top: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      mix-blend-mode: screen;
      transform: translate(-50%, -50%);
      transition: transform .12s
    }

    .cursor.big {
      width: 52px;
      height: 52px
    }

    .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      background: rgba(255, 255, 255, 0.25);
      pointer-events: none
    }

    @media(max-width:900px) {
      .top {
        flex-direction: column;
        align-items: center
      }

      .photo {
        width: 200px
      }

      .container {
        padding: 16px
      }
      
      #scrollToTop {
        bottom: 20px;
        right: 20px;
        width: 45px;
        height: 45px;
        font-size: 20px;
      }
    }

    @media(max-width:560px) {
      .game-board {
        grid-template-columns: repeat(2, 1fr)
      }

      .tile {
        height: 72px
      }
      
      .wrap {
        padding: 12px;
        padding-top: max(12px, env(safe-area-inset-top));
        padding-bottom: max(12px, env(safe-area-inset-bottom));
      }

      .container {
        padding: 14px;
        border-radius: 12px;
      }

      h1 {
        font-size: 1.6rem
      }
      
      #scrollToTop {
        bottom: 15px;
        right: 15px;
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
    }
    
    /* Melhorias de performance para dispositivos m√≥veis */
    @media (max-width: 768px) {
      .wrap {
        gap: 12px;
      }
      
      .container {
        padding: 16px;
      }
    }
    
    /* Otimiza√ß√£o para telas muito pequenas */
    @media (max-width: 360px) {
      .wrap {
        padding: 8px;
      }
      
      .container {
        padding: 12px;
      }
      
      h1 {
        font-size: 1.4rem;
        margin: 12px 0;
      }
    }

    /* Timeline Styles */
    .timeline-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }

    .timeline-item {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp .6s ease forwards;
    }

    .timeline-item:nth-child(even) {
      flex-direction: row-reverse;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .timeline-icon {
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(255, 128, 171, .3);
    }

    .timeline-content {
      flex: 1;
      background: rgba(255, 255, 255, .05);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 128, 171, .2);
    }

    .timeline-date {
      color: var(--accent-1);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .timeline-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .timeline-desc {
      font-size: 14px;
      opacity: .9;
    }

    /* Cards/Messages Styles */
    .envelope-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px 0;
    }

    .envelope {
      position: relative;
      width: 100%;
      aspect-ratio: 1.5;
      cursor: pointer;
      perspective: 1000px;
    }

    .envelope-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform .6s;
      transform-style: preserve-3d;
    }

    .envelope.opened .envelope-inner {
      transform: rotateY(180deg);
    }

    .envelope-front,
    .envelope-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
    }

    .envelope-front {
      background: linear-gradient(135deg, rgba(255, 180, 200, .2), rgba(255, 140, 170, .2));
      border: 2px solid rgba(255, 128, 171, .3);
    }

    .envelope-back {
      background: linear-gradient(135deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .05));
      border: 2px solid rgba(255, 128, 171, .2);
      transform: rotateY(180deg);
      font-size: 14px;
      line-height: 1.6;
    }

    .envelope-icon {
      font-size: 48px;
    }

    .envelope.read .envelope-front {
      opacity: .6;
    }

    /* Relationship Counter Styles */
    .counter-display {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .02));
      border-radius: 16px;
      margin: 20px 0;
    }

    .counter-numbers {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .counter-unit {
      text-align: center;
    }

    .counter-value {
      font-size: 48px;
      font-weight: 700;
      color: var(--accent-1);
      text-shadow: 0 0 20px rgba(255, 128, 171, .5);
      font-family: 'Courier New', monospace;
    }

    .counter-label {
      font-size: 14px;
      opacity: .8;
      margin-top: 4px;
    }

    .milestone {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      padding: 8px 16px;
      border-radius: 20px;
      margin: 8px 4px;
      font-size: 14px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    /* Date Ideas Generator */
    .idea-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .04));
      border: 2px solid rgba(255, 128, 171, .2);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }

    .idea-text {
      font-size: 20px;
      font-weight: 600;
      line-height: 1.6;
    }

    .idea-category {
      display: inline-block;
      background: rgba(255, 128, 171, .2);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(0, 0, 0, .9);
      backdrop-filter: blur(10px);
      color: #fff;
      padding: 16px 24px;
      border-radius: 12px;
      border: 1px solid rgba(255, 128, 171, .3);
      z-index: 10000;
      animation: slideInRight .3s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .3);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-color: #4caf50;
    }

    .toast.error {
      border-color: #f44336;
    }

    /* Skeleton Loaders */
    .skeleton {
      background: linear-gradient(90deg, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .1) 50%, rgba(255, 255, 255, .05) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes skeleton-loading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    /* Enhanced hover effects for cards */
    .card {
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255, 255, 255, .1));
      opacity: 0;
      transition: opacity .3s ease;
    }

    .card:hover::before {
      opacity: 1;
    }

    @media(prefers-reduced-motion:reduce) {
      * {
        animation: none !important;
        transition: none !important
      }
    }

    /* Login Screen Styles */
    #loginScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #ff80ab 0%, #ff4f8b 50%, #e91e63 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      animation: fadeIn 0.6s ease;
    }

    #loginScreen.hidden {
      display: none;
    }

    .login-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 40px 50px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
      animation: slideUp 0.8s cubic-bezier(0.2, 0.9, 0.3, 1);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-heart {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: heartBeat 1.5s ease-in-out infinite;
    }

    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.1); }
      50% { transform: scale(1); }
    }

    .login-title {
      font-family: Pacifico, cursive;
      font-size: 2rem;
      color: #e91e63;
      margin-bottom: 10px;
    }

    .login-subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 0.95rem;
    }

    .login-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ffb3d1;
      border-radius: 10px;
      font-size: 1rem;
      margin-bottom: 10px;
      transition: all 0.3s;
      font-family: Montserrat, sans-serif;
    }

    .login-input:focus {
      outline: none;
      border-color: #ff4f8b;
      box-shadow: 0 0 0 3px rgba(255, 79, 139, 0.1);
    }

    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #ff80ab, #ff4f8b);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: Montserrat, sans-serif;
      margin-top: 10px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 79, 139, 0.4);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-error {
      color: #f44336;
      margin-top: 15px;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .login-error.show {
      opacity: 1;
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* Toast Notification Styles */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(76, 175, 80, 0.95);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 100000;
      animation: toastSlideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }

    .toast.error {
      background: rgba(244, 67, 54, 0.95);
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(400px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes toastSlideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(400px);
      }
    }

    /* Hide main content until authenticated */
    body.not-authenticated #panelToggleHandle,
    body.not-authenticated #bgMediaWrap,
    body.not-authenticated #bgOverlay,
    body.not-authenticated #controlPanel,
    body.not-authenticated .wrap,
    body.not-authenticated #modal,
    body.not-authenticated #cursor {
      display: none !important;
    }

    /* PWA Native App Styling */
    @media (display-mode: standalone) {
      /* Hide scrollbars in standalone mode for native feel */
      ::-webkit-scrollbar {
        display: none;
      }
      
      html {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      
      /* Ensure proper display in standalone mode */
      body {
        min-height: 100vh;
        min-height: -webkit-fill-available;
      }
    }

    /* iOS PWA specific fixes */
    @supports (-webkit-touch-callout: none) {
      body {
        /* Fix iOS height issue with notch */
        min-height: -webkit-fill-available;
      }
    }
    
    /* Bot√£o de voltar ao topo */
    #scrollToTop {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: white;
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 9999;
      box-shadow: 0 4px 15px rgba(255, 80, 130, 0.4);
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateY(20px);
    }
    
    #scrollToTop.show {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }
    
    #scrollToTop:hover {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 6px 20px rgba(255, 80, 130, 0.6);
    }
    
    #scrollToTop:active {
      transform: translateY(-2px) scale(1.05);
    }
    
    /* Melhorias nas anima√ß√µes de entrada */
    .panel {
      animation: fadeIn 0.4s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Efeitos de hover melhorados para cards */
    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px) scale(1.02);
    }
    
    /* Melhorias nas tabs */
    .tab {
      transition: all 0.3s ease;
    }
    
    .tab:hover {
      transform: translateY(-2px);
    }
    
    /* Efeito de brilho nos elementos interativos */
    .btn, .card, .tab {
      position: relative;
      overflow: hidden;
    }
    
    .btn::before, .card::before, .tab::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }
    
    .btn:hover::before, .card:hover::before, .tab:hover::before {
      opacity: 1;
      animation: shine 1s ease-in-out;
    }
    
    @keyframes shine {
      0% {
        transform: translate(-50%, -50%) rotate(0deg);
      }
      100% {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }
    
    /* Melhorias de performance - will-change para elementos animados */
    .btn, .card, .tab, #scrollToTop {
      will-change: transform;
    }
  </style>
</head>

<body class="not-authenticated">
  <!-- Login Screen -->
  <div id="loginScreen">
    <div class="login-container">
      <div class="login-heart">üíñ</div>
      <h1 class="login-title">Bem-vindo(a)!</h1>
      <p class="login-subtitle">Digite a senha especial para continuar</p>
      <input 
        type="password" 
        id="loginPassword" 
        class="login-input" 
        placeholder="Senha do cora√ß√£o..." 
        autocomplete="off"
      />
      <button id="loginBtn" class="login-btn">Entrar üíï</button>
      <div id="loginError" class="login-error">Senha incorreta. Tente novamente!</div>
    </div>
  </div>

  <!-- Floating toggle handle: always available even if control panel is collapsed or off-screen -->
  <button id="panelToggleHandle" title="Mostrar / Esconder painel">‚ò∞</button>

  <div id="bgMediaWrap" aria-hidden="true">
    <video id="bgVideo" playsinline muted loop></video>
    <iframe id="bgYouTube" allow="autoplay; fullscreen"
      sandbox="allow-same-origin allow-scripts allow-presentation"></iframe>
  </div>
  <div id="bgOverlay"></div>

  <!-- Control panel -->
  <div id="controlPanel" aria-label="Painel de controle">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px">
      <div style="font-weight:700;font-size:.95rem">Painel de controle</div>
      <button id="logoutBtn" class="btn" style="padding:4px 8px;font-size:0.85rem;background:linear-gradient(135deg,#ff7676,#ffb199)" title="Sair">üö™ Sair</button>
    </div>
    <label style="display:block;font-weight:700;margin-bottom:6px">üåû Fundo Diurno</label>
    <input id="dayBgInput" placeholder="URL da imagem, .mp4 ou link YouTube"
      style="width:260px;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <label style="display:block;font-weight:700;margin-bottom:6px">üåô Fundo Noturno</label>
    <input id="nightBgInput" placeholder="URL da imagem, .mp4 ou link YouTube"
      style="width:260px;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <label style="display:block;font-weight:700;margin-bottom:6px">üéß Playlist Spotify</label>
    <input id="spotifyInput" placeholder="Cole o link da playlist (open.spotify.com/playlist/...)"
      style="width:260px;padding:6px;border-radius:6px;border:none;margin-bottom:8px" />
    <button id="loadPlaylistBtn" class="btn" style="width:100%;margin-bottom:6px">‚ñ∂Ô∏è Carregar Playlist</button>
    <div style="display:flex;gap:6px">
      <select id="decorationSelect" style="padding:6px;border-radius:6px;border:none">
        <option value="hearts">Cora√ß√µes</option>
        <option value="confetti">Confetti</option>
        <option value="none">Nenhum</option>
      </select>
      <button id="resetBtn" class="btn" style="background:linear-gradient(135deg,#ff7676,#ffb199)">Resetar</button>
    </div>
  </div>

  <div class="wrap">
    <div class="container" role="main" id="mainContainer">
      <div class="top">
        <figure class="photo"><img id="mainPhoto" loading="lazy" src="https://i.imgur.com/oK3x5BH.jpeg"
            alt="Nossa foto juntos" /></figure>
        <div class="maincol">
          <div class="message" id="message" aria-live="polite"></div>

          <!-- Global controls (moved out of playlist) -->
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:6px">
            <button id="darkModeBtn" class="btn">üåô Modo Noturno</button>
          </div>

          <div class="tabs" id="tabs">
            <div class="tab active" data-panel="panel-playlist">Playlist</div>
            <div class="tab" data-panel="panel-games">Jogos</div>
            <div class="tab" data-panel="panel-quiz">Quiz do Amor</div>
            <div class="tab" data-panel="panel-timeline">Nossa Hist√≥ria</div>
            <div class="tab" data-panel="panel-messages">Mensagens</div>
            <div class="tab" data-panel="panel-counter">Contador</div>
            <div class="tab" data-panel="panel-ideas">Date Ideas</div>
            <div class="tab" data-panel="panel-mood">Mood Board</div>
            <div class="tab" data-panel="panel-album">√Ålbum</div>
            <div class="tab" data-panel="panel-more">Mais</div>
          </div>

          <div id="panel-playlist" class="panel">
            <div class="controls">
              <button id="playBtn" class="btn">‚ñ∂Ô∏è Tocar Playlist</button>
            </div>

            <div class="spotify-box" id="spotifyBox" style="margin-top:12px">
              <div id="spotifyPlaceholder" style="padding:18px;text-align:center;color:#ffeeff">Playlist n√£o carregada
              </div>
            </div>
          </div>

          <div id="panel-games" class="panel" hidden>
            <div id="gamePanel" aria-hidden="true" style="display:block">
              <div class="game-header">
                <div style="font-weight:700">Cupid's Match ‚Äî Jogo da Mem√≥ria</div>
                <div class="small" id="gameInfo">Acertos: 0 | Tentativas: 0</div>
              </div>
              <div class="game-board" id="gameBoard" aria-live="polite"></div>
              <div style="text-align:center;margin-top:10px"><button id="restartGame" class="btn">üîÅ Reiniciar</button>
              </div>
            </div>
            <div style="margin-top:12px">
              <button id="startTicTac" class="btn">‚ùå‚≠ïÔ∏è Jogo da Velha (2 players)</button>
              <div id="ticTacToe"
                style="display:none;margin-top:10px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px">
                <div id="tttBoard" style="display:grid;grid-template-columns:repeat(3,70px);gap:6px"></div>
                <div style="margin-top:8px"><button id="resetTtt" class="btn">Resetar</button></div>
              </div>
            </div>
          </div>

          <div id="panel-quiz" class="panel" hidden>
            <div id="quizPanel">
              <div class="quiz-q" id="quizQuestion">Carregando quiz...</div>
              <div class="quiz-options" id="quizOptions"></div>
              <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                <button id="nextQ" class="btn" style="display:none">Pr√≥xima</button>
                <div id="quizScore" class="small">Pontua√ß√£o: 0</div>
                <div id="quizResult" class="small" style="margin-left:10px;display:none"></div>
              </div>
            </div>
          </div>

          <div id="panel-timeline" class="panel" hidden>
            <div style="margin-bottom:16px;text-align:center">
              <h2 style="font-family: Pacifico, cursive; color: #ffbfd0; margin-bottom:12px">Nossa Linha do Tempo üíï
              </h2>
              <button id="addTimelineBtn" class="btn">‚ûï Adicionar Momento</button>
            </div>
            <div id="timelineContainer" class="timeline-container"></div>
          </div>

          <div id="panel-messages" class="panel" hidden>
            <div style="margin-bottom:16px;text-align:center">
              <h2 style="font-family: Pacifico, cursive; color: #ffbfd0; margin-bottom:12px">Mensagens de Amor üíå</h2>
              <button id="addMessageBtn" class="btn">‚ûï Nova Mensagem</button>
            </div>
            <div id="envelopeGrid" class="envelope-grid"></div>
          </div>

          <div id="panel-counter" class="panel" hidden>
            <div style="margin-bottom:16px;text-align:center">
              <h2 style="font-family: Pacifico, cursive; color: #ffbfd0;">Juntos H√°... üíñ</h2>
            </div>
            <div class="counter-display">
              <div class="counter-numbers" id="counterDisplay"></div>
              <div style="margin-top:20px" id="milestones"></div>
            </div>
          </div>

          <div id="panel-ideas" class="panel" hidden>
            <div style="margin-bottom:16px;text-align:center">
              <h2 style="font-family: Pacifico, cursive; color: #ffbfd0; margin-bottom:12px">Ideias de Encontros üí°</h2>
            </div>
            <div class="idea-card">
              <div class="idea-category" id="ideaCategory">Romance</div>
              <div class="idea-text" id="ideaText">Clique no bot√£o para gerar uma ideia!</div>
              <button id="generateIdeaBtn" class="btn">üé≤ Nova Ideia</button>
            </div>
          </div>

          <div id="panel-album" class="panel" hidden>
            <div id="albumPanel" style="padding:8px;">
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
                <input id="albumFiles" type="file" accept="image/*" multiple />
                <button id="albumUploadBtn" class="btn">üì§ Enviar</button>
              </div>
              <div id="albumGrid"
                style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px"></div>
            </div>
          </div>

          <div id="panel-mood" class="panel" hidden>
            <div style="display:flex;gap:10px;align-items:flex-start">
              <div style="width:120px">
                <div style="font-weight:700;margin-bottom:6px">Adicione stickers</div>
                <div id="moodStickers" style="display:flex;flex-direction:column;gap:8px">
                  <!-- stickers injected -->
                </div>
                <div style="margin-top:8px">
                  <input id="uploadImage" type="file" accept="image/*" style="display:block" />
                </div>
              </div>
              <div id="boardCanvas" style="flex:1">
                <div id="moodBoard" style="height:360px;padding:12px"></div>
              </div>
            </div>
          </div>



          <div id="panel-more" class="panel" hidden>
            <div style="display:flex;flex-direction:column;gap:8px">
              <div style="font-weight:700">Conquistas</div>
              <div id="achievements"><!-- persisted badges will be injected --></div>
              <div style="margin-top:8px">
              </div>
            </div>
          </div>

        </div>
      </div>

      <div id="extraContent" aria-hidden="true">
        <div class="extra-grid" id="extraGrid"></div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="inner">
      <img id="modalImg" src="" alt="Imagem ampliada">
    </div>
    <div class="modal-close" id="modalClose" aria-label="Fechar">‚úï</div>
    <div class="modal-nav prev" id="modalPrev" aria-label="Foto anterior" style="display:none">‚Äπ</div>
    <div class="modal-nav next" id="modalNext" aria-label="Pr√≥xima foto" style="display:none">‚Ä∫</div>
    <div class="modal-download" id="modalDownload" style="display:none">‚¨á Download</div>
    <div class="modal-counter" id="modalCounter" style="display:none"></div>
  </div>

  <!-- Message Modal -->
  <div id="messageModal" class="form-modal">
    <div class="form-modal-content">
      <button class="form-modal-close" id="messageModalClose" aria-label="Fechar">‚úï</button>
      <h3 class="form-modal-header">üíå Nova Mensagem</h3>
      <form id="messageForm">
        <div class="form-group">
          <label for="newMessageContent">Mensagem de Amor</label>
          <textarea id="newMessageContent" placeholder="Escreva sua mensagem aqui..." required></textarea>
        </div>
        <div class="form-modal-actions">
          <button type="button" class="btn-cancel" id="messageModalCancel">Cancelar</button>
          <button type="submit" class="btn-submit">üíï Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Timeline Modal -->
  <div id="timelineModal" class="form-modal">
    <div class="form-modal-content">
      <button class="form-modal-close" id="timelineModalClose" aria-label="Fechar">‚úï</button>
      <h3 class="form-modal-header">‚ú® Novo Momento</h3>
      <form id="timelineForm">
        <div class="form-group">
          <label for="timelineDate">Data</label>
          <input type="date" id="timelineDate" required />
        </div>
        <div class="form-group">
          <label for="timelineTitle">T√≠tulo</label>
          <input type="text" id="timelineTitle" placeholder="Ex: Primeiro Encontro" required />
        </div>
        <div class="form-group">
          <label for="timelineDesc">Descri√ß√£o</label>
          <textarea id="timelineDesc" placeholder="Descreva este momento especial..."></textarea>
        </div>
        <div class="form-group">
          <label for="timelineIcon">Emoji (opcional)</label>
          <input type="text" id="timelineIcon" placeholder="üíñ" maxlength="2" />
        </div>
        <div class="form-modal-actions">
          <button type="button" class="btn-cancel" id="timelineModalCancel">Cancelar</button>
          <button type="submit" class="btn-submit">‚ú® Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="cursor" class="cursor" aria-hidden="true">
    <div class="trail"></div>
    <div class="core"></div>
  </div>

  <script>

    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    /* ========================================
       AUTHENTICATION SYSTEM
       ======================================== */
    
    // Configurable password - change this to your special date or word
    const AUTH_PASSWORD = "23092023"; // Change this to your relationship date or special word
    
    // Storage keys for data persistence
    const STORAGE_KEYS = {
      auth: 'loveu_authenticated',
      timeline: 'loveu_timeline',
      messages: 'loveu_messages',
      settings: 'loveu_settings',
      gameProgress: 'loveu_game',
      moodboard: 'loveu_moodboard'
    };

    // Check if user is already authenticated
    function checkAuth() {
      try {
        // Check localStorage for persistent auth (stays even after closing browser)
        return localStorage.getItem(STORAGE_KEYS.auth) === 'true';
      } catch (e) {
        return false;
      }
    }

    // Set authentication state
    function setAuth(isAuth) {
      try {
        if (isAuth) {
          // Use localStorage instead of sessionStorage for persistent login
          localStorage.setItem(STORAGE_KEYS.auth, 'true');
        } else {
          localStorage.removeItem(STORAGE_KEYS.auth);
        }
      } catch (e) {
        console.error('setAuth error', e);
      }
    }



    // Handle login
    function handleLogin() {
      const passwordInput = document.getElementById('loginPassword');
      const errorDiv = document.getElementById('loginError');
      const loginScreen = document.getElementById('loginScreen');
      const password = passwordInput.value;

      if (password === AUTH_PASSWORD) {
        // Correct password
        errorDiv.classList.remove('show');
        setAuth(true);
        
        // Animate login screen out
        loginScreen.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => {
          loginScreen.classList.add('hidden');
          document.body.classList.remove('not-authenticated');
          showToast('Bem-vindo(a) de volta! üíñ');
          loadAllData();
          
          // FOR√áAR scroll para o topo ap√≥s login
          setTimeout(() => {
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            const wrap = document.querySelector('.wrap');
            if (wrap) {
              wrap.scrollIntoView({ behavior: 'instant', block: 'start' });
            }
          }, 100);
        }, 500);
      } else {
        // Wrong password
        errorDiv.classList.add('show');
        passwordInput.value = '';
        passwordInput.focus();
        
        // Shake animation
        setTimeout(() => {
          errorDiv.classList.remove('show');
        }, 3000);
      }
    }

    // Add fadeOut animation
    const style = document.createElement('style');
    style.textContent = '@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }';
    document.head.appendChild(style);

    // Handle logout
    function handleLogout() {
      if (confirm('Tem certeza que deseja sair?')) {
        setAuth(false);
        location.reload();
      }
    }

    // Initialize authentication
    function initAuth() {
      const loginBtn = document.getElementById('loginBtn');
      const loginPassword = document.getElementById('loginPassword');
      const logoutBtn = document.getElementById('logoutBtn');
      const loginScreen = document.getElementById('loginScreen');

      // Check if already authenticated
      if (checkAuth()) {
        loginScreen.classList.add('hidden');
        document.body.classList.remove('not-authenticated');
        loadAllData();
      } else {
        // Focus password input
        setTimeout(() => loginPassword.focus(), 300);
      }

      // Login button click
      if (loginBtn) {
        loginBtn.addEventListener('click', handleLogin);
      }

      // Enter key on password input
      if (loginPassword) {
        loginPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleLogin();
          }
        });
      }

      // Logout button
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }
    }

    /* ========================================
       DATA PERSISTENCE SYSTEM
       ======================================== */

    // Save data to localStorage
    function saveData(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
        return true;
      } catch (e) {
        console.error('saveData error', e);
        return false;
      }
    }

    // Load data from localStorage
    function loadData(key, defaultValue = null) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : defaultValue;
      } catch (e) {
        console.error('loadData error', e);
        return defaultValue;
      }
    }

    // Load all persisted data
    function loadAllData() {
      loadTimelineData();
      loadMessagesData();
      loadSettingsData();
    }

    // Timeline and Messages will use their own existing localStorage keys
    // We just need to integrate the toast notifications
    function loadTimelineData() {
      // Timeline already loads from 'TIMELINE_EVENTS' in initTimeline
    }

    function loadMessagesData() {
      // Messages already load from 'LOVE_MESSAGES' in initMessages
    }

    // Save and load settings (backgrounds, playlist)
    function loadSettingsData() {
      const settings = loadData(STORAGE_KEYS.settings, null);
      if (settings) {
        if (settings.dayBg) document.getElementById('dayBgInput').value = settings.dayBg;
        if (settings.nightBg) document.getElementById('nightBgInput').value = settings.nightBg;
        if (settings.spotifyUrl) document.getElementById('spotifyInput').value = settings.spotifyUrl;
        if (settings.decoration) document.getElementById('decorationSelect').value = settings.decoration;
      }
    }

    function saveSettingsData() {
      const settings = {
        dayBg: document.getElementById('dayBgInput').value,
        nightBg: document.getElementById('nightBgInput').value,
        spotifyUrl: document.getElementById('spotifyInput').value,
        decoration: document.getElementById('decorationSelect').value
      };
      saveData(STORAGE_KEYS.settings, settings);
    }

    // Auto-save settings when changed
    function initAutoSaveSettings() {
      const inputs = ['dayBgInput', 'nightBgInput', 'spotifyInput', 'decorationSelect'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', () => {
            saveSettingsData();
            showToast('Configura√ß√µes salvas! ‚öôÔ∏è');
          });
        }
      });
    }

    // Initialize authentication on page load
    document.addEventListener('DOMContentLoaded', () => {
      initAuth();
      initAutoSaveSettings();
      
      // FOR√áAR scroll para o topo imediatamente
      window.scrollTo(0, 0);
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      
      // Garantir que o mainContainer fique vis√≠vel no topo
      const mainContainer = document.getElementById('mainContainer');
      const wrap = document.querySelector('.wrap');
      if (mainContainer && wrap) {
        // Resetar qualquer posicionamento
        wrap.style.marginTop = '0';
        wrap.style.paddingTop = '20px';
        mainContainer.style.marginTop = '0';
        
        // For√ßar scroll para o topo
        setTimeout(() => {
          window.scrollTo(0, 0);
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
          wrap.scrollIntoView({ behavior: 'instant', block: 'start' });
        }, 0);
        
        // Tentar novamente ap√≥s um pequeno delay
        setTimeout(() => {
          window.scrollTo(0, 0);
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
        }, 100);
      }
    });
    
    // Garantir scroll para o topo quando a p√°gina √© inspecionada ou recarregada
    window.addEventListener('load', () => {
      window.scrollTo(0, 0);
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      
      const wrap = document.querySelector('.wrap');
      if (wrap) {
        wrap.scrollIntoView({ behavior: 'instant', block: 'start' });
      }
      
      // For√ßar novamente ap√≥s load completo
      setTimeout(() => {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      }, 50);
    });
    
    // Interceptar mudan√ßas de scroll e for√ßar topo se necess√°rio
    let lastScrollTop = 0;
    window.addEventListener('scroll', () => {
      const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      
      // Se detectar scroll para baixo logo ap√≥s carregar, for√ßar topo
      if (currentScroll > 50 && lastScrollTop === 0) {
        setTimeout(() => {
          window.scrollTo(0, 0);
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
        }, 10);
      }
      
      lastScrollTop = currentScroll;
    }, { passive: true });

    /* Typing message */
    const messageEl = document.getElementById('message');
    const text = "AMOOR DA MINHA VIDA, MINHA GATINHAA üí´";
    (function typewriter() { let i = 0; function step() { if (i < text.length) { if (messageEl) messageEl.textContent += text.charAt(i++); setTimeout(step, 70); } } step(); })();

    /* Defaults */
    const DEFAULT_SPOTIFY_URL = 'https://open.spotify.com/playlist/3AlzaL3fuUAtulQFklJy8v?si=_5BzUq0CQ_WDlL31eLaUcg';

    /* --- Achievements persistence --- */
    function loadAchievements() {
      try {
        const raw = localStorage.getItem('ACHIEVEMENTS');
        const arr = raw ? JSON.parse(raw) : [];
        const holder = document.getElementById('achievements');
        if (!holder) return;
        holder.innerHTML = '';
        arr.forEach(name => {
          const s = document.createElement('span'); s.className = 'badge'; s.textContent = name;
          holder.appendChild(s);
        });
      } catch (e) { console.error('loadAchievements', e); }
    }
    function persistAchievements(list) {
      try { localStorage.setItem('ACHIEVEMENTS', JSON.stringify(list)); } catch (e) { }
    }
    function addAchievement(name) {
      try {
        const holder = document.getElementById('achievements');
        if (!holder) return;
        // avoid duplicates in UI and storage
        const exists = Array.from(holder.children).some(b => b.textContent === name);
        if (exists) return;
        const span = document.createElement('span'); span.className = 'badge'; span.textContent = name;
        holder.appendChild(span);
        // persist
        let cur = [];
        try { cur = JSON.parse(localStorage.getItem('ACHIEVEMENTS') || '[]'); } catch (e) { cur = []; }
        if (!cur.includes(name)) { cur.push(name); persistAchievements(cur); }
        // transient highlight
        setTimeout(() => span.classList.add('fade'), 3500);
      } catch (e) { console.error('addAchievement error', e); }
    }

    /* YouTube helpers */
    function parseYouTubeUrl(url) {
      if (!url) return null;
      try {
        const u = new URL(url, location.href);
        const hostname = u.hostname.replace('www.', '');
        if (hostname === 'youtu.be') {
          const vid = u.pathname.slice(1).split('/')[0];
          if (vid) return { type: 'video', id: vid };
        }
        if (hostname.includes('youtube.com') || hostname.includes('youtube-nocookie.com')) {
          if (u.pathname.startsWith('/playlist') && u.searchParams.get('list')) return { type: 'playlist', id: u.searchParams.get('list') };
          if (u.searchParams.get('v')) {
            const vid = u.searchParams.get('v'); const list = u.searchParams.get('list');
            if (list) return { type: 'playlist', id: list };
            return { type: 'video', id: vid };
          }
          const parts = u.pathname.split('/');
          const shortsIdx = parts.indexOf('shorts');
          if (shortsIdx >= 0 && parts[shortsIdx + 1]) return { type: 'video', id: parts[shortsIdx + 1] };
          if (u.pathname.startsWith('/embed/')) return { type: 'video', id: u.pathname.split('/embed/')[1].split('/')[0] };
        }
        if (u.searchParams.get('list')) return { type: 'playlist', id: u.searchParams.get('list') };
      } catch (e) { /* ignore */ }
      return null;
    }
    function isVideoUrl(url) { return url && url.split('?')[0].toLowerCase().endsWith('.mp4'); }

    /* ===== PERFORMANCE OPTIMIZATIONS ===== */

    // Debounce function for scroll/resize events
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Throttle function for high-frequency events
    function throttle(func, limit) {
      let inThrottle;
      return function (...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }

    // Lazy loading with Intersection Observer
    function initLazyLoading() {
      if (!('IntersectionObserver' in window)) {
        // Fallback for browsers without IntersectionObserver
        return;
      }

      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
              img.classList.remove('skeleton');
              observer.unobserve(img);
            }
          }
        });
      }, {
        rootMargin: '50px' // Start loading 50px before the image enters viewport
      });

      // Observe all images with data-src attribute
      document.querySelectorAll('img[data-src]').forEach(img => {
        imageObserver.observe(img);
      });

      return imageObserver;
    }

    // Optimize decoration particles based on device performance
    function getOptimizedParticleCount() {
      // Reduce particles on mobile or low-end devices
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const hasReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      if (hasReducedMotion) return 0;
      if (isMobile) return 3; // Fewer particles on mobile

      // Check for hardware concurrency (number of CPU cores)
      const cores = navigator.hardwareConcurrency || 4;
      if (cores <= 2) return 4;

      return 6; // Default for desktop
    }

    // Cleanup old decorations to prevent memory leaks
    function cleanupDecorations() {
      const decorations = document.querySelectorAll('.heart, .confetti');
      decorations.forEach(el => {
        // Check if animation has ended
        const computedStyle = window.getComputedStyle(el);
        const opacity = parseFloat(computedStyle.opacity);
        if (opacity < 0.1 || el.getBoundingClientRect().top < -200) {
          el.remove();
        }
      });
    }

    // Run cleanup periodically
    if (!prefersReduced) {
      setInterval(cleanupDecorations, 5000);
    }

    /* ===== ENHANCED MODAL/LIGHTBOX ===== */
    let currentImageIndex = 0;
    let albumImages = [];
    let isModalZoomed = false;

    // Helper function to show toast notifications
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const isError = type === 'error' || type === false;
      toast.className = 'toast' + (isError ? ' error' : '');
      toast.innerHTML = `<span>${isError ? '‚ùå' : '‚úì'}</span><span>${message}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'toastSlideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function openModal(src, alt = '', imagesList = []) {
      const modal = document.getElementById('modal');
      const img = document.getElementById('modalImg');
      const counter = document.getElementById('modalCounter');
      const prev = document.getElementById('modalPrev');
      const next = document.getElementById('modalNext');
      const download = document.getElementById('modalDownload');

      if (!modal || !img) return;

      // Set up images array for navigation
      albumImages = imagesList.length > 0 ? imagesList : [{ src, alt }];
      currentImageIndex = albumImages.findIndex(item => item.src === src);
      if (currentImageIndex === -1) currentImageIndex = 0;

      img.src = src;
      img.alt = alt || 'Imagem ampliada';
      isModalZoomed = false;
      img.classList.remove('zoomed');

      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden'; // Prevent background scroll

      // Show/hide navigation based on number of images
      if (albumImages.length > 1) {
        prev.style.display = 'flex';
        next.style.display = 'flex';
        counter.style.display = 'block';
        counter.textContent = `${currentImageIndex + 1} / ${albumImages.length}`;
      } else {
        prev.style.display = 'none';
        next.style.display = 'none';
        counter.style.display = 'none';
      }

      download.style.display = 'flex';
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      if (!modal) return;

      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = ''; // Restore scroll
      isModalZoomed = false;
    }

    function navigateModal(direction) {
      if (albumImages.length <= 1) return;

      currentImageIndex += direction;
      if (currentImageIndex < 0) currentImageIndex = albumImages.length - 1;
      if (currentImageIndex >= albumImages.length) currentImageIndex = 0;

      const img = document.getElementById('modalImg');
      const counter = document.getElementById('modalCounter');
      const item = albumImages[currentImageIndex];

      if (img && item) {
        img.style.opacity = '0';
        setTimeout(() => {
          img.src = item.src;
          img.alt = item.alt || 'Imagem ampliada';
          img.style.opacity = '1';
          isModalZoomed = false;
          img.classList.remove('zoomed');
        }, 150);
      }

      if (counter) {
        counter.textContent = `${currentImageIndex + 1} / ${albumImages.length}`;
      }
    }

    function toggleZoom() {
      const img = document.getElementById('modalImg');
      if (!img) return;

      isModalZoomed = !isModalZoomed;
      if (isModalZoomed) {
        img.classList.add('zoomed');
      } else {
        img.classList.remove('zoomed');
      }
    }

    function downloadCurrentImage() {
      const img = document.getElementById('modalImg');
      if (!img || !img.src) return;

      const link = document.createElement('a');
      link.href = img.src;
      link.download = img.alt || 'photo.jpg';
      link.click();
      showToast('Download iniciado!');
    }

    // Modal event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('modal');
      const modalClose = document.getElementById('modalClose');
      const modalPrev = document.getElementById('modalPrev');
      const modalNext = document.getElementById('modalNext');
      const modalDownload = document.getElementById('modalDownload');
      const modalImg = document.getElementById('modalImg');

      // Close button
      if (modalClose) {
        modalClose.addEventListener('click', closeModal);
      }

      // Navigation buttons
      if (modalPrev) {
        modalPrev.addEventListener('click', (e) => {
          e.stopPropagation();
          navigateModal(-1);
        });
      }

      if (modalNext) {
        modalNext.addEventListener('click', (e) => {
          e.stopPropagation();
          navigateModal(1);
        });
      }

      // Download button
      if (modalDownload) {
        modalDownload.addEventListener('click', (e) => {
          e.stopPropagation();
          downloadCurrentImage();
        });
      }

      // Zoom on image click
      if (modalImg) {
        modalImg.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleZoom();
        });
      }

      // Close on background click
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });
      }

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!modal || !modal.classList.contains('open')) return;

        switch (e.key) {
          case 'Escape':
            closeModal();
            break;
          case 'ArrowLeft':
            navigateModal(-1);
            break;
          case 'ArrowRight':
            navigateModal(1);
            break;
        }
      });

      // Touch swipe support for mobile
      let touchStartX = 0;
      let touchEndX = 0;

      if (modal) {
        modal.addEventListener('touchstart', (e) => {
          touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        modal.addEventListener('touchend', (e) => {
          touchEndX = e.changedTouches[0].screenX;
          handleSwipe();
        }, { passive: true });
      }

      function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
          if (diff > 0) {
            navigateModal(1); // Swipe left - next image
          } else {
            navigateModal(-1); // Swipe right - previous image
          }
        }
      }
    });

    /* ===== TIMELINE FEATURE WITH FIREBASE ===== */
    function initTimeline() {
      const container = document.getElementById('timelineContainer');
      const addBtn = document.getElementById('addTimelineBtn');
      const hoje = new Date();
      const hojeStr = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}-${String(hoje.getDate()).padStart(2, '0')}`;

      if (!container) return;

      // Check if Firebase is available
      const useFirebase = typeof firebase !== 'undefined' && firebase.firestore;

      function formatDate(dateStr) {
        const [year, month, day] = dateStr.split('-');
        const date = new Date(year, month - 1, day);
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
      }

      function renderTimelineItem(docId, item, index) {
        const div = document.createElement('div');
        div.className = 'timeline-item';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
          <div class="timeline-icon">${item.icon}</div>
          <div class="timeline-content">
            <div class="timeline-date">${formatDate(item.date)}</div>
            <div class="timeline-title">${item.title}</div>
            <div class="timeline-desc">${item.desc}</div>
          </div>
        `;
        return div;
      }

      if (useFirebase) {
        // Firebase Firestore implementation
        const db = firebase.firestore();
        
        // Real-time listener for timeline events
        db.collection('timeline').orderBy('date', 'asc').onSnapshot(snapshot => {
          container.innerHTML = '';
          
          // If no events exist, add default ones
          if (snapshot.empty) {
            const defaultEvents = [
              { date: '2023-08-04', title: 'Primeiro Beijo', desc: 'Um momento m√°gico üíã', icon: 'üòò' },
              { date: '2023-08-06', title: 'Primeiro Encontro', desc: 'O in√≠cio de tudo ‚ù§Ô∏è', icon: 'üíï' },
              { date: hojeStr, title: 'Hoje', desc: 'Cada dia mais apaixonados', icon: 'üåü' }
            ];
            
            // Add default events to Firestore
            defaultEvents.forEach(event => {
              db.collection('timeline').add({
                ...event,
                ts: firebase.firestore.FieldValue.serverTimestamp()
              }).catch(err => console.error('Error adding default timeline event:', err));
            });
          } else {
            snapshot.forEach((doc, index) => {
              const data = doc.data();
              const el = renderTimelineItem(doc.id, data, index);
              container.appendChild(el);
            });
          }
        }, err => {
          console.error('Error listening to timeline:', err);
          // Fallback to localStorage
          initTimelineLocalStorage();
        });

        // Add button handler for Firebase - open modal
        if (addBtn) {
          addBtn.addEventListener('click', () => {
            const modal = document.getElementById('timelineModal');
            if (modal) modal.classList.add('open');
          });
        }

        // Setup timeline modal handlers
        const timelineModal = document.getElementById('timelineModal');
        const timelineForm = document.getElementById('timelineForm');
        const timelineModalClose = document.getElementById('timelineModalClose');
        const timelineModalCancel = document.getElementById('timelineModalCancel');

        if (timelineModalClose) {
          timelineModalClose.addEventListener('click', () => {
            timelineModal.classList.remove('open');
          });
        }

        if (timelineModalCancel) {
          timelineModalCancel.addEventListener('click', () => {
            timelineModal.classList.remove('open');
          });
        }

        if (timelineForm) {
          timelineForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const date = document.getElementById('timelineDate').value;
            const title = document.getElementById('timelineTitle').value.trim();
            const desc = document.getElementById('timelineDesc').value.trim();
            const icon = document.getElementById('timelineIcon').value.trim() || 'üíñ';

            if (!date || !title) {
              showToast('Por favor, preencha data e t√≠tulo!', 'error');
              return;
            }

            try {
              await db.collection('timeline').add({
                date,
                title,
                desc: desc || '',
                icon,
                ts: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              showToast('Evento adicionado √† timeline! ‚ú®', 'success');
              timelineForm.reset();
              timelineModal.classList.remove('open');
            } catch (err) {
              console.error('Error adding timeline event:', err);
              showToast('Erro ao adicionar evento. Verifique as permiss√µes.', 'error');
            }
          });
        }
      } else {
        // Fallback to localStorage
        initTimelineLocalStorage();
      }

      function initTimelineLocalStorage() {
        let timeline = [];
        try {
          const saved = localStorage.getItem('TIMELINE_EVENTS');
          timeline = saved ? JSON.parse(saved) : [
            { date: '2023-08-04', title: 'Primeiro Beijo', desc: 'Um momento m√°gico üíã', icon: 'üòò' },
            { date: '2023-08-06', title: 'Primeiro Encontro', desc: 'O in√≠cio de tudo ‚ù§Ô∏è', icon: 'üíï' },
            { date: hojeStr, title: 'Hoje', desc: 'Cada dia mais apaixonados', icon: 'üåü' }
          ];
        } catch (e) {
          timeline = [];
        }

        function renderTimeline() {
          container.innerHTML = '';
          timeline.sort((a, b) => new Date(a.date) - new Date(b.date));
          timeline.forEach((item, index) => {
            const el = renderTimelineItem(null, item, index);
            container.appendChild(el);
          });
        }

        function saveTimeline() {
          try {
            localStorage.setItem('TIMELINE_EVENTS', JSON.stringify(timeline));
          } catch (e) {
            console.error('Failed to save timeline', e);
          }
        }

        if (addBtn) {
          addBtn.addEventListener('click', () => {
            const modal = document.getElementById('timelineModal');
            if (modal) modal.classList.add('open');
          });
        }

        // Setup timeline modal handlers for localStorage
        const timelineModal = document.getElementById('timelineModal');
        const timelineForm = document.getElementById('timelineForm');
        const timelineModalClose = document.getElementById('timelineModalClose');
        const timelineModalCancel = document.getElementById('timelineModalCancel');

        if (timelineModalClose) {
          timelineModalClose.addEventListener('click', () => {
            timelineModal.classList.remove('open');
          });
        }

        if (timelineModalCancel) {
          timelineModalCancel.addEventListener('click', () => {
            timelineModal.classList.remove('open');
          });
        }

        if (timelineForm) {
          timelineForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const date = document.getElementById('timelineDate').value;
            const title = document.getElementById('timelineTitle').value.trim();
            const desc = document.getElementById('timelineDesc').value.trim();
            const icon = document.getElementById('timelineIcon').value.trim() || 'üíñ';

            if (!date || !title) {
              showToast('Por favor, preencha data e t√≠tulo!', 'error');
              return;
            }

            timeline.push({ date, title, desc: desc || '', icon });
            saveTimeline();
            renderTimeline();
            showToast('Evento adicionado √† timeline! ‚ú®', 'success');
            timelineForm.reset();
            timelineModal.classList.remove('open');
          });
        }

        renderTimeline();
      }
    }

    /* ===== MESSAGES/ENVELOPES FEATURE WITH FIREBASE ===== */
    function initMessages() {
      const grid = document.getElementById('envelopeGrid');
      const addBtn = document.getElementById('addMessageBtn');

      if (!grid) return;

      // Check if Firebase is available
      const useFirebase = typeof firebase !== 'undefined' && firebase.firestore;

      function renderMessageItem(docId, msg, index) {
        const div = document.createElement('div');
        div.className = `envelope ${msg.read ? 'read' : ''}`;
        
        // Check if this envelope was already opened (persisted in localStorage)
        const openedKey = useFirebase ? `OPENED_MSG_${docId}` : `OPENED_MSG_IDX_${index}`;
        const wasOpened = localStorage.getItem(openedKey) === 'true';
        if (wasOpened) {
          div.classList.add('opened');
        }
        
        div.innerHTML = `
          <div class="envelope-inner">
            <div class="envelope-front">
              <div class="envelope-icon">üíå</div>
            </div>
            <div class="envelope-back">${msg.text}</div>
          </div>
        `;

        div.addEventListener('click', () => {
          // Once opened, stay opened
          if (!div.classList.contains('opened')) {
            div.classList.add('opened');
            // Persist opened state
            try {
              localStorage.setItem(openedKey, 'true');
            } catch (e) {
              console.error('Failed to save opened state:', e);
            }
          }
          
          if (!msg.read && useFirebase && docId) {
            // Update read status in Firebase
            const db = firebase.firestore();
            db.collection('messages').doc(docId).update({
              read: true
            }).catch(err => console.error('Error updating message:', err));
          } else if (!msg.read && !useFirebase) {
            // Update in localStorage
            msg.read = true;
            div.classList.add('read');
          }
        });

        return div;
      }

      if (useFirebase) {
        // Firebase Firestore implementation
        const db = firebase.firestore();
        
        // Real-time listener for messages
        db.collection('messages').orderBy('ts', 'asc').onSnapshot(snapshot => {
          grid.innerHTML = '';
          
          // If no messages exist, add default ones
          if (snapshot.empty) {
            const defaultMessages = [
              { text: 'Voc√™ √© a melhor coisa que j√° me aconteceu! üíï', read: false },
              { text: 'Cada dia ao seu lado √© uma b√™n√ß√£o ‚ú®', read: false },
              { text: 'Meu amor por voc√™ cresce a cada segundo üíó', read: false },
              { text: 'Obrigado por ser minha felicidade üåà', read: false }
            ];
            
            // Add default messages to Firestore
            defaultMessages.forEach(msg => {
              db.collection('messages').add({
                ...msg,
                ts: firebase.firestore.FieldValue.serverTimestamp()
              }).catch(err => console.error('Error adding default message:', err));
            });
          } else {
            snapshot.forEach((doc, index) => {
              const data = doc.data();
              const el = renderMessageItem(doc.id, data, index);
              grid.appendChild(el);
            });
          }
        }, err => {
          console.error('Error listening to messages:', err);
          // Fallback to localStorage
          initMessagesLocalStorage();
        });

        // Add button handler for Firebase - open modal
        if (addBtn) {
          addBtn.addEventListener('click', () => {
            const modal = document.getElementById('messageModal');
            if (modal) modal.classList.add('open');
          });
        }

        // Setup message modal handlers
        const messageModal = document.getElementById('messageModal');
        const messageForm = document.getElementById('messageForm');
        const messageModalClose = document.getElementById('messageModalClose');
        const messageModalCancel = document.getElementById('messageModalCancel');

        if (messageModalClose) {
          messageModalClose.addEventListener('click', () => {
            messageModal.classList.remove('open');
          });
        }

        if (messageModalCancel) {
          messageModalCancel.addEventListener('click', () => {
            messageModal.classList.remove('open');
          });
        }

        if (messageForm) {
          messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const content = document.getElementById('newMessageContent').value.trim();
            if (!content) {
              showToast('Por favor, escreva uma mensagem!', 'error');
              return;
            }

            try {
              await db.collection('messages').add({
                text: content,
                read: false,
                ts: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              showToast('Mensagem adicionada com sucesso! üíå', 'success');
              messageForm.reset();
              messageModal.classList.remove('open');
            } catch (err) {
              console.error('Error adding message:', err);
              showToast('Erro ao adicionar mensagem. Verifique as permiss√µes.', 'error');
            }
          });
        }
      } else {
        // Fallback to localStorage
        initMessagesLocalStorage();
      }

      function initMessagesLocalStorage() {
        let messages = [];
        try {
          const saved = localStorage.getItem('LOVE_MESSAGES');
          messages = saved ? JSON.parse(saved) : [
            { text: 'Voc√™ √© a melhor coisa que j√° me aconteceu! üíï', read: false },
            { text: 'Cada dia ao seu lado √© uma b√™n√ß√£o ‚ú®', read: false },
            { text: 'Meu amor por voc√™ cresce a cada segundo üíó', read: false },
            { text: 'Obrigado por ser minha felicidade üåà', read: false }
          ];
        } catch (e) {
          messages = [];
        }

        function renderMessages() {
          grid.innerHTML = '';
          messages.forEach((msg, index) => {
            const el = renderMessageItem(null, msg, index);
            
            // Add localStorage save on click
            el.addEventListener('click', () => {
              if (!msg.read) {
                msg.read = true;
                el.classList.add('read');
                saveMessages();
              }
            });
            
            grid.appendChild(el);
          });
        }

        function saveMessages() {
          try {
            localStorage.setItem('LOVE_MESSAGES', JSON.stringify(messages));
          } catch (e) {
            console.error('Failed to save messages', e);
          }
        }

        if (addBtn) {
          addBtn.addEventListener('click', () => {
            const modal = document.getElementById('messageModal');
            if (modal) modal.classList.add('open');
          });
        }

        // Setup message modal handlers for localStorage
        const messageModal = document.getElementById('messageModal');
        const messageForm = document.getElementById('messageForm');
        const messageModalClose = document.getElementById('messageModalClose');
        const messageModalCancel = document.getElementById('messageModalCancel');

        if (messageModalClose) {
          messageModalClose.addEventListener('click', () => {
            messageModal.classList.remove('open');
          });
        }

        if (messageModalCancel) {
          messageModalCancel.addEventListener('click', () => {
            messageModal.classList.remove('open');
          });
        }

        if (messageForm) {
          messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const content = document.getElementById('newMessageContent').value.trim();
            if (!content) {
              showToast('Por favor, escreva uma mensagem!', 'error');
              return;
            }

            messages.push({ text: content, read: false });
            saveMessages();
            renderMessages();
            showToast('Mensagem adicionada com sucesso! üíå', 'success');
            messageForm.reset();
            messageModal.classList.remove('open');
          });
        }

        renderMessages();
      }
    }

    /* ===== RELATIONSHIP COUNTER ===== */
    function initCounter() {
      const display = document.getElementById('counterDisplay');
      const milestones = document.getElementById('milestones');

      if (!display) return;

      // Set your relationship start date here
      let startDate;
      try {
        const saved = localStorage.getItem('RELATIONSHIP_START');
        if (saved) {
          startDate = new Date(saved);
        } else {
          // Data padr√£o se n√£o existir
          const defaultDate = '2023-09-23';
          startDate = new Date(defaultDate);
          localStorage.setItem('RELATIONSHIP_START', defaultDate);
        }
      } catch (e) {
        startDate = new Date('2023-09-23');
      }

      function updateCounter() {
        const now = new Date();
        const diff = now - startDate;

        const totalDays = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        const years = Math.floor(totalDays / 365);
        const daysAfterYears = totalDays % 365;
        const months = Math.floor(daysAfterYears / 30);
        const days = daysAfterYears % 30;

        display.innerHTML = `
          <div class="counter-unit">
            <div class="counter-value">${years}</div>
            <div class="counter-label">Anos</div>
          </div>
          <div class="counter-unit">
            <div class="counter-value">${months}</div>
            <div class="counter-label">Meses</div>
          </div>
          <div class="counter-unit">
            <div class="counter-value">${days}</div>
            <div class="counter-label">Dias</div>
          </div>
          <div class="counter-unit">
            <div class="counter-value">${hours}</div>
            <div class="counter-label">Horas</div>
          </div>
          <div class="counter-unit">
            <div class="counter-value">${minutes}</div>
            <div class="counter-label">Minutos</div>
          </div>
          <div class="counter-unit">
            <div class="counter-value">${seconds}</div>
            <div class="counter-label">Segundos</div>
          </div>
        `;

        // Show milestones
        if (milestones) {
          milestones.innerHTML = '';
          const markers = [
            { days: 100, text: '100 dias! üéâ' },
            { days: 365, text: '1 ano! üéä' },
            { days: 500, text: '500 dias! üíù' },
            { days: 730, text: '2 anos! üéÜ' },
            { days: 1000, text: '1000 dias! üåü' }
          ];

          markers.forEach(marker => {
            if (totalDays >= marker.days) {
              const span = document.createElement('span');
              span.className = 'milestone';
              span.textContent = marker.text;
              milestones.appendChild(span);
            }
          });
        }
      }

      updateCounter();
      setInterval(updateCounter, 1000);
    }

    /* ===== DATE IDEAS GENERATOR ===== */
    function initDateIdeas() {
      const generateBtn = document.getElementById('generateIdeaBtn');
      const ideaText = document.getElementById('ideaText');
      const ideaCategory = document.getElementById('ideaCategory');

      if (!generateBtn || !ideaText) return;

      const ideas = [
        { text: 'Fazer um piquenique ao ar livre com comidas favoritas üß∫', category: 'Romance' },
        { text: 'Assistir ao p√¥r do sol juntos üåÖ', category: 'Romance' },
        { text: 'Cozinhar uma receita nova juntos üë®‚Äçüç≥', category: 'Aventura' },
        { text: 'Maratona de filmes com pipoca e cobertores üçø', category: 'Relaxar' },
        { text: 'Fazer uma caminhada ou trilha ü•æ', category: 'Aventura' },
        { text: 'Visitar um museu ou exposi√ß√£o de arte üñºÔ∏è', category: 'Cultural' },
        { text: 'Ter uma noite de jogos de tabuleiro üé≤', category: 'Divers√£o' },
        { text: 'Fazer um spa day caseiro üíÜ', category: 'Relaxar' },
        { text: 'Aula de dan√ßa em casa üíÉ', category: 'Divers√£o' },
        { text: 'Observar as estrelas √† noite ‚ú®', category: 'Romance' },
        { text: 'Fazer compras juntos e escolher roupas um para o outro üëó', category: 'Divers√£o' },
        { text: 'Visitar um caf√© novo na cidade ‚òï', category: 'Cultural' },
        { text: 'Tirar fotos juntos em lugares bonitos üì∏', category: 'Aventura' },
        { text: 'Escrever cartas de amor um para o outro üíå', category: 'Romance' },
        { text: 'Fazer um √°lbum de fotos ou scrapbook juntos üìî', category: 'Criativo' },
        { text: 'Experimentar um novo hobby juntos, como pintura ou jardinagem üé®', category: 'Criativo' },
        { text: 'Planejar uma viagem futura e pesquisar destinos juntos üåç', category: 'Aventura' },
        { text: 'Fazer uma degusta√ß√£o de vinhos ou queijos em casa üç∑', category: 'Relaxar' },
        { text: 'Ir a um parque de divers√µes ou feira local üé°', category: 'Divers√£o' },
        { text: 'Fazer uma sess√£o de medita√ß√£o ou yoga juntos üßò', category: 'Relaxar' },
        { text: 'Visitar um mercado de pulgas ou feira de artesanato üõçÔ∏è', category: 'Cultural' },
        { text: 'Fazer um desafio culin√°rio onde cada um prepara um prato surpresa üçΩÔ∏è', category: 'Aventura' },
        { text: 'Criar uma playlist de m√∫sicas que representam o relacionamento de voc√™s üé∂', category: 'Criativo' },
        { text: 'Fazer um tour gastron√¥mico pela cidade, experimentando comidas de diferentes culturas üçú', category: 'Cultural' },
        { text: 'Participar de uma aula online juntos, como fotografia ou escrita criativa üìö', category: 'Criativo' },
        { text: 'Fazer um dia de voluntariado juntos em uma causa que ambos apoiam ü§ù', category: 'Cultural' },
        { text: 'Construir algo juntos, como um m√≥vel ou uma pe√ßa de decora√ß√£o üõ†Ô∏è', category: 'Criativo' },
        { text: 'Fazer uma noite tem√°tica em casa, como uma noite italiana ou mexicana üåÆ', category: 'Divers√£o' },
        { text: 'Ir a um planet√°rio ou observat√≥rio para aprender sobre o universo üåå', category: 'Cultural' },
        { text: 'Fazer um passeio de bicicleta por um parque ou trilha local üö¥', category: 'Aventura' },
        { text: 'Ter uma noite de karaok√™ em casa üé§', category: 'Divers√£o' },
        { text: 'Fazer um di√°rio de gratid√£o juntos, escrevendo coisas pelas quais s√£o gratos no relacionamento üìñ', category: 'Romance'},
        { text: 'Experimentar uma nova atividade ao ar livre, como caiaque ou escalada üßó', category: 'Aventura'},
        { text: 'Fazer uma noite de fondue em casa ü´ï', category: 'Romance' }
      ];

      generateBtn.addEventListener('click', () => {
        const randomIdea = ideas[Math.floor(Math.random() * ideas.length)];

        // Animate transition
        ideaText.style.opacity = '0';
        ideaCategory.style.opacity = '0';

        setTimeout(() => {
          ideaText.textContent = randomIdea.text;
          ideaCategory.textContent = randomIdea.category;
          ideaText.style.opacity = '1';
          ideaCategory.style.opacity = '1';
        }, 200);
      });
    }

    /* ===== ENHANCE ALBUM WITH LIGHTBOX ===== */
    function enhanceAlbumImages() {
      // This function will be called periodically to enhance newly added album images
      const albumGrid = document.getElementById('albumGrid');
      if (!albumGrid) return;

      // Use MutationObserver to watch for new images added to the album
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === 1 && node.querySelector) {
              const imgs = node.querySelectorAll('img');
              imgs.forEach(img => {
                if (!img.dataset.lightboxBound) {
                  img.dataset.lightboxBound = 'true';
                  img.style.cursor = 'pointer';

                  img.addEventListener('click', () => {
                    // Collect all album images
                    const allAlbumImgs = Array.from(albumGrid.querySelectorAll('img'));
                    const imagesList = allAlbumImgs.map(i => ({
                      src: i.src,
                      alt: i.alt || 'Foto do √°lbum'
                    }));

                    openModal(img.src, img.alt || 'Foto do √°lbum', imagesList);
                  });
                }
              });
            }
          });
        });
      });

      observer.observe(albumGrid, { childList: true, subtree: true });

      // Also enhance existing images
      const existingImgs = albumGrid.querySelectorAll('img');
      existingImgs.forEach(img => {
        if (!img.dataset.lightboxBound) {
          img.dataset.lightboxBound = 'true';
          img.style.cursor = 'pointer';

          img.addEventListener('click', () => {
            const allAlbumImgs = Array.from(albumGrid.querySelectorAll('img'));
            const imagesList = allAlbumImgs.map(i => ({
              src: i.src,
              alt: i.alt || 'Foto do √°lbum'
            }));

            openModal(img.src, img.alt || 'Foto do √°lbum', imagesList);
          });
        }
      });
    }

    /* INIT */
    window.addEventListener('load', () => {
      setTimeout(() => document.body.classList.add('loaded'), 180);

      // decoration select
      const savedDec = (function () { try { return localStorage.getItem('decoration') || 'hearts' } catch (e) { return 'hearts' } })();
      const decSelect = document.getElementById('decorationSelect');
      if (decSelect) decSelect.value = savedDec;
      applyDecoration(savedDec);

      // spotify
      const sp = (function () { try { return localStorage.getItem('SPOTIFY_URL') } catch (e) { return null } })();
      if (sp) { const sIn = document.getElementById('spotifyInput'); if (sIn) sIn.value = sp; injectSpotifyIframe(sp, false); }
      else { const sIn = document.getElementById('spotifyInput'); if (sIn) sIn.value = DEFAULT_SPOTIFY_URL; try { localStorage.setItem('SPOTIFY_URL', DEFAULT_SPOTIFY_URL) } catch (e) { }; injectSpotifyIframe(DEFAULT_SPOTIFY_URL, false); }

      // backgrounds
      const day = (function () { try { return localStorage.getItem('DAY_BG') } catch (e) { return null } })();
      const night = (function () { try { return localStorage.getItem('NIGHT_BG') } catch (e) { return null } })();
      if (day) { const di = document.getElementById('dayBgInput'); if (di) di.value = day; }
      if (night) { const ni = document.getElementById('nightBgInput'); if (ni) ni.value = night; }

      try { if (localStorage.getItem && localStorage.getItem('CONTROL_PANEL_COLLAPSED') === '1') document.getElementById('controlPanel').classList.add('collapsed'); } catch (e) { }

      addCursorHoverListeners();
      bindInteractiveEffects();
      bindTabs();
      initQuiz();
      populateStickers();
      initTicTacToe();

      // Initialize new features
      initTimeline();
      initMessages();
      initCounter();
      initDateIdeas();
      initLazyLoading(); // Initialize lazy loading for images
      enhanceAlbumImages(); // Set up album images with lightbox

      loadAchievements(); // render persisted achievements

      // Close modals when clicking outside
      const messageModal = document.getElementById('messageModal');
      const timelineModal = document.getElementById('timelineModal');
      
      if (messageModal) {
        messageModal.addEventListener('click', (e) => {
          if (e.target === messageModal) {
            messageModal.classList.remove('open');
          }
        });
      }
      
      if (timelineModal) {
        timelineModal.addEventListener('click', (e) => {
          if (e.target === timelineModal) {
            timelineModal.classList.remove('open');
          }
        });
      }
    });

    /* Cursor */
    const cursor = document.getElementById('cursor');
    let targetX = window.innerWidth / 2, targetY = window.innerHeight / 2;
    let currentX = targetX, currentY = targetY, cursorTicking = false;
    let lastPointerTime = 0;
    document.addEventListener('pointermove', (e) => {
      targetX = e.clientX; targetY = e.clientY;
      lastPointerTime = performance.now();
      if (!cursorTicking) { cursorTicking = true; requestAnimationFrame(cursorFrame); }
    }, { passive: true });
    function cursorFrame() {
      const lerp = prefersReduced ? 1 : 0.22;
      currentX += (targetX - currentX) * lerp;
      currentY += (targetY - currentY) * lerp;
      if (cursor) { cursor.style.left = currentX + 'px'; cursor.style.top = currentY + 'px'; }
      if (Math.abs(targetX - currentX) < 0.5 && Math.abs(targetY - currentY) < 0.5) cursorTicking = false;
      else requestAnimationFrame(cursorFrame);
    }
    function addCursorHoverListeners() {
      document.querySelectorAll('button, a, .card, .tile, input, select, .photo img').forEach(el => {
        el.addEventListener('pointerenter', () => cursor && cursor.classList.add('big'));
        el.addEventListener('pointerleave', () => cursor && cursor.classList.remove('big'));
      });
    }

    /* Decorations (throttled & capped) */
    const DECOR_CAP = 60;
    const BURST_THROTTLE_MS = 160;
    let lastBurst = 0;
    function countDecorNodes() { return document.querySelectorAll('.heart, .confetti').length; }

    function safeClickBurst(x, y, kind = 'hearts') {
      if (prefersReduced) return;
      const now = performance.now();
      if (now - lastBurst < BURST_THROTTLE_MS) return;
      lastBurst = now;
      if (countDecorNodes() >= DECOR_CAP) return;
      const maxPerClick = getOptimizedParticleCount(); // Use optimized count
      const n = Math.min(maxPerClick, Math.floor(3 + Math.random() * 3));
      for (let i = 0; i < n; i++) {
        try {
          if (kind === 'confetti') {
            const c = document.createElement('div'); c.className = 'confetti';
            const w = Math.floor(Math.random() * 8) + 6;
            c.style.width = w + 'px'; c.style.height = (w * (Math.random() * 0.6 + 0.6)) + 'px';
            c.style.left = (x + (Math.random() * 40 - 20)) + 'px'; c.style.top = (y + (Math.random() * 24 - 12)) + 'px';
            c.style.background = `hsl(${Math.floor(Math.random() * 360)} 90% 65%)`; c.style.position = 'fixed'; c.style.zIndex = 10000;
            c.style.setProperty('--cx', (Math.random() * 120 - 60) + 'px');
            document.body.appendChild(c);
            setTimeout(() => c.remove(), 1600);
          } else {
            const h = document.createElement('div'); h.className = 'heart';
            const size = Math.floor(Math.random() * 10) + 10;
            h.style.setProperty('--size', size + 'px');
            h.style.setProperty('--duration', (0.9 + Math.random() * 1.6) + 's');
            h.style.setProperty('--opacity', (0.6 + Math.random() * 0.35));
            h.style.setProperty('--windX', (Math.random() * 160 - 80) + 'px');
            h.style.setProperty('--color', `hsl(${320 + Math.floor(Math.random() * 40)} 85% 65%)`);
            h.style.left = (x + (Math.random() * 40 - 20)) + 'px'; h.style.top = (y + (Math.random() * 24 - 12)) + 'px';
            h.style.position = 'fixed'; h.style.zIndex = 10000;
            document.body.appendChild(h);
            setTimeout(() => h.remove(), 2000);
          }
        } catch (ex) { console.error('safeClickBurst error', ex); }
      }
    }

    let decInterval = null;
    function createHeartBackground() {
      if (prefersReduced) return;
      if (countDecorNodes() >= DECOR_CAP) return;
      const h = document.createElement('div'); h.className = 'heart';
      const size = Math.floor(Math.random() * 18) + 12; const left = Math.random() * 100; const duration = (Math.random() * 4) + 5;
      const opacity = 0.6 + Math.random() * 0.35; const wind = (Math.random() * 160 - 80) + 'px'; const hue = 320 + Math.floor(Math.random() * 40);
      h.style.setProperty('--size', size + 'px'); h.style.setProperty('--duration', duration + 's'); h.style.setProperty('--opacity', opacity);
      h.style.setProperty('--windX', wind); h.style.setProperty('--color', `hsl(${hue} 85% 65%)`); h.style.left = left + 'vw'; h.style.setProperty('--delay', (Math.random() * 0.45) + 's');
      // place at bottom
      h.style.bottom = '-20px'; h.style.top = 'auto';
      document.body.appendChild(h);
      setTimeout(() => { try { h.remove(); } catch (e) { } }, (duration * 1000) + 8000);
    }

    function createConfettiBurst() {
      if (prefersReduced) return;
      const burst = Math.floor(6 + Math.random() * 10);
      for (let i = 0; i < burst; i++) {
        if (countDecorNodes() >= DECOR_CAP) break;
        const c = document.createElement('div'); c.className = 'confetti';
        const w = Math.floor(Math.random() * 8) + 6;
        c.style.width = w + 'px'; c.style.height = (w * (Math.random() * 0.6 + 0.6)) + 'px'; c.style.position = 'fixed';
        c.style.left = (Math.random() * 100) + 'vw'; c.style.top = (window.innerHeight - 40) + 'px';
        c.style.background = `hsl(${Math.floor(Math.random() * 360)} 90% 65%)`; c.style.zIndex = 9998; document.body.appendChild(c);
        c.style.setProperty('--cx', (Math.random() * 200 - 100) + 'px');
        setTimeout(() => c.remove(), 1600);
      }
    }

    function applyDecoration(name) {
      clearInterval(decInterval);
      document.querySelectorAll('.heart, .confetti').forEach(n => n.remove());
      if (name === 'hearts') decInterval = setInterval(() => createHeartBackground(), 900);
      else if (name === 'confetti') decInterval = setInterval(() => createConfettiBurst(), 1400);
      else decInterval = null;
      try { localStorage.setItem('decoration', name); } catch (e) { }
    }

    /* Ripple */
    function createRipple(ev, el) {
      try {
        const rect = el.getBoundingClientRect();
        const r = document.createElement('span'); r.className = 'ripple';
        const size = Math.max(rect.width, rect.height) * 1.4;
        r.style.width = r.style.height = size + 'px';
        r.style.left = (ev.clientX - rect.left - size / 2) + 'px'; r.style.top = (ev.clientY - rect.top - size / 2) + 'px';
        r.style.opacity = '0.9'; el.appendChild(r);
        requestAnimationFrame(() => { r.style.transform = 'scale(1)'; r.style.opacity = '0'; r.style.transition = 'transform .6s cubic-bezier(.2,.9,.3,1), opacity .6s'; });
        setTimeout(() => r.remove(), 700);
      } catch (e) { }
    }

    function bindInteractiveEffects() {
      document.querySelectorAll('button, .card, .tile, .photo img').forEach(el => {
        el.removeEventListener('pointerdown', interactivePointerDown);
        el.addEventListener('pointerdown', interactivePointerDown, { passive: true });
      });
    }
    function interactivePointerDown(ev) {
      if (ev.button !== 0) return;
      const el = ev.currentTarget;
      try { createRipple(ev, el); } catch (e) { }
      const dec = (function () { try { return localStorage.getItem('decoration') || 'hearts' } catch (e) { return 'hearts' } })();
      safeClickBurst(ev.clientX, ev.clientY, dec === 'confetti' ? 'confetti' : 'hearts');
    }

    /* Spotify */
    const spotifyInput = document.getElementById('spotifyInput');
    const loadPlaylistBtn = document.getElementById('loadPlaylistBtn');
    const spotifyBox = document.getElementById('spotifyBox');

    function normalizeSpotifyUrl(raw) {
      if (!raw) return '';
      try {
        raw = raw.trim();
        if (raw.includes('open.spotify.com')) {
          const u = new URL(raw.startsWith('http') ? raw : 'https://' + raw);
          const parts = u.pathname.split('/');
          const idx = parts.indexOf('playlist');
          if (idx >= 0 && parts[idx + 1]) return 'https://open.spotify.com/embed/playlist/' + parts[idx + 1] + '?utm_source=generator';
        }
        if (/^[0-9A-Za-z]{20,}$/.test(raw)) return 'https://open.spotify.com/embed/playlist/' + raw + '?utm_source=generator';
      } catch (e) { }
      return '';
    }

    function injectSpotifyIframe(raw, focus = true) {
      const url = normalizeSpotifyUrl(raw);
      if (!spotifyBox) return;
      spotifyBox.innerHTML = '';
      if (!url) { spotifyBox.innerHTML = '<div id="spotifyPlaceholder" style="padding:18px;text-align:center;color:#ffeeff">URL inv√°lida. Cole um link de playlist do Spotify.</div>'; return; }
      const ifr = document.createElement('iframe');
      ifr.className = 'spotify-frame';
      ifr.title = 'Playlist do Spotify';
      ifr.loading = 'lazy';
      ifr.allow = 'autoplay; clipboard-write; encrypted-media; fullscreen';
      ifr.src = url;
      spotifyBox.appendChild(ifr);
      if (focus) try { ifr.focus && ifr.focus(); } catch (e) { }
      try { localStorage.setItem('SPOTIFY_URL', raw); } catch (e) { }
    }

    loadPlaylistBtn && loadPlaylistBtn.addEventListener('click', (ev) => {
      const raw = (spotifyInput && spotifyInput.value || '').trim();
      injectSpotifyIframe(raw, true);
      createRipple(ev, loadPlaylistBtn);
    });

    const playBtn = document.getElementById('playBtn');
    playBtn && playBtn.addEventListener('click', () => {
      const iframe = spotifyBox && spotifyBox.querySelector('iframe');
      if (iframe) { iframe.focus && iframe.focus(); playBtn.textContent = '‚ñ∂Ô∏è Tocando (se suportado)'; setTimeout(() => playBtn.textContent = '‚ñ∂Ô∏è Tocar Playlist', 1100); }
      else injectSpotifyIframe(spotifyInput && spotifyInput.value, true);
      addAchievement('Primeiro Play');
    });

    /* Backgrounds & dark mode */
    const darkBtn = document.getElementById('darkModeBtn');
    let dark = false;
    let DAY_BG = (function () { try { return localStorage.getItem('DAY_BG') || 'https://i.imgur.com/0JMLcYr.jpeg' } catch (e) { return 'https://i.imgur.com/0JMLcYr.jpeg' } })();
    let NIGHT_BG = (function () { try { return localStorage.getItem('NIGHT_BG') || 'https://i.imgur.com/rJePXtj.jpeg' } catch (e) { return 'https://i.imgur.com/rJePXtj.jpeg' } })();
    const dayInput = document.getElementById('dayBgInput'), nightInput = document.getElementById('nightBgInput');
    const bgVideo = document.getElementById('bgVideo'), bgYouTube = document.getElementById('bgYouTube');

    if (localStorage.getItem && localStorage.getItem('darkMode') === '1') { dark = true; document.body.classList.add('dark'); darkBtn && (darkBtn.textContent = '‚òÄÔ∏è Modo Claro'); }
    if (dayInput) dayInput.value = DAY_BG; if (nightInput) nightInput.value = NIGHT_BG;

    function setBackground(url, opts = { forceImage: false }) {
      if (!url) return;
      const yt = parseYouTubeUrl(url);
      if (yt && !opts.forceImage) {
        if (yt.type === 'video') {
          const vid = yt.id;
          const embed = `https://www.youtube.com/embed/${vid}?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&loop=1&playlist=${vid}&enablejsapi=1`;
          bgYouTube && (bgYouTube.src = embed); bgYouTube && (bgYouTube.style.opacity = '1'); adjustYouTubeSizing();
          if (bgVideo) { bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity = '0'; }
          document.body.style.backgroundImage = '';
          return;
        } else if (yt.type === 'playlist') {
          const listId = yt.id;
          const embed = `https://www.youtube.com/embed?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&loop=1&enablejsapi=1&listType=playlist&list=${listId}`;
          bgYouTube && (bgYouTube.src = embed); bgYouTube && (bgYouTube.style.opacity = '1'); adjustYouTubeSizing();
          if (bgVideo) { bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity = '0'; }
          document.body.style.backgroundImage = '';
          return;
        }
      }
      if (isVideoUrl(url) && !opts.forceImage) {
        bgYouTube && bgYouTube.removeAttribute('src'); bgYouTube && (bgYouTube.style.opacity = '0');
        try { if (bgVideo) { bgVideo.src = url; bgVideo.load(); bgVideo.play().catch(() => { }); } } catch (e) { }
        bgVideo && (bgVideo.style.opacity = '1');
        document.body.style.backgroundImage = '';
        return;
      }
      bgYouTube && bgYouTube.removeAttribute('src'); bgYouTube && (bgYouTube.style.opacity = '0');
      if (bgVideo) { bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.opacity = '0'; }
      document.body.style.backgroundImage = `url('${url}')`;
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
    }

    function applyCurrentBg() { if (dark && NIGHT_BG) setBackground(NIGHT_BG); else if (!dark && DAY_BG) setBackground(DAY_BG); }
    applyCurrentBg();

    darkBtn && darkBtn.addEventListener('click', () => {
      dark = !dark;
      document.body.classList.toggle('dark', dark);
      darkBtn.textContent = dark ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Noturno';
      try { localStorage.setItem('darkMode', dark ? '1' : '0'); } catch (e) { }
      applyCurrentBg();
    });

    function safeUrl(s) { try { const u = new URL(s, location.href); return u.href; } catch (e) { return (s || '').trim(); } }
    dayInput && dayInput.addEventListener('change', () => { const v = safeUrl(dayInput.value); if (v) { DAY_BG = v; try { localStorage.setItem('DAY_BG', DAY_BG) } catch (e) { }; if (!dark) setBackground(DAY_BG); } });
    nightInput && nightInput.addEventListener('change', () => { const v = safeUrl(nightInput.value); if (v) { NIGHT_BG = v; try { localStorage.setItem('NIGHT_BG', NIGHT_BG) } catch (e) { }; if (dark) setBackground(NIGHT_BG); } });

    function adjustYouTubeSizing() {
      if (!bgYouTube) return;
      const vw = window.innerWidth, vh = window.innerHeight, aspect = 16 / 9;
      if (vw / vh < aspect) { bgYouTube.style.height = `${vh}px`; bgYouTube.style.width = `${vh * aspect}px`; }
      else { bgYouTube.style.width = `${vw}px`; bgYouTube.style.height = `${vw / aspect}px`; }
    }
    window.addEventListener('resize', adjustYouTubeSizing);

    /* Reset */
    document.getElementById('resetBtn') && document.getElementById('resetBtn').addEventListener('click', (ev) => {
      try { localStorage.removeItem('DAY_BG'); localStorage.removeItem('NIGHT_BG'); localStorage.removeItem('SPOTIFY_URL'); localStorage.removeItem('decoration'); localStorage.removeItem('darkMode'); localStorage.removeItem('CONTROL_PANEL_COLLAPSED'); } catch (e) { }
      DAY_BG = 'https://i.imgur.com/0JMLcYr.jpeg'; NIGHT_BG = 'https://i.imgur.com/rJePXtj.jpeg';
      const sIn = document.getElementById('spotifyInput'); if (sIn) sIn.value = DEFAULT_SPOTIFY_URL; injectSpotifyIframe(DEFAULT_SPOTIFY_URL, false);
      const decEl = document.getElementById('decorationSelect'); if (decEl) decEl.value = 'hearts'; applyDecoration('hearts');
      const di = document.getElementById('dayBgInput'); const ni = document.getElementById('nightBgInput'); if (di) di.value = DAY_BG; if (ni) ni.value = NIGHT_BG;
      document.body.classList.remove('dark'); dark = false; darkBtn && (darkBtn.textContent = 'üåô Modo Noturno');
      applyCurrentBg();
      safeClickBurst(window.innerWidth / 2, window.innerHeight / 2, 'confetti');
      createRipple(ev, document.getElementById('resetBtn'));
    });

    /* Mini-game: memory */
    const openGameBtn = document.getElementById('openGameBtn');
    const gamePanel = document.getElementById('gamePanel');
    const gameBoard = document.getElementById('gameBoard');
    const restartGame = document.getElementById('restartGame');
    const gameInfo = document.getElementById('gameInfo');
    let tiles = [], firstPick = null, secondPick = null, lockBoard = false, matches = 0, attempts = 0;
    const symbols = ['üíñ', 'üåπ', 'üåü', 'üç´', 'üéµ', 'üéÅ', 'üçì', 'üïäÔ∏è'];

    function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } return array; }
    function initGame() {
      tiles = []; firstPick = secondPick = null; lockBoard = false; matches = 0; attempts = 0;
      if (gameInfo) gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`;
      const needed = 8; const pool = symbols.slice(0, needed); const doubled = pool.concat(pool); const shuffled = shuffle(doubled);
      if (!gameBoard) return;
      gameBoard.innerHTML = '';
      shuffled.forEach((s, idx) => {
        const t = document.createElement('div'); t.className = 'tile'; t.tabIndex = 0;
        t.setAttribute('data-symbol', s); t.setAttribute('role', 'button'); t.setAttribute('aria-label', 'Carta do jogo');
        t.textContent = ''; t.addEventListener('click', onTileClick);
        t.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onTileClick({ currentTarget: t }); } });
        gameBoard.appendChild(t);
      });
      addCursorHoverListeners();
      bindInteractiveEffects();
    }

    function onTileClick(e) {
      if (lockBoard) return;
      const t = e.currentTarget;
      if (!t || t.classList.contains('flipped') || t.classList.contains('matched')) return;
      t.classList.add('flipped'); t.textContent = t.getAttribute('data-symbol');
      if (!firstPick) { firstPick = t; return; }
      secondPick = t; lockBoard = true; attempts++;
      if (firstPick.getAttribute('data-symbol') === secondPick.getAttribute('data-symbol')) {
        firstPick.classList.add('matched'); secondPick.classList.add('matched'); matches++;
        setTimeout(() => {
          resetPicks(); lockBoard = false; if (gameInfo) gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`;
          if (matches === 8) { setTimeout(() => safeClickBurst(window.innerWidth / 2, window.innerHeight / 2, 'confetti'), 300); addAchievement('Mem√≥ria completa'); }
        }, 300);
      } else {
        setTimeout(() => {
          if (firstPick) { firstPick.classList.remove('flipped'); firstPick.textContent = ''; }
          if (secondPick) { secondPick.classList.remove('flipped'); secondPick.textContent = ''; }
          resetPicks(); lockBoard = false; if (gameInfo) gameInfo.textContent = `Acertos: ${matches} | Tentativas: ${attempts}`;
        }, 700);
      }
    }
    function resetPicks() { firstPick = null; secondPick = null; }

    if (openGameBtn) {
      openGameBtn.addEventListener('click', (ev) => {
        const visible = gamePanel && gamePanel.style.display !== 'none';
        if (gamePanel) gamePanel.style.display = visible ? 'none' : 'block';
        if (gamePanel) gamePanel.setAttribute('aria-hidden', visible ? 'true' : 'false');
        if (!visible) initGame();
        createRipple(ev, openGameBtn);
      });
    }
    restartGame && restartGame.addEventListener('click', (ev) => { initGame(); createRipple(ev, restartGame); });

    /* Tabs */
    function bindTabs() {
      const tabs = document.getElementById('tabs');
      if (!tabs) return;
      tabs.addEventListener('click', (ev) => {
        const t = ev.target.closest('.tab');
        if (!t) return;
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.querySelectorAll('.panel').forEach(p => p.hidden = true);
        const panelId = t.getAttribute('data-panel');
        const panel = document.getElementById(panelId);
        if (panel) panel.hidden = false;
        if (panelId === 'panel-games') initGame();
      });
    }

    /* Panel toggle (floating handle + storage) */
    (function bindPanelToggle() {
      try {
        const panelToggle = document.getElementById('panelToggleHandle');
        if (!panelToggle) return;
        panelToggle.addEventListener('click', () => {
          const cp = document.getElementById('controlPanel');
          if (!cp) return;
          const collapsed = cp.classList.toggle('collapsed');
          try { localStorage.setItem('CONTROL_PANEL_COLLAPSED', collapsed ? '1' : '0'); } catch (e) { }
          panelToggle.focus();
        });
      } catch (e) { console.error('panelToggle bind error', e); }
    })();

    document.getElementById('decorationSelect') && document.getElementById('decorationSelect').addEventListener('change', (e) => applyDecoration(e.target.value));

    /* Modal photo click */
    document.getElementById('mainPhoto') && document.getElementById('mainPhoto').addEventListener('click', (ev) => { openModal(ev.currentTarget.src, ev.currentTarget.alt); createRipple(ev, ev.currentTarget); });

    /* --- Quiz: show final result and award achievement --- */
    const quizData = [
      { q: 'Onde nos conhecemos?', a: ['Na escola', 'No trabalho', 'Por amigos', 'Online', 'Basquete'], correct: 4 },
      { q: 'Qual √© meu nome?', a: ['Matheus', 'Ice', 'AMOR DA MINHA VIDA, MEU DONO, MEU HOMEM', 'AMOR DA MINHA VIDA'], correct: 2 },
      { q: 'Melhor programa juntos?', a: ['Cinema', 'P√¥r do sol', 'Viagem', 'Jantar caseiro', 'ü§≠üòàüîû', 'TODOS'], correct: 5 },
      { q: 'Meu carinho favorito?', a: ['Nas costas', 'Pezinhos No rosto', 'Cafun√©', 'Na barriga', 'No pesco√ßo'], correct: 1 },
      { q: 'Qual minha forma favorita de pontuar?', a: ['Bandeja', 'Uma dunk', 'Uma sexta de 3 pontos', 'Uma jogada 1 contra 1'], correct: 3 },

      // üëá nessas duas √∫ltimas, todas as respostas est√£o corretas:
      { q: 'Quem faz mais carinho?', a: ['Matheus', 'Ice', 'Voc√™ meu amor', 'Claro que n√£o √© eu'], correct: [0, 1, 2, 3] },
      { q: 'Quem Dorme mais?', a: ['Bruna', 'Bruninha', 'EU MEU AMOR DUUR', 'Claro que √© eu'], correct: [0, 1, 2, 3] },
      { q: 'Qual meu sabor de sorvete favorito entre esses?', a: ['Chocolate', 'Baunilha', 'Morango', 'Pistache'], correct: 0 },
    ];

    let quizIndex = 0, quizScore = 0;

    function initQuiz() {
      quizIndex = 0; quizScore = 0;
      renderQuiz();
      const scoreEl = document.getElementById('quizScore');
      if (scoreEl) scoreEl.textContent = `Pontua√ß√£o: ${quizScore}`;
      const resultEl = document.getElementById('quizResult');
      if (resultEl) resultEl.style.display = 'none';
    }

    function renderQuiz() {
      const qEl = document.getElementById('quizQuestion');
      const opts = document.getElementById('quizOptions');
      const nextBtn = document.getElementById('nextQ');
      const scoreEl = document.getElementById('quizScore');
      const resultEl = document.getElementById('quizResult');

      if (!qEl || !opts) return;
      const item = quizData[quizIndex];
      if (!item) return;

      qEl.textContent = item.q;
      opts.innerHTML = '';

      item.a.forEach((opt, i) => {
        const d = document.createElement('div');
        d.className = 'option';
        d.tabIndex = 0;
        d.textContent = opt;

        d.addEventListener('click', () => {
          if (d.dataset.answered) return;
          d.dataset.answered = '1';

          // ‚úÖ verifica se √© um √≠ndice ou um array de √≠ndices corretos
          const correctAnswers = Array.isArray(item.correct) ? item.correct : [item.correct];
          const isCorrect = correctAnswers.includes(i);

          if (isCorrect) {
            quizScore++;
            d.style.background = 'linear-gradient(90deg,#bff2d6,#c7ffe8)';
            addAchievement('Quiz acertou');
          } else {
            d.style.background = 'linear-gradient(90deg,#ffd6d6,#ffe6e6)';
          }

          Array.from(opts.children).forEach(c => c.style.pointerEvents = 'none');
          if (scoreEl) scoreEl.textContent = `Pontua√ß√£o: ${quizScore}`;

          if (quizIndex >= quizData.length - 1) {
            if (resultEl) {
              resultEl.style.display = 'inline-block';
              resultEl.textContent = `Quiz finalizado! Pontua√ß√£o: ${quizScore} / ${quizData.length}`;
            }
            addAchievement('Quiz conclu√≠do');
            if (nextBtn) nextBtn.style.display = 'none';
          } else {
            if (nextBtn) nextBtn.style.display = 'inline-flex';
          }
        });

        d.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); d.click(); }
        });

        opts.appendChild(d);
      });

      if (nextBtn) nextBtn.onclick = () => {
        quizIndex = Math.min(quizData.length - 1, quizIndex + 1);
        if (nextBtn) nextBtn.style.display = 'none';
        renderQuiz();
      };
    }
    /* --- Mood board: populate stickers, support click-to-add and drag/drop --- */
    function populateStickers() {
      const container = document.getElementById('moodStickers');
      if (!container) return;
      container.innerHTML = '';
      const urls = [
        'https://i.imgur.com/oK3x5BH.jpeg',
        'https://i.imgur.com/kUJiuhm.jpeg',
        'https://i.imgur.com/PPq9KND.jpeg',
        'https://i.imgur.com/OawRcMt.jpeg',
        'https://i.imgur.com/n4b9m73.jpeg'
      ];
      urls.forEach(u => {
        const s = document.createElement('div'); s.className = 'sticker';
        s.innerHTML = `<img src="${u}" loading="lazy" draggable="false"/>`;
        // click to clone onto board (better UX for touch)
        s.addEventListener('click', () => {
          addStickerToBoard(u, 40, 40);
        });
        // allow dragstart so desktop users can drag to board
        s.draggable = true;
        s.addEventListener('dragstart', (ev) => {
          try { ev.dataTransfer.setData('text/plain', u); } catch (e) { }
        });
        container.appendChild(s);
      });

      const upload = document.getElementById('uploadImage');
      upload && upload.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        const s = document.createElement('div'); s.className = 'sticker';
        s.innerHTML = `<img src="${url}" loading="lazy" draggable="false"/>`;
        s.addEventListener('click', () => { addStickerToBoard(url, 40, 40); });
        s.draggable = true;
        s.addEventListener('dragstart', (ev) => { try { ev.dataTransfer.setData('text/plain', url); } catch (e) { } });
        container.appendChild(s);
      });

      const board = document.getElementById('moodBoard');
      if (!board) return;
      board.addEventListener('dragover', (ev) => ev.preventDefault());
      board.addEventListener('drop', (ev) => {
        ev.preventDefault();
        const url = ev.dataTransfer.getData('text/plain');
        if (!url) return;
        const rect = board.getBoundingClientRect();
        const x = ev.clientX - rect.left - 48;
        const y = ev.clientY - rect.top - 48;
        addStickerToBoard(url, x, y);
      });
    }

    // add sticker to board at given relative x,y
    function addStickerToBoard(url, x, y) {
      const board = document.getElementById('moodBoard');
      if (!board) return;
      const node = document.createElement('div'); node.className = 'sticker';
      node.style.position = 'absolute';
      // clamp positions
      const br = board.getBoundingClientRect();
      const w = 96, h = 96;
      let nx = Math.max(0, Math.min(br.width - w, x));
      let ny = Math.max(0, Math.min(br.height - h, y));
      node.style.left = nx + 'px';
      node.style.top = ny + 'px';
      node.innerHTML = `<img src="${url}" loading="lazy" draggable="false"/>`;
      makeDraggable(node);
      board.appendChild(node);
    }

    function makeDraggable(node) {
      let offsetX = 0, offsetY = 0, dragging = false;
      node.addEventListener('pointerdown', (e) => {
        dragging = true; node.setPointerCapture(e.pointerId);
        offsetX = e.clientX - node.getBoundingClientRect().left; offsetY = e.clientY - node.getBoundingClientRect().top;
        node.style.cursor = 'grabbing';
      });
      node.addEventListener('pointermove', (e) => {
        if (!dragging) return;
        const board = document.getElementById('moodBoard').getBoundingClientRect();
        let x = e.clientX - board.left - offsetX; let y = e.clientY - board.top - offsetY;
        x = Math.max(0, Math.min(board.width - node.offsetWidth, x)); y = Math.max(0, Math.min(board.height - node.offsetHeight, y));
        node.style.left = x + 'px'; node.style.top = y + 'px';
      });
      node.addEventListener('pointerup', (e) => { dragging = false; try { node.releasePointerCapture(e.pointerId); } catch (e) { } node.style.cursor = 'grab'; });
      // also allow double-tap to remove
      node.addEventListener('dblclick', () => node.remove());
    }

    /* Tic-Tac-Toe (simple 2 player) */
    function initTicTacToe() {
      const startBtn = document.getElementById('startTicTac');
      const ttt = document.getElementById('ticTacToe');
      const board = document.getElementById('tttBoard');
      const resetBtn = document.getElementById('resetTtt');
      let cells = [], turn = 'X';
      startBtn && startBtn.addEventListener('click', () => {
        ttt.style.display = ttt.style.display === 'none' ? 'block' : 'none';
        if (ttt.style.display === 'block') {
          board.innerHTML = '';
          cells = [];
          for (let i = 0; i < 9; i++) {
            const c = document.createElement('div'); c.style.width = '70px'; c.style.height = '70px'; c.style.display = 'flex';
            c.style.alignItems = 'center'; c.style.justifyContent = 'center'; c.style.background = 'rgba(255,255,255,0.02)';
            c.style.fontSize = '28px'; c.style.borderRadius = '8px'; c.style.cursor = 'pointer';
            c.addEventListener('click', () => {
              if (c.textContent) return;
              c.textContent = turn; turn = turn === 'X' ? 'O' : 'X';
              checkTtt();
            });
            board.appendChild(c); cells.push(c);
          }
        }
      });
      resetBtn && resetBtn.addEventListener('click', () => { board.innerHTML = ''; ttt.style.display = 'none'; });
      function checkTtt() {
        const combos = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
        for (const combo of combos) {
          const [a, b, c] = combo;
          if (cells[a].textContent && cells[a].textContent === cells[b].textContent && cells[a].textContent === cells[c].textContent) {
            cells[a].style.background = cells[b].style.background = cells[c].style.background = 'linear-gradient(90deg,#ffd6d6,#fff0f0)';
            addAchievement('Vencedor do Jogo da Velha');
            return;
          }
        }
      }
    }

    /* safety: ensure decoration is applied on load */
    try { const saved = (function () { try { return localStorage.getItem('decoration') } catch (e) { return null } })(); if (saved) applyDecoration(saved); } catch (e) { }

  </script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-cloudinary-sync.js"></script>
  
  <!-- PWA Service Worker Registration -->
  <script>
    // Registrar service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registrado:', reg.scope))
          .catch(err => console.error('SW erro:', err));
      });
    }
  </script>
  
  <!-- Bot√£o de voltar ao topo -->
  <button id="scrollToTop" aria-label="Voltar ao topo">‚Üë</button>
  
  <script>
    // Bot√£o de voltar ao topo
    (function() {
      const scrollBtn = document.getElementById('scrollToTop');
      if (!scrollBtn) return;
      
      function toggleScrollButton() {
        if (window.scrollY > 300) {
          scrollBtn.classList.add('show');
        } else {
          scrollBtn.classList.remove('show');
        }
      }
      
      scrollBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        const mainContainer = document.getElementById('mainContainer');
        if (mainContainer) {
          mainContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
      
      window.addEventListener('scroll', toggleScrollButton);
      toggleScrollButton(); // Verificar estado inicial
    })();
    
    // Garantir que o mainContainer e wrap mantenham sua posi√ß√£o correta no topo
    (function() {
      const mainContainer = document.getElementById('mainContainer');
      const wrap = document.querySelector('.wrap');
      
      function forceTopPosition() {
        if (wrap) {
          wrap.style.marginTop = '0';
          wrap.style.paddingTop = '20px';
          wrap.style.top = '0';
          wrap.style.transform = 'none';
          wrap.style.minHeight = 'auto';
        }
        
        if (mainContainer) {
          mainContainer.style.transform = '';
          mainContainer.style.position = '';
          mainContainer.style.marginTop = '0';
        }
        
        // For√ßar scroll para o topo
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      }
      
      // Executar imediatamente
      forceTopPosition();
      
      // Executar ap√≥s DOM estar pronto
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceTopPosition);
      }
      
      // Executar ap√≥s load completo
      window.addEventListener('load', forceTopPosition);
      
      // Executar periodicamente para garantir (por 2 segundos ap√≥s load)
      let attempts = 0;
      const interval = setInterval(() => {
        forceTopPosition();
        attempts++;
        if (attempts > 20) { // 2 segundos
          clearInterval(interval);
        }
      }, 100);
    })();
    
    // Adicionar anima√ß√£o de entrada para elementos quando aparecem na tela
    (function() {
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
          }
        });
      }, observerOptions);
      
      // Observar elementos com classe 'animate-on-scroll'
      document.querySelectorAll('.panel, .card, .tile').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(el);
      });
    })();
  </script>
</body>

</html>
